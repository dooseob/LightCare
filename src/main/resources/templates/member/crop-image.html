<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head th:replace="~{layout/header :: header}">
    <title>í”„ë¡œí•„ ì´ë¯¸ì§€ í¬ë¡­ - CareLink</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
</head>
<body class="d-flex flex-column min-vh-100 pt-5">
<nav th:replace="~{layout/header :: navbar}"></nav>

<div th:replace="~{layout/header :: messages}"></div>

<main class="flex-grow-1">
    <div class="container mt-4">
        <!-- ë¸Œë ˆë“œí¬ëŸ¼ -->
        <nav aria-label="breadcrumb" class="mb-4">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">í™ˆ</a></li>
                <li class="breadcrumb-item"><a href="/member/myinfo">ë§ˆì´í˜ì´ì§€</a></li>
                <li class="breadcrumb-item active" aria-current="page">í”„ë¡œí•„ ì´ë¯¸ì§€ í¬ë¡­</li>
            </ol>
        </nav>
        
        <div class="row justify-content-center">
            <div class="col-12 col-lg-10">
                <div class="card shadow">
                    <div class="card-body p-4">
                        <div class="text-center mb-4">
                            <h3 class="card-title fw-bold text-primary">
                                <i class="fas fa-crop me-2"></i>
                                í”„ë¡œí•„ ì´ë¯¸ì§€ í¬ë¡­
                            </h3>
                            <p class="text-muted">ì¦ëª…ì‚¬ì§„ ë¹„ìœ¨(3:4)ì— ë§ì¶° í”„ë¡œí•„ ì‚¬ì§„ì„ ì¡°ì ˆí•˜ì„¸ìš”</p>
                        </div>

                        <!-- ë‹¨ê³„ í‘œì‹œê¸° -->
                        <div class="steps-indicator mb-4">
                            <div class="step-item" id="step1">
                                <div class="step-circle">
                                    <i class="fas fa-upload"></i>
                                </div>
                                <div class="step-label">ì´ë¯¸ì§€ ì„ íƒ</div>
                            </div>
                            <div class="step-connector"></div>
                            <div class="step-item" id="step2">
                                <div class="step-circle">
                                    <i class="fas fa-crop-alt"></i>
                                </div>
                                <div class="step-label">ë¹„ìœ¨ ì¡°ì ˆ</div>
                            </div>
                            <div class="step-connector"></div>
                            <div class="step-item" id="step3">
                                <div class="step-circle">
                                    <i class="fas fa-compress-alt"></i>
                                </div>
                                <div class="step-label">ì••ì¶• & SEO</div>
                            </div>
                            <div class="step-connector"></div>
                            <div class="step-item" id="step4">
                                <div class="step-circle">
                                    <i class="fas fa-check"></i>
                                </div>
                                <div class="step-label">ì™„ë£Œ</div>
                            </div>
                        </div>

                        <!-- 1ë‹¨ê³„: íŒŒì¼ ì—…ë¡œë“œ -->
                        <div id="uploadSection" class="upload-section">
                            <div class="upload-area" id="uploadArea">
                                <div class="upload-content">
                                    <div class="upload-icon">
                                        <i class="fas fa-cloud-upload-alt fa-3x text-primary"></i>
                                    </div>
                                    <h5 class="upload-title">í”„ë¡œí•„ ì´ë¯¸ì§€ ì—…ë¡œë“œ</h5>
                                    <p class="upload-description text-muted">
                                        ì´ë¯¸ì§€ë¥¼ ë“œë˜ê·¸í•˜ì—¬ ì—…ë¡œë“œí•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì„ íƒí•˜ì„¸ìš”
                                    </p>
                                    <div class="upload-format-info">
                                        <small class="text-muted">
                                            <i class="fas fa-info-circle me-1"></i>
                                            JPG, PNG, WebP íŒŒì¼ ì§€ì› (í° íŒŒì¼ë„ ìë™ ì••ì¶•)
                                        </small>
                                        <br>
                                        <small class="text-info">
                                            <i class="fas fa-crop-alt me-1"></i>
                                            ì¦ëª…ì‚¬ì§„ ë¹„ìœ¨ (3:4) ìë™ ì¡°ì •
                                        </small>
                                        <br>
                                        <small class="text-success">
                                            <i class="fas fa-compress-alt me-1"></i>
                                            AVIF/WebPë¡œ ìš©ëŸ‰ ìµœì í™”
                                        </small>
                                    </div>
                                    <button type="button" class="btn btn-primary btn-lg mt-3" id="fileSelectBtn">
                                        <i class="fas fa-folder-open me-2"></i>íŒŒì¼ ì„ íƒ
                                    </button>
                                </div>
                            </div>
                            <input type="file" id="imageInput" accept="image/*" style="display: none;">
                        </div>

                        <!-- 2ë‹¨ê³„: í¬ë¡­ ë° ì¡°ì • -->
                        <div id="cropSection" class="crop-section" style="display: none;">
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="crop-container">
                                        <h6 class="mb-3">
                                            <i class="fas fa-crop-alt me-2"></i>ì´ë¯¸ì§€ í¬ë¡­ ë° ì¡°ì •
                                        </h6>
                                        <div class="crop-image-container">
                                            <img id="cropImage" alt="í¬ë¡­í•  ì´ë¯¸ì§€" style="max-width: 100%; max-height: 400px;">
                                        </div>
                                        <div class="crop-controls mt-3">
                                            <div class="btn-group" role="group">
                                                <button type="button" class="btn btn-outline-secondary btn-sm" id="zoomIn">
                                                    <i class="fas fa-search-plus me-1"></i>í™•ëŒ€
                                                </button>
                                                <button type="button" class="btn btn-outline-secondary btn-sm" id="zoomOut">
                                                    <i class="fas fa-search-minus me-1"></i>ì¶•ì†Œ
                                                </button>
                                                <button type="button" class="btn btn-outline-secondary btn-sm" id="resetZoom">
                                                    <i class="fas fa-undo me-1"></i>ì´ˆê¸°í™”
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="crop-preview-panel">
                                        <h6 class="mb-3">
                                            <i class="fas fa-eye me-2"></i>ë¯¸ë¦¬ë³´ê¸°
                                        </h6>
                                        
                                        <div class="profile-preview mb-3">
                                            <div class="profile-card text-center p-3 bg-light rounded">
                                                <canvas id="previewCanvas" width="90" height="120" 
                                                        style="border-radius: 8px; border: 2px solid #dee2e6;"></canvas>
                                                <div class="mt-2">
                                                    <small class="text-muted">í”„ë¡œí•„ ë¯¸ë¦¬ë³´ê¸°</small>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- ì¤Œ í‘œì‹œê¸° -->
                                        <div class="zoom-indicator" id="zoomIndicator" style="display: none;">
                                            <small class="text-muted">
                                                <i class="fas fa-search me-1"></i>
                                                ì¤Œ: <span id="zoomLevel">100%</span>
                                                <span id="zoomStatus" class="ms-1"></span>
                                            </small>
                                        </div>

                                        <!-- ì´ë¯¸ì§€ ì •ë³´ -->
                                        <div class="image-info-panel mt-3">
                                            <small class="text-muted">
                                                <div class="mb-1">
                                                    <i class="fas fa-file-image me-1"></i>
                                                    í¬ê¸°: <span id="imageSize">-</span>
                                                </div>
                                                <div class="mb-1">
                                                    <i class="fas fa-arrows-alt me-1"></i>
                                                    í•´ìƒë„: <span id="imageDimensions">-</span>
                                                </div>
                                                <div class="mb-1">
                                                    <i class="fas fa-crop-alt me-1"></i>
                                                    ìµœì¢…: 300 Ã— 400px
                                                </div>
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="crop-actions mt-4">
                                <div class="d-flex justify-content-between">
                                    <button type="button" class="btn btn-outline-secondary" id="backToUpload">
                                        <i class="fas fa-arrow-left me-1"></i>ë‹¤ë¥¸ ì´ë¯¸ì§€ ì„ íƒ
                                    </button>
                                    <button type="button" class="btn btn-primary" id="cropAndSave">
                                        <i class="fas fa-crop-alt me-1"></i>í¬ë¡­ ì™„ë£Œ
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- 3ë‹¨ê³„: ì••ì¶• ë° SEO ìµœì í™” -->
                        <div id="compressionSection" class="compression-section" style="display: none;">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="compression-settings">
                                        <h6 class="mb-3">
                                            <i class="fas fa-compress-alt me-2"></i>ì´ë¯¸ì§€ ì••ì¶• ì„¤ì •
                                        </h6>
                                        
                                        <!-- ì´ë¯¸ì§€ í˜•ì‹ ì„ íƒ -->
                                        <div class="mb-3">
                                            <label class="form-label">ì´ë¯¸ì§€ í˜•ì‹</label>
                                            <div class="btn-group w-100" role="group">
                                                <input type="radio" class="btn-check" name="imageFormat" id="formatAVIF" value="avif" checked>
                                                <label class="btn btn-outline-success btn-sm" for="formatAVIF">
                                                    <i class="fas fa-bolt me-1"></i>AVIF
                                                    <small class="d-block text-muted">ìš©ëŸ‰ ìµœì†Œ (ê¶Œì¥)</small>
                                                </label>
                                                
                                                <input type="radio" class="btn-check" name="imageFormat" id="formatWEBP" value="webp">
                                                <label class="btn btn-outline-primary btn-sm" for="formatWEBP">
                                                    <i class="fas fa-rocket me-1"></i>WebP
                                                    <small class="d-block text-muted">ë¹ ë¥¸ ë¡œë”©</small>
                                                </label>
                                                
                                                <input type="radio" class="btn-check" name="imageFormat" id="formatJPEG" value="jpeg">
                                                <label class="btn btn-outline-secondary btn-sm" for="formatJPEG">
                                                    <i class="fas fa-check me-1"></i>JPEG
                                                    <small class="d-block text-muted">ë²”ìš© í˜¸í™˜</small>
                                                </label>
                                            </div>
                                        </div>
                                        
                                        <!-- ì••ì¶• í’ˆì§ˆ -->
                                        <div class="mb-3">
                                            <label class="form-label">
                                                ì••ì¶• í’ˆì§ˆ: <span id="qualityPercent">80%</span>
                                            </label>
                                            <input type="range" class="form-range" id="qualitySlider" 
                                                   min="0.3" max="1.0" step="0.1" value="0.8">
                                            <div class="d-flex justify-content-between small text-muted">
                                                <span>ë†’ì€ ì••ì¶•</span>
                                                <span>ë†’ì€ í’ˆì§ˆ</span>
                                            </div>
                                        </div>
                                        
                                        <!-- ìë™ ìµœì í™” -->
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" id="autoOptimize" checked>
                                            <label class="form-check-label" for="autoOptimize">
                                                <i class="fas fa-magic me-1"></i>ìë™ ìµœì í™”
                                                <small class="d-block text-muted">ë¸Œë¼ìš°ì €ë³„ ìµœì  í˜•ì‹ ìë™ ì„ íƒ</small>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="compression-preview">
                                        <h6 class="mb-3">
                                            <i class="fas fa-eye me-2"></i>ì••ì¶• ê²°ê³¼
                                        </h6>
                                        <div class="compression-info text-center mb-3">
                                            <div class="compression-savings text-success fw-bold mb-2">
                                                <span id="compressionSavings">ê³„ì‚° ì¤‘...</span>
                                            </div>
                                            <small class="text-muted">
                                                í˜„ì¬ í˜•ì‹: <span id="currentFormat" class="fw-bold">AVIF</span>
                                            </small>
                                        </div>
                                        
                                        <div class="final-preview-container">
                                            <img id="finalPreviewImage" class="img-fluid rounded" 
                                                 style="max-width: 100%; height: auto; border: 2px solid #dee2e6;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- SEO ìµœì í™” ì„¹ì…˜ -->
                            <div class="seo-optimization-section mt-4">
                                <h6 class="mb-3">
                                    <i class="fas fa-search me-2"></i>SEO ìµœì í™” & íŒŒì¼ëª… ê´€ë¦¬
                                </h6>
                                
                                <!-- ì´ë¯¸ì§€ íŒŒì¼ëª… ìˆ˜ì • -->
                                <div class="mb-4">
                                    <label for="profileNameInput" class="form-label">
                                        <i class="fas fa-file-signature me-1"></i>ì´ë¯¸ì§€ íŒŒì¼ëª…
                                    </label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="profileNameInput" 
                                               placeholder="ì˜ˆ: ê¹€ì² ìˆ˜-ì¦ëª…ì‚¬ì§„">
                                        <button type="button" class="btn btn-outline-info" id="previewProfileNameBtn">
                                            <i class="fas fa-eye me-1"></i>ë¯¸ë¦¬ë³´ê¸°
                                        </button>
                                    </div>
                                    <div class="mt-2">
                                        <small class="text-info">
                                            <i class="fas fa-info-circle me-1"></i>
                                            ì‹¤ì œ ì €ì¥ëª…: <span id="previewProfileName" class="fw-bold">profile_user_photo.jpg</span>
                                        </small>
                                    </div>
                                </div>

                                <!-- ì¶”ì²œ í‚¤ì›Œë“œ -->
                                <div class="mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-tags me-1"></i>ì¶”ì²œ í‚¤ì›Œë“œ (í´ë¦­í•˜ì—¬ ì¶”ê°€)
                                    </label>
                                    <div class="keyword-suggestions">
                                        <div class="mb-2">
                                            <small class="text-muted fw-bold">ì‚¬ì§„ ì¢…ë¥˜:</small>
                                            <div class="keyword-group">
                                                <button type="button" class="btn btn-outline-primary btn-sm keyword-btn" data-keyword="ì¦ëª…ì‚¬ì§„">ì¦ëª…ì‚¬ì§„</button>
                                                <button type="button" class="btn btn-outline-primary btn-sm keyword-btn" data-keyword="í”„ë¡œí•„">í”„ë¡œí•„</button>
                                                <button type="button" class="btn btn-outline-primary btn-sm keyword-btn" data-keyword="ì •ë©´ì‚¬ì§„">ì •ë©´ì‚¬ì§„</button>
                                                <button type="button" class="btn btn-outline-primary btn-sm keyword-btn" data-keyword="ì—¬ê¶Œì‚¬ì§„">ì—¬ê¶Œì‚¬ì§„</button>
                                            </div>
                                        </div>
                                        <div class="mb-2">
                                            <small class="text-muted fw-bold">ìš©ë„:</small>
                                            <div class="keyword-group">
                                                <button type="button" class="btn btn-outline-success btn-sm keyword-btn" data-keyword="ì´ë ¥ì„œ">ì´ë ¥ì„œ</button>
                                                <button type="button" class="btn btn-outline-success btn-sm keyword-btn" data-keyword="ìê²©ì¦">ìê²©ì¦</button>
                                                <button type="button" class="btn btn-outline-success btn-sm keyword-btn" data-keyword="ì‹ ë¶„ì¦">ì‹ ë¶„ì¦</button>
                                                <button type="button" class="btn btn-outline-success btn-sm keyword-btn" data-keyword="ì…ì‚¬ì§€ì›">ì…ì‚¬ì§€ì›</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Alt í…ìŠ¤íŠ¸ -->
                                <div class="mb-3">
                                    <label for="altTextInput" class="form-label">
                                        <i class="fas fa-tag me-1"></i>ì´ë¯¸ì§€ ì„¤ëª… (Alt í…ìŠ¤íŠ¸)
                                    </label>
                                    <div class="input-group">
                                        <textarea class="form-control" id="altTextInput" rows="2" 
                                                  placeholder="í”„ë¡œí•„ ì´ë¯¸ì§€ì— ëŒ€í•œ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš” (SEO ìµœì í™”ìš©)">ì‚¬ìš©ì í”„ë¡œí•„ ì‚¬ì§„</textarea>
                                        <button type="button" class="btn btn-outline-secondary" id="autoGenerateAltBtn">
                                            <i class="fas fa-magic me-1"></i>ìë™ ìƒì„±
                                        </button>
                                    </div>
                                    <small class="text-muted">
                                        <i class="fas fa-lightbulb me-1"></i>
                                        ê²€ìƒ‰ ì—”ì§„ ìµœì í™”ë¥¼ ìœ„í•œ ì´ë¯¸ì§€ ì„¤ëª…ì…ë‹ˆë‹¤
                                    </small>
                                </div>

                                <!-- SEO íŒ -->
                                <div class="seo-tips alert alert-info">
                                    <h6 class="alert-heading">
                                        <i class="fas fa-graduation-cap me-2"></i>SEO ìµœì í™” íŒ
                                    </h6>
                                    <ul class="mb-0 small">
                                        <li>êµ¬ì²´ì ì¸ í”„ë¡œí•„ ì‚¬ì§„ ì„¤ëª… ì‘ì„±</li>
                                        <li>ìš©ë„ë‚˜ ëª©ì ì„ í¬í•¨í•œ í‚¤ì›Œë“œ ì‚¬ìš©</li>
                                        <li>ì˜ˆ: "ê¹€ì² ìˆ˜ ìš”ì–‘ë³´í˜¸ì‚¬ ì¦ëª…ì‚¬ì§„"</li>
                                        <li>í•œê¸€ í‚¤ì›Œë“œë¡œ êµ­ë‚´ ê²€ìƒ‰ì— ìµœì í™”</li>
                                    </ul>
                                </div>
                            </div>
                            
                            <div class="compression-actions mt-4 text-center">
                                <div class="d-flex justify-content-between">
                                    <button type="button" class="btn btn-outline-secondary" id="backToCropBtn">
                                        <i class="fas fa-arrow-left me-2"></i>í¬ë¡­ìœ¼ë¡œ ëŒì•„ê°€ê¸°
                                    </button>
                                    <button type="button" class="btn btn-success" id="saveImageBtn">
                                        <i class="fas fa-save me-2"></i>ì™„ë£Œ
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- 4ë‹¨ê³„: ì™„ë£Œ -->
                        <div id="completeSection" class="complete-section" style="display: none;">
                            <div class="text-center">
                                <div class="success-icon mb-3">
                                    <i class="fas fa-check-circle fa-4x text-success"></i>
                                </div>
                                <h4 class="text-success mb-2">í”„ë¡œí•„ ì´ë¯¸ì§€ ì €ì¥ ì™„ë£Œ!</h4>
                                <p class="text-muted mb-4">ìƒˆë¡œìš´ í”„ë¡œí•„ ì´ë¯¸ì§€ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                                
                                <div class="final-preview mb-4">
                                    <img id="finalPreview" style="width: 150px; height: 200px; border-radius: 8px; object-fit: cover;" alt="ìµœì¢… í”„ë¡œí•„ ì´ë¯¸ì§€">
                                </div>
                                
                                <div class="d-flex justify-content-center gap-3">
                                    <button type="button" class="btn btn-outline-primary" id="cropAnother">
                                        <i class="fas fa-redo me-1"></i>ë‹¤ë¥¸ ì´ë¯¸ì§€ ì„ íƒ
                                    </button>
                                    <a href="/member/myinfo/edit" class="btn btn-success">
                                        <i class="fas fa-user me-1"></i>ë§ˆì´í˜ì´ì§€ë¡œ ì´ë™
                                    </a>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<footer th:replace="~{layout/footer :: footer}"></footer>

<div th:replace="~{layout/footer :: scripts}"></div>

<!-- ë°±ì—… ê¸°ë°˜ ê³ ê¸‰ í¬ë¡­ ìŠ¤í¬ë¦½íŠ¸ -->
<script>
/**
 * í”„ë¡œí•„ ì´ë¯¸ì§€ í¬ë¡­ ì „ìš© JavaScript
 * í•œêµ­ í‘œì¤€ ì¦ëª…ì‚¬ì§„ ë¹„ìœ¨(3:4) ìµœì í™” ë²„ì „
 * Cropper.js ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš©
 */

// ì „ì—­ ë³€ìˆ˜
let cropper = null;
let originalImageData = null;
let originalImage = null;

// DOM ìš”ì†Œ
const elements = {};

// ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', function() {
    initializeElements();
    setupEventListeners();
    console.log('í”„ë¡œí•„ ì´ë¯¸ì§€ í¬ë¡­ í˜ì´ì§€ ì´ˆê¸°í™” ì™„ë£Œ (Cropper.js)');
});

// DOM ìš”ì†Œ ì´ˆê¸°í™”
function initializeElements() {
    elements.imageInput = document.getElementById('imageInput');
    elements.cropImage = document.getElementById('cropImage');
    elements.uploadSection = document.getElementById('uploadSection');
    elements.cropSection = document.getElementById('cropSection');
    elements.compressionSection = document.getElementById('compressionSection');
    elements.completeSection = document.getElementById('completeSection');
    elements.previewCanvas = document.getElementById('previewCanvas');
    elements.finalPreview = document.getElementById('finalPreview');
    elements.finalPreviewImage = document.getElementById('finalPreviewImage');
    elements.zoomIndicator = document.getElementById('zoomIndicator');
    elements.zoomLevel = document.getElementById('zoomLevel');
    elements.zoomStatus = document.getElementById('zoomStatus');
    elements.compressionSavings = document.getElementById('compressionSavings');
    elements.qualitySlider = document.getElementById('qualitySlider');
    elements.qualityLabel = document.getElementById('qualityLabel');
    elements.altTextInput = document.getElementById('altTextInput');
    elements.currentFormat = document.getElementById('currentFormat');
    elements.formatJPEG = document.getElementById('formatJPEG');
    elements.formatAVIF = document.getElementById('formatAVIF');
    elements.formatWEBP = document.getElementById('formatWEBP');
    
    // ë‹¨ê³„ ìš”ì†Œ
    elements.steps = {
        step1: document.getElementById('step1'),
        step2: document.getElementById('step2'),
        step3: document.getElementById('step3'),
        step4: document.getElementById('step4')
    };
    
    // ë²„íŠ¼ ìš”ì†Œ
    elements.buttons = {
        zoomIn: document.getElementById('zoomIn'),
        zoomOut: document.getElementById('zoomOut'),
        resetZoom: document.getElementById('resetZoom'),
        backToUpload: document.getElementById('backToUpload'),
        cropAndSave: document.getElementById('cropAndSave'),
        cropAnother: document.getElementById('cropAnother'),
        backToCrop: document.getElementById('backToCropBtn'),
        removeImage: document.getElementById('removeImageBtn'),
        saveImage: document.getElementById('saveImageBtn'),
        recompress: document.getElementById('recompressBtn'),
        autoGenerateAlt: document.getElementById('autoGenerateAltBtn'),
        optimize: document.getElementById('optimizeBtn')
    };
}

// ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
function setupEventListeners() {
    // íŒŒì¼ ì…ë ¥ ì´ë²¤íŠ¸ ë“±ë¡
    if (elements.imageInput) {
        elements.imageInput.removeEventListener('change', handleImageUpload);
        elements.imageInput.addEventListener('change', handleImageUpload);
        console.log('íŒŒì¼ ì…ë ¥ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ë¨');
    }
    
    // í™•ëŒ€/ì¶•ì†Œ ë²„íŠ¼
    if (elements.buttons.zoomIn) {
        elements.buttons.zoomIn.addEventListener('click', () => {
            if (cropper) {
                cropper.zoom(0.1);
            }
        });
    }
    
    if (elements.buttons.zoomOut) {
        elements.buttons.zoomOut.addEventListener('click', () => {
            if (cropper) {
                cropper.zoom(-0.1);
            }
        });
    }
    
    if (elements.buttons.resetZoom) {
        elements.buttons.resetZoom.addEventListener('click', () => {
            if (cropper) {
                cropper.reset();
            }
        });
    }
    
    // ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼
    if (elements.buttons.backToUpload) {
        elements.buttons.backToUpload.addEventListener('click', goToUploadStep);
    }
    
    if (elements.buttons.cropAndSave) {
        elements.buttons.cropAndSave.addEventListener('click', cropAndSaveImage);
    }
    
    if (elements.buttons.cropAnother) {
        elements.buttons.cropAnother.addEventListener('click', goToUploadStep);
    }
    
    // 3ë‹¨ê³„ ì••ì¶• ê´€ë ¨ ë²„íŠ¼
    if (elements.buttons.backToCrop) {
        elements.buttons.backToCrop.addEventListener('click', goToCropStep);
    }
    
    if (elements.buttons.removeImage) {
        elements.buttons.removeImage.addEventListener('click', goToUploadStep);
    }
    
    if (elements.buttons.saveImage) {
        elements.buttons.saveImage.addEventListener('click', saveCompressedImageToServer);
    }
    
    if (elements.buttons.recompress) {
        elements.buttons.recompress.addEventListener('click', updateCompression);
    }
    
    if (elements.buttons.autoGenerateAlt) {
        elements.buttons.autoGenerateAlt.addEventListener('click', generateAltText);
    }
    
    if (elements.buttons.optimize) {
        elements.buttons.optimize.addEventListener('click', autoOptimizeImage);
    }
    
    // ì••ì¶• í’ˆì§ˆ ìŠ¬ë¼ì´ë”
    if (elements.qualitySlider) {
        elements.qualitySlider.addEventListener('input', (e) => {
            const quality = Math.round(e.target.value * 100);
            elements.qualityLabel.textContent = quality;
            updateCompression();
        });
    }
    
    // ì´ë¯¸ì§€ í˜•ì‹ ì„ íƒ
    ['formatJPEG', 'formatAVIF', 'formatWEBP'].forEach(formatId => {
        const element = document.getElementById(formatId);
        if (element) {
            element.addEventListener('change', updateCompression);
        }
    });
    
    // íŒŒì¼ ì„ íƒ ë²„íŠ¼
    const fileSelectBtn = document.getElementById('fileSelectBtn');
    if (fileSelectBtn) {
        fileSelectBtn.addEventListener('click', () => {
            console.log('íŒŒì¼ ì„ íƒ ë²„íŠ¼ í´ë¦­ë¨');
            if (elements.imageInput) {
                elements.imageInput.click();
            }
        });
    }
    
    // ë“œë˜ê·¸ ì•¤ ë“œë¡­ (ì—…ë¡œë“œ ì˜ì—­ ì „ì²´)
    const uploadArea = document.querySelector('.upload-area');
    if (uploadArea) {
        uploadArea.addEventListener('dragover', handleDragOver);
        uploadArea.addEventListener('drop', handleDrop);
        
        // ì—…ë¡œë“œ ì˜ì—­ í´ë¦­ ì‹œ íŒŒì¼ ì„ íƒ (ë²„íŠ¼ ì˜ì—­ ì œì™¸)
        uploadArea.addEventListener('click', (event) => {
            if (!event.target.closest('#fileSelectBtn')) {
                console.log('ì—…ë¡œë“œ ì˜ì—­ í´ë¦­ë¨');
                if (elements.imageInput) {
                    elements.imageInput.click();
                }
            }
        });
    }
}

// ë“œë˜ê·¸ ì˜¤ë²„ ì²˜ë¦¬
function handleDragOver(event) {
    event.preventDefault();
    event.currentTarget.style.borderColor = '#0d6efd';
    event.currentTarget.style.backgroundColor = '#f8f9ff';
}

// ë“œë¡­ ì²˜ë¦¬
function handleDrop(event) {
    event.preventDefault();
    const files = event.dataTransfer.files;
    if (files.length > 0) {
        handleImageFile(files[0]);
    }
    
    // ìŠ¤íƒ€ì¼ ë¦¬ì…‹
    event.currentTarget.style.borderColor = '';
    event.currentTarget.style.backgroundColor = '';
}

// ì´ë¯¸ì§€ ì—…ë¡œë“œ ì²˜ë¦¬
function handleImageUpload(event) {
    console.log('íŒŒì¼ ì—…ë¡œë“œ ì´ë²¤íŠ¸ ë°œìƒ:', event);
    const file = event.target.files[0];
    if (file) {
        console.log('ì„ íƒëœ íŒŒì¼:', file.name, file.size, file.type);
        handleImageFile(file);
    } else {
        console.log('ì„ íƒëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤');
    }
}

// ì´ë¯¸ì§€ íŒŒì¼ ì²˜ë¦¬
function handleImageFile(file) {
    console.log('ì´ë¯¸ì§€ íŒŒì¼ ì²˜ë¦¬ ì‹œì‘:', file.name, 'í¬ê¸°:', (file.size / 1024 / 1024).toFixed(2) + 'MB');
    
    // íŒŒì¼ íƒ€ì… ê²€ì¦
    if (!file.type.startsWith('image/')) {
        alert('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
        return;
    }
    
    // ì§€ì›ë˜ëŠ” í˜•ì‹ ê²€ì¦
    const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
    if (!allowedTypes.includes(file.type)) {
        alert('JPG, PNG, WebP íŒŒì¼ë§Œ ì§€ì›ë©ë‹ˆë‹¤.');
        return;
    }
    
    console.log('íŒŒì¼ ê²€ì¦ í†µê³¼, FileReader ì‹œì‘');
    
    // í° íŒŒì¼ë„ í—ˆìš©í•˜ê³  ì••ì¶•ìœ¼ë¡œ í•´ê²°
    if (file.size > 5 * 1024 * 1024) {
        console.log('âš ï¸ í° íŒŒì¼ ê°ì§€ (' + (file.size / 1024 / 1024).toFixed(2) + 'MB) - ì••ì¶•ìœ¼ë¡œ ì²˜ë¦¬');
        showLargeFileNotice(file.size);
    }
    
    // ë¡œì»¬ì—ì„œ ì´ë¯¸ì§€ ë¡œë“œ
    const reader = new FileReader();
    reader.onload = function(e) {
        console.log('FileReader ë¡œë“œ ì™„ë£Œ');
        originalImageData = e.target.result;
        loadImageToCropper(originalImageData);
        goToCropStep();
    };
    reader.onerror = function(e) {
        console.error('FileReader ì˜¤ë¥˜:', e);
        alert('íŒŒì¼ ì½ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    };
    reader.readAsDataURL(file);
}

// í° íŒŒì¼ ì•ˆë‚´ ë©”ì‹œì§€ í‘œì‹œ
function showLargeFileNotice(fileSize) {
    const sizeMB = (fileSize / 1024 / 1024).toFixed(2);
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-info alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
    alertDiv.style.cssText = 'z-index: 10000; min-width: 350px;';
    alertDiv.innerHTML = `
        <i class="fas fa-info-circle me-2"></i>
        í° íŒŒì¼(${sizeMB}MB)ì„ ì—…ë¡œë“œí•˜ì…¨ìŠµë‹ˆë‹¤. ìë™ìœ¼ë¡œ ì••ì¶•í•˜ì—¬ ìµœì í™”í•©ë‹ˆë‹¤.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    // 8ì´ˆ í›„ ìë™ ì œê±°
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 8000);
}

// í¬ë¡­í¼ì— ì´ë¯¸ì§€ ë¡œë“œ
function loadImageToCropper(imageData) {
    if (!elements.cropImage) return;
    
    elements.cropImage.src = imageData;
    elements.cropImage.style.display = 'block';
    
    // ì´ë¯¸ì§€ê°€ ë¡œë“œëœ í›„ í¬ë¡­í¼ ì´ˆê¸°í™”
    elements.cropImage.onload = function() {
        console.log('ì´ë¯¸ì§€ ë¡œë“œ ì™„ë£Œ, í¬ë¡­í¼ ì´ˆê¸°í™” ì‹œì‘');
        setTimeout(() => {
            initializeCropper();
        }, 100);
    };
}

// í¬ë¡­í¼ ì´ˆê¸°í™” (Cropper.js ì‚¬ìš©)
function initializeCropper() {
    if (cropper) {
        cropper.destroy();
    }
    
    console.log('ğŸš€ Cropper.js ì´ˆê¸°í™” ì‹œì‘');
    
    // í•œêµ­ í‘œì¤€ ì¦ëª…ì‚¬ì§„ ë¹„ìœ¨ ì ìš© (ê°€ë¡œ3:ì„¸ë¡œ4)
    const aspectRatio = 3 / 4; // 0.75 (ì„¸ë¡œê°€ ë” ê¸´ í˜•íƒœ)
    
    cropper = new Cropper(elements.cropImage, {
        aspectRatio: aspectRatio, // 3:4 ë¹„ìœ¨
        viewMode: 1, // í¬ë¡­ ë°•ìŠ¤ë¥¼ ìº”ë²„ìŠ¤ ë‚´ë¶€ë¡œ ì œí•œ
        dragMode: 'move', // ë“œë˜ê·¸ ëª¨ë“œ
        autoCropArea: 0.8, // ìë™ í¬ë¡­ ì˜ì—­ í¬ê¸°
        restore: false, // í¬ê¸° ì¡°ì • ì‹œ í¬ë¡­ ë°•ìŠ¤ ë³µì› ì•ˆí•¨
        guides: true, // ê°€ì´ë“œ ë¼ì¸ í‘œì‹œ
        center: true, // ì¤‘ì•™ í‘œì‹œì í‘œì‹œ
        highlight: true, // í¬ë¡­ ë°•ìŠ¤ í•˜ì´ë¼ì´íŠ¸
        cropBoxMovable: true, // í¬ë¡­ ë°•ìŠ¤ ì´ë™ ê°€ëŠ¥
        cropBoxResizable: true, // í¬ë¡­ ë°•ìŠ¤ í¬ê¸° ì¡°ì • ê°€ëŠ¥
        toggleDragModeOnDblclick: false, // ë”ë¸”í´ë¦­ìœ¼ë¡œ ë“œë˜ê·¸ ëª¨ë“œ í† ê¸€ ì•ˆí•¨
        
        // ì´ˆê¸°í™” ì™„ë£Œ ì‹œ
        ready: function() {
            console.log('âœ… Cropper.js ì´ˆê¸°í™” ì™„ë£Œ');
            console.log('ğŸ“ ì„¤ì •ëœ aspectRatio:', aspectRatio);
            console.log('ğŸ¯ ëª©í‘œ: ì¦ëª…ì‚¬ì§„ ë¹„ìœ¨ (3:4, ì„¸ë¡œê°€ ë” ê¸´ í˜•íƒœ)');
            
            // ì´ˆê¸° í¬ë¡­ ë°ì´í„° í™•ì¸
            const cropData = cropper.getData();
            const currentRatio = cropData.width / cropData.height;
            console.log('ğŸ“Š ì´ˆê¸° í¬ë¡­ ì˜ì—­:', Math.round(cropData.width), 'x', Math.round(cropData.height));
            console.log('ğŸ“Š ì´ˆê¸° ì‹¤ì œ ë¹„ìœ¨:', currentRatio.toFixed(3), 'ëª©í‘œ:', aspectRatio.toFixed(3));
            
            // ì´ˆê¸° ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
            updatePreview();
        },
        
        // í¬ë¡­ ë³€ê²½ ì‹œ
        crop: function(event) {
            const data = event.detail;
            const currentRatio = data.width / data.height;
            const targetRatio = aspectRatio;
            
            // ë¹„ìœ¨ ì°¨ì´ í—ˆìš© ì˜¤ì°¨ (0.5%) - ë” ì—„ê²©í•˜ê²Œ
            const tolerance = 0.005;
            
            // ë¹„ìœ¨ì´ ëª©í‘œì—ì„œ ë²—ì–´ë‚  ê²½ìš° ê°•ì œ ì¡°ì • (ëŒ€ê°ì„  ë¹„ë¡€ ì¡°ì •)
            if (Math.abs(currentRatio - targetRatio) > tolerance) {
                console.log('ğŸ”§ ë¹„ìœ¨ ìë™ ì¡°ì • (ëŒ€ê°ì„  ë¹„ë¡€):', currentRatio.toFixed(3), 'â†’', targetRatio.toFixed(3));
                
                // ëŒ€ê°ì„  ë¹„ë¡€ ì¡°ì •: ì¤‘ì‹¬ì ì„ ìœ ì§€í•˜ë©´ì„œ ë¹„ìœ¨ ë§ì¶¤
                const centerX = data.x + data.width / 2;
                const centerY = data.y + data.height / 2;
                
                let newWidth, newHeight;
                
                // í˜„ì¬ í¬ê¸°ì—ì„œ ë¹„ìœ¨ì— ë§ê²Œ ì¡°ì • (ëŒ€ê°ì„  í™•ëŒ€/ì¶•ì†Œ)
                if (currentRatio > targetRatio) {
                    // ë„ˆë¬´ ë„“ìŒ - ë†’ì´ ê¸°ì¤€ìœ¼ë¡œ ì¡°ì •
                    newHeight = data.height;
                    newWidth = newHeight * targetRatio;
                } else {
                    // ë„ˆë¬´ ë†’ìŒ - ë„ˆë¹„ ê¸°ì¤€ìœ¼ë¡œ ì¡°ì •
                    newWidth = data.width;
                    newHeight = newWidth / targetRatio;
                }
                
                // ì¤‘ì‹¬ì  ìœ ì§€í•˜ë©´ì„œ ìƒˆ ìœ„ì¹˜ ê³„ì‚°
                const newX = centerX - newWidth / 2;
                const newY = centerY - newHeight / 2;
                
                // ë¹„ìœ¨ ê°•ì œ ì ìš© (ëŒ€ê°ì„  ë¹„ë¡€ ìœ ì§€)
                cropper.setData({
                    x: newX,
                    y: newY,
                    width: newWidth,
                    height: newHeight
                });
                
                console.log('âœ… ëŒ€ê°ì„  ë¹„ìœ¨ ì¡°ì • ì™„ë£Œ:', newWidth.toFixed(1), 'x', newHeight.toFixed(1));
            } else {
                // ì •ìƒ ë²”ìœ„ ë‚´ ë¹„ìœ¨
                if (Math.abs(currentRatio - targetRatio) > 0.002) {
                    console.log('ğŸ“ ë¹„ìœ¨ ì²´í¬ (ì •ìƒ):', currentRatio.toFixed(3), 'ëª©í‘œ:', targetRatio.toFixed(3));
                }
            }
            
            // ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
            updatePreview();
        }
    });
    
    // ìŠ¤ë§ˆíŠ¸ ìŠ¤í¬ë¡¤ ê¸°ëŠ¥ ì¶”ê°€ (ì´ë¯¸ì§€ í™•ëŒ€/ì¶•ì†Œ ìš°ì„ , í•œê³„ì ì—ì„œ í˜ì´ì§€ ìŠ¤í¬ë¡¤)
    setupSmartScroll();
}

// ìŠ¤ë§ˆíŠ¸ ìŠ¤í¬ë¡¤ ê¸°ëŠ¥
function setupSmartScroll() {
    if (!cropper || !elements.cropImage) return;
    
    const cropContainer = elements.cropImage.parentElement;
    if (!cropContainer) return;
    
    // ìµœëŒ€/ìµœì†Œ ì¤Œ ë ˆë²¨ ì„¤ì •
    const MIN_ZOOM = 0.1;  // ìµœì†Œ ì¤Œ (10%)
    const MAX_ZOOM = 3.0;  // ìµœëŒ€ ì¤Œ (300%)
    
    console.log('ğŸ–±ï¸ ìŠ¤ë§ˆíŠ¸ ìŠ¤í¬ë¡¤ ê¸°ëŠ¥ í™œì„±í™”');
    
    cropContainer.addEventListener('wheel', function(event) {
        if (!cropper) return;
        
        // í˜„ì¬ ì¤Œ ë ˆë²¨ í™•ì¸ (ë” ì •í™•í•œ ë°©ì‹)
        const canvasData = cropper.getCanvasData();
        const containerData = cropper.getContainerData();
        const currentZoom = canvasData.naturalWidth > 0 ? canvasData.width / canvasData.naturalWidth : 1;
        
        const isZoomingIn = event.deltaY < 0;  // íœ ì„ ìœ„ë¡œ ì˜¬ë¦¬ë©´ í™•ëŒ€
        const isZoomingOut = event.deltaY > 0; // íœ ì„ ì•„ë˜ë¡œ ë‚´ë¦¬ë©´ ì¶•ì†Œ
        
        console.log('ğŸ” í˜„ì¬ ì¤Œ:', currentZoom.toFixed(2), 'ë°©í–¥:', isZoomingIn ? 'í™•ëŒ€' : 'ì¶•ì†Œ');
        
        // ë” ê´€ëŒ€í•œ ì„ê³„ê°’ ì„¤ì •
        const maxThreshold = 2.8;  // ì¡°ê¸ˆ ë” ë‚®ì€ ìµœëŒ€ê°’
        const minThreshold = 0.2;  // ì¡°ê¸ˆ ë” ë†’ì€ ìµœì†Œê°’
        
        // í™•ëŒ€ ì‹œ: ìµœëŒ€ ì¤Œ ê·¼ì²˜ì—ì„œ í˜ì´ì§€ ìŠ¤í¬ë¡¤ í—ˆìš©
        if (isZoomingIn && currentZoom >= maxThreshold) {
            updateZoomIndicator(currentZoom, 'ìµœëŒ€ í™•ëŒ€');
            console.log('ğŸ“ˆ ìµœëŒ€ í™•ëŒ€ ê·¼ì²˜ - í˜ì´ì§€ ìŠ¤í¬ë¡¤ ì‹¤í–‰');
            
            // í˜ì´ì§€ ìŠ¤í¬ë¡¤ì„ ë” ë¶€ë“œëŸ½ê²Œ ì‹¤í–‰
            const scrollAmount = event.deltaY * 0.5; // ìŠ¤í¬ë¡¤ ê°•ë„ ì¡°ì ˆ
            window.scrollBy({
                top: scrollAmount,
                behavior: 'smooth'
            });
            return;
        }
        
        // ì¶•ì†Œ ì‹œ: ìµœì†Œ ì¤Œ ê·¼ì²˜ì—ì„œ í˜ì´ì§€ ìŠ¤í¬ë¡¤ í—ˆìš©  
        if (isZoomingOut && currentZoom <= minThreshold) {
            updateZoomIndicator(currentZoom, 'ìµœì†Œ ì¶•ì†Œ');
            console.log('ğŸ“‰ ìµœì†Œ ì¶•ì†Œ ê·¼ì²˜ - í˜ì´ì§€ ìŠ¤í¬ë¡¤ ì‹¤í–‰');
            
            // í˜ì´ì§€ ìŠ¤í¬ë¡¤ì„ ë” ë¶€ë“œëŸ½ê²Œ ì‹¤í–‰
            const scrollAmount = event.deltaY * 0.5; // ìŠ¤í¬ë¡¤ ê°•ë„ ì¡°ì ˆ
            window.scrollBy({
                top: scrollAmount,
                behavior: 'smooth'
            });
            return;
        }
        
        // ì´ë¯¸ì§€ í™•ëŒ€/ì¶•ì†Œ ë²”ìœ„ ë‚´ì—ì„œëŠ” ê¸°ë³¸ ìŠ¤í¬ë¡¤ ì°¨ë‹¨í•˜ê³  ì¤Œ ì ìš©
        event.preventDefault();
        event.stopPropagation();
        
        const zoomDelta = isZoomingIn ? 0.1 : -0.1;
        cropper.zoom(zoomDelta);
        
        // ì¤Œ í‘œì‹œê¸° ì—…ë°ì´íŠ¸
        const newZoom = Math.max(MIN_ZOOM, Math.min(MAX_ZOOM, currentZoom + zoomDelta));
        updateZoomIndicator(newZoom, isZoomingIn ? 'í™•ëŒ€' : 'ì¶•ì†Œ');
        
    }, { passive: false }); // passive: falseë¡œ ì„¤ì •í•´ì•¼ preventDefault ì‘ë™
}

// ì¤Œ í‘œì‹œê¸° ì—…ë°ì´íŠ¸
function updateZoomIndicator(zoomLevel, status) {
    if (!elements.zoomIndicator || !elements.zoomLevel || !elements.zoomStatus) return;
    
    // ì¤Œ ë ˆë²¨ì„ í¼ì„¼íŠ¸ë¡œ í‘œì‹œ
    const zoomPercent = Math.round(zoomLevel * 100);
    elements.zoomLevel.textContent = zoomPercent + '%';
    
    // ìƒíƒœ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
    let statusMessage = '';
    let statusClass = '';
    
    if (status === 'ìµœëŒ€ í™•ëŒ€') {
        statusMessage = '(ìµœëŒ€ - í˜ì´ì§€ ìŠ¤í¬ë¡¤ ê°€ëŠ¥)';
        statusClass = 'text-warning';
    } else if (status === 'ìµœì†Œ ì¶•ì†Œ') {
        statusMessage = '(ìµœì†Œ - í˜ì´ì§€ ìŠ¤í¬ë¡¤ ê°€ëŠ¥)';
        statusClass = 'text-info';
    } else {
        statusMessage = `(${status} ì¤‘)`;
        statusClass = 'text-success';
    }
    
    elements.zoomStatus.textContent = statusMessage;
    elements.zoomStatus.className = `ms-2 ${statusClass}`;
    
    // ì¤Œ í‘œì‹œê¸° ë³´ì´ê¸°
    elements.zoomIndicator.style.display = 'block';
    
    // 3ì´ˆ í›„ ìë™ ìˆ¨ê¹€
    clearTimeout(window.zoomIndicatorTimeout);
    window.zoomIndicatorTimeout = setTimeout(() => {
        if (elements.zoomIndicator) {
            elements.zoomIndicator.style.display = 'none';
        }
    }, 3000);
}

// ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
function updatePreview() {
    if (!cropper || !elements.previewCanvas) {
        return;
    }
    
    console.log('ğŸ–¼ï¸ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸ ì‹œì‘');
    
    // í¬ë¡­ëœ ì´ë¯¸ì§€ë¥¼ ìº”ë²„ìŠ¤ì— ê·¸ë¦¬ê¸°
    const canvas = cropper.getCroppedCanvas({
        width: 90,  // ë¯¸ë¦¬ë³´ê¸° ìº”ë²„ìŠ¤ í¬ê¸°ì™€ ë™ì¼
        height: 120,
        imageSmoothingEnabled: true,
        imageSmoothingQuality: 'high'
    });
    
    if (canvas) {
        const ctx = elements.previewCanvas.getContext('2d');
        ctx.clearRect(0, 0, elements.previewCanvas.width, elements.previewCanvas.height);
        
        // í¬ë¡­ëœ ì´ë¯¸ì§€ë¥¼ ë¯¸ë¦¬ë³´ê¸° ìº”ë²„ìŠ¤ì— ê·¸ë¦¬ê¸°
        ctx.drawImage(canvas, 0, 0, elements.previewCanvas.width, elements.previewCanvas.height);
        
        console.log('âœ… ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸ ì™„ë£Œ');
    }
}

// í¬ë¡­ ì™„ë£Œ í›„ 3ë‹¨ê³„ë¡œ ì´ë™
function cropAndSaveImage() {
    if (!cropper) {
        alert('ì´ë¯¸ì§€ë¥¼ ë¨¼ì € ë¡œë“œí•´ì£¼ì„¸ìš”.');
        return;
    }
    
    setButtonLoading(elements.buttons.cropAndSave, true, 'ì²˜ë¦¬ ì¤‘...');
    
    try {
        // ìµœì¢… í¬ë¡­ëœ ì´ë¯¸ì§€ ìƒì„± (ê³ í’ˆì§ˆ)
        const canvas = cropper.getCroppedCanvas({
            width: 300,   // ìµœì¢… ì´ë¯¸ì§€ ê°€ë¡œ í¬ê¸°
            height: 400,  // ìµœì¢… ì´ë¯¸ì§€ ì„¸ë¡œ í¬ê¸° (3:4 ë¹„ìœ¨)
            imageSmoothingEnabled: true,
            imageSmoothingQuality: 'high'
        });
        
        if (canvas) {
            // í¬ë¡­ëœ ì›ë³¸ ë°ì´í„°ë¥¼ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
            window.croppedCanvas = canvas;
            window.originalFile = elements.imageInput.files[0];
            
            console.log('âœ… í¬ë¡­ ì™„ë£Œ - 3ë‹¨ê³„ë¡œ ì´ë™');
            
            // 3ë‹¨ê³„ ì••ì¶• ë‹¨ê³„ë¡œ ì´ë™
            goToCompressionStep();
            
        } else {
            throw new Error('ìº”ë²„ìŠ¤ ìƒì„± ì‹¤íŒ¨');
        }
        
    } catch (error) {
        console.error('í¬ë¡­ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
        alert('ì´ë¯¸ì§€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    } finally {
        setButtonLoading(elements.buttons.cropAndSave, false);
    }
}

// 3ë‹¨ê³„: ì••ì¶• ë° SEO ìµœì í™” ë‹¨ê³„ë¡œ ì´ë™
function goToCompressionStep() {
    hideAllSections();
    if (elements.compressionSection) elements.compressionSection.style.display = 'block';
    updateStepIndicator(3);
    
    // ì´ˆê¸° ì••ì¶• ì ìš© ë° ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
    updateCompression();
    generateAltText();
}

// ì´ë¯¸ì§€ ì••ì¶• ì—…ë°ì´íŠ¸ (ë‹¤ì¤‘ í˜•ì‹ ì§€ì›)
function updateCompression() {
    if (!window.croppedCanvas) {
        console.error('âŒ í¬ë¡­ëœ ìº”ë²„ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤');
        return;
    }
    
    const quality = parseFloat(elements.qualitySlider.value || 0.8);
    const selectedFormat = getSelectedImageFormat();
    
    console.log('ğŸ”„ ì´ë¯¸ì§€ ì••ì¶• ì—…ë°ì´íŠ¸ - í˜•ì‹:', selectedFormat.toUpperCase(), 'í’ˆì§ˆ:', Math.round(quality * 100) + '%');
    
    try {
        let compressedImageData;
        let actualFormat = selectedFormat;
        let formatSupported = false;
        
        // ë‹¨ê³„ë³„ í˜•ì‹ ì§€ì› í™•ì¸ ë° ì••ì¶•
        if (selectedFormat === 'avif') {
            console.log('ğŸ” AVIF ì§€ì› í™•ì¸ ì¤‘...');
            formatSupported = isFormatSupported('image/avif');
            if (formatSupported) {
                compressedImageData = window.croppedCanvas.toDataURL('image/avif', quality);
                console.log('âœ… AVIF í˜•ì‹ìœ¼ë¡œ ì••ì¶• ì„±ê³µ');
            } else {
                console.log('âš ï¸ AVIF ë¯¸ì§€ì› - WebP ì‹œë„');
                formatSupported = isFormatSupported('image/webp');
                if (formatSupported) {
                    compressedImageData = window.croppedCanvas.toDataURL('image/webp', quality);
                    actualFormat = 'webp';
                    console.log('âœ… WebP í˜•ì‹ìœ¼ë¡œ ì••ì¶• ì„±ê³µ (AVIF ëŒ€ì²´)');
                    showFormatFallbackMessage('AVIF', 'WebP');
                } else {
                    console.log('âš ï¸ WebPë„ ë¯¸ì§€ì› - JPEG ì‚¬ìš©');
                    compressedImageData = window.croppedCanvas.toDataURL('image/jpeg', quality);
                    actualFormat = 'jpeg';
                    console.log('âœ… JPEG í˜•ì‹ìœ¼ë¡œ ì••ì¶• ì„±ê³µ (AVIF ëŒ€ì²´)');
                    showFormatFallbackMessage('AVIF', 'JPEG');
                }
            }
        } else if (selectedFormat === 'webp') {
            console.log('ğŸ” WebP ì§€ì› í™•ì¸ ì¤‘...');
            formatSupported = isFormatSupported('image/webp');
            if (formatSupported) {
                compressedImageData = window.croppedCanvas.toDataURL('image/webp', quality);
                console.log('âœ… WebP í˜•ì‹ìœ¼ë¡œ ì••ì¶• ì„±ê³µ');
            } else {
                console.log('âš ï¸ WebP ë¯¸ì§€ì› - JPEG ì‚¬ìš©');
                compressedImageData = window.croppedCanvas.toDataURL('image/jpeg', quality);
                actualFormat = 'jpeg';
                console.log('âœ… JPEG í˜•ì‹ìœ¼ë¡œ ì••ì¶• ì„±ê³µ (WebP ëŒ€ì²´)');
                showFormatFallbackMessage('WebP', 'JPEG');
            }
        } else {
            // JPEGëŠ” ëª¨ë“  ë¸Œë¼ìš°ì €ì—ì„œ ì§€ì›
            compressedImageData = window.croppedCanvas.toDataURL('image/jpeg', quality);
            console.log('âœ… JPEG í˜•ì‹ìœ¼ë¡œ ì••ì¶• ì„±ê³µ');
        }
        
        // ë°ì´í„° ìœ íš¨ì„± ê²€ì¦
        if (!compressedImageData || !compressedImageData.startsWith('data:image/')) {
            throw new Error('ì••ì¶•ëœ ì´ë¯¸ì§€ ë°ì´í„°ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤');
        }
        
        // í˜„ì¬ í˜•ì‹ í‘œì‹œ ì—…ë°ì´íŠ¸
        if (elements.currentFormat) {
            elements.currentFormat.textContent = actualFormat.toUpperCase();
        }
        
        // ìµœì¢… ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
        if (elements.finalPreviewImage) {
            elements.finalPreviewImage.src = compressedImageData;
            elements.finalPreviewImage.onload = function() {
                console.log('âœ… ìµœì¢… ë¯¸ë¦¬ë³´ê¸° ì´ë¯¸ì§€ ë¡œë“œ ì™„ë£Œ');
            };
            elements.finalPreviewImage.onerror = function() {
                console.error('âŒ ìµœì¢… ë¯¸ë¦¬ë³´ê¸° ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨');
            };
        }
        
        // ì••ì¶• ì •ë³´ ì—…ë°ì´íŠ¸
        updateCompressionInfo(compressedImageData, actualFormat);
        
        // ì••ì¶•ëœ ë°ì´í„° ë° í˜•ì‹ ì €ì¥
        window.compressedImageData = compressedImageData;
        window.selectedImageFormat = actualFormat;
        
        console.log('âœ… ì••ì¶• ì²˜ë¦¬ ì™„ë£Œ - í˜•ì‹:', actualFormat.toUpperCase(), 'ë°ì´í„° í¬ê¸°:', Math.round(compressedImageData.length / 1024) + 'KB');
        
    } catch (error) {
        console.error('âŒ ì••ì¶• ì²˜ë¦¬ ì˜¤ë¥˜:', error);
        
        // ì˜¤ë¥˜ ì‹œ ì•ˆì „í•œ JPEG í´ë°±
        try {
            const fallbackData = window.croppedCanvas.toDataURL('image/jpeg', 0.8);
            if (elements.finalPreviewImage) {
                elements.finalPreviewImage.src = fallbackData;
            }
            updateCompressionInfo(fallbackData, 'jpeg');
            window.compressedImageData = fallbackData;
            window.selectedImageFormat = 'jpeg';
            
            console.log('ğŸ”„ JPEG í´ë°± ì²˜ë¦¬ ì™„ë£Œ');
            showFormatFallbackMessage(selectedFormat.toUpperCase(), 'JPEG');
        } catch (fallbackError) {
            console.error('âŒ í´ë°± ì²˜ë¦¬ë„ ì‹¤íŒ¨:', fallbackError);
            alert('ì´ë¯¸ì§€ ì••ì¶• ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
        }
    }
}

// ì„ íƒëœ ì´ë¯¸ì§€ í˜•ì‹ ê°€ì ¸ì˜¤ê¸° (ì›ë³¸ ë³µì›)
function getSelectedImageFormat() {
    if (elements.formatJPEG && elements.formatJPEG.checked) return 'jpeg';
    if (elements.formatWEBP && elements.formatWEBP.checked) return 'webp';
    if (elements.formatAVIF && elements.formatAVIF.checked) return 'avif';
    
    return 'webp'; // ê¸°ë³¸ê°’ì€ WebP (SEO ìµœì í™”)
}

// ë¸Œë¼ìš°ì € í˜•ì‹ ì§€ì› ì—¬ë¶€ í™•ì¸ (ê°œì„ ëœ ë²„ì „)
function isFormatSupported(mimeType) {
    // 1. ê¸°ë³¸ ë¸Œë¼ìš°ì € ì§€ì› í™•ì¸
    const canvas = document.createElement('canvas');
    canvas.width = 2;
    canvas.height = 2;
    const ctx = canvas.getContext('2d');
    
    // ì‘ì€ ì´ë¯¸ì§€ ë°ì´í„° ìƒì„±
    ctx.fillStyle = 'rgb(255, 0, 0)';
    ctx.fillRect(0, 0, 1, 1);
    ctx.fillStyle = 'rgb(0, 255, 0)';
    ctx.fillRect(1, 0, 1, 1);
    ctx.fillStyle = 'rgb(0, 0, 255)';
    ctx.fillRect(0, 1, 1, 1);
    ctx.fillStyle = 'rgb(255, 255, 255)';
    ctx.fillRect(1, 1, 1, 1);
    
    try {
        const dataURL = canvas.toDataURL(mimeType, 0.9);
        const isSupported = dataURL.startsWith(`data:${mimeType}`);
        
        console.log(`ğŸ” í˜•ì‹ ì§€ì› í™•ì¸: ${mimeType} - ${isSupported ? 'ì§€ì›ë¨' : 'ë¯¸ì§€ì›'}`);
        console.log(`ğŸ“„ DataURL ì‹œì‘: ${dataURL.substring(0, 50)}...`);
        
        return isSupported;
    } catch (e) {
        console.warn(`âš ï¸ í˜•ì‹ ì§€ì› í™•ì¸ ì˜¤ë¥˜: ${mimeType}`, e);
        return false;
    }
}

// í˜•ì‹ í´ë°± ë©”ì‹œì§€ í‘œì‹œ
function showFormatFallbackMessage(original, fallback) {
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-warning alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
    alertDiv.style.cssText = 'z-index: 10000; min-width: 300px;';
    alertDiv.innerHTML = `
        <i class="fas fa-exclamation-triangle me-2"></i>
        ${original} í˜•ì‹ì´ ì§€ì›ë˜ì§€ ì•Šì•„ ${fallback}ë¡œ ë³€í™˜ë©ë‹ˆë‹¤.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    // 5ì´ˆ í›„ ìë™ ì œê±°
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

// ìë™ ìµœì í™” ê¸°ëŠ¥
function autoOptimizeImage() {
    console.log('ğŸš€ ìë™ ìµœì í™” ì‹œì‘');
    
    // AVIFê°€ ì§€ì›ë˜ë©´ AVIF + 70% í’ˆì§ˆ ì‚¬ìš©
    if (isFormatSupported('image/avif')) {
        elements.formatAVIF.checked = true;
        elements.qualitySlider.value = 0.7;
        elements.qualityLabel.textContent = '70';
        console.log('âœ… AVIF 70% í’ˆì§ˆë¡œ ìë™ ìµœì í™”');
    } 
    // WebPê°€ ì§€ì›ë˜ë©´ WebP + 75% í’ˆì§ˆ ì‚¬ìš©
    else if (isFormatSupported('image/webp')) {
        elements.formatWEBP.checked = true;
        elements.qualitySlider.value = 0.75;
        elements.qualityLabel.textContent = '75';
        console.log('âœ… WebP 75% í’ˆì§ˆë¡œ ìë™ ìµœì í™”');
    } 
    // ë‘˜ ë‹¤ ì•ˆë˜ë©´ JPEG + 80% í’ˆì§ˆ
    else {
        elements.formatJPEG.checked = true;
        elements.qualitySlider.value = 0.8;
        elements.qualityLabel.textContent = '80';
        console.log('âœ… JPEG 80% í’ˆì§ˆë¡œ ìë™ ìµœì í™”');
    }
    
    // ì••ì¶• ì—…ë°ì´íŠ¸
    updateCompression();
    
    // ì„±ê³µ ë©”ì‹œì§€
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
    alertDiv.style.cssText = 'z-index: 10000; min-width: 300px;';
    alertDiv.innerHTML = `
        <i class="fas fa-magic me-2"></i>ìë™ ìµœì í™”ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    setTimeout(() => alertDiv.remove(), 3000);
}

// ì••ì¶• ì •ë³´ ì—…ë°ì´íŠ¸ (í˜•ì‹ ì •ë³´ í¬í•¨)
function updateCompressionInfo(compressedImageData, format) {
    if (!window.originalFile || !elements.compressionSavings) return;
    
    // ì›ë³¸ íŒŒì¼ í¬ê¸°
    const originalSize = window.originalFile.size;
    
    // ì••ì¶•ëœ íŒŒì¼ í¬ê¸° (Base64ë¥¼ Blobìœ¼ë¡œ ë³€í™˜í•˜ì—¬ ê³„ì‚°)
    const compressedSize = dataURLtoBlob(compressedImageData).size;
    
    // ì ˆì•½ë¥  ê³„ì‚°
    const savings = ((originalSize - compressedSize) / originalSize * 100).toFixed(1);
    
    // í˜•ì‹ë³„ ì˜ˆìƒ ì¶”ê°€ ì ˆì•½ë¥  í‘œì‹œ
    let formatBenefit = '';
    if (format === 'avif') {
        formatBenefit = ' (AVIFë¡œ ìµœëŒ€ ì ˆì•½)';
    } else if (format === 'webp') {
        formatBenefit = ' (WebPë¡œ íš¨ìœ¨ì  ì••ì¶•)';
    } else if (format === 'jpeg') {
        formatBenefit = ' (JPEG í˜¸í™˜ì„± ìš°ì„ )';
    }
    
    console.log('ğŸ“Š ì••ì¶• ì •ë³´:', {
        format: format.toUpperCase(),
        originalSize: formatFileSize(originalSize),
        compressedSize: formatFileSize(compressedSize),
        savings: savings + '%'
    });
    
    elements.compressionSavings.innerHTML = 
        `<div>${savings}% ì ˆì•½ (${formatFileSize(originalSize)} â†’ ${formatFileSize(compressedSize)})</div>
         <small class="text-muted">${format.toUpperCase()} í˜•ì‹${formatBenefit}</small>`;
}

// Alt í…ìŠ¤íŠ¸ ìë™ ìƒì„±
function generateAltText() {
    if (!elements.altTextInput) return;
    
    // ê¸°ë³¸ Alt í…ìŠ¤íŠ¸ ìƒì„±
    let altText = 'ì‚¬ìš©ì í”„ë¡œí•„ ì‚¬ì§„';
    
    // íŒŒì¼ëª…ì—ì„œ ì¶”ê°€ ì •ë³´ ì¶”ì¶œ
    if (window.originalFile && window.originalFile.name) {
        const fileName = window.originalFile.name.replace(/\.[^/.]+$/, ''); // í™•ì¥ì ì œê±°
        if (fileName.length > 0 && fileName !== 'image') {
            altText += ` - ${fileName}`;
        }
    }
    
    elements.altTextInput.value = altText;
    console.log('ğŸ·ï¸ Alt í…ìŠ¤íŠ¸ ìë™ ìƒì„±:', altText);
}

// ì••ì¶•ëœ ì´ë¯¸ì§€ë¥¼ ì„œë²„ì— ì €ì¥
function saveCompressedImageToServer() {
    console.log('ğŸ“¤ ìµœì¢… ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹œì‘');
    
    if (!window.compressedImageData) {
        console.error('âŒ ì••ì¶•ëœ ì´ë¯¸ì§€ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤');
        alert('ì••ì¶•ëœ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    const altText = elements.altTextInput?.value?.trim() || 'ì‚¬ìš©ì í”„ë¡œí•„ ì‚¬ì§„';
    const selectedFormat = window.selectedImageFormat || 'jpeg';
    const quality = Math.round((elements.qualitySlider?.value || 0.8) * 100);
    
    console.log('ğŸ“‹ ì—…ë¡œë“œ ì •ë³´:');
    console.log('  - Alt í…ìŠ¤íŠ¸:', altText);
    console.log('  - í˜•ì‹:', selectedFormat.toUpperCase());
    console.log('  - í’ˆì§ˆ:', quality + '%');
    console.log('  - ë°ì´í„° í¬ê¸°:', Math.round(window.compressedImageData.length / 1024) + 'KB');
    
    if (elements.buttons.saveImage) {
        setButtonLoading(elements.buttons.saveImage, true, 'ì €ì¥ ì¤‘...');
    }
    
    // Base64 ë°ì´í„°ë¥¼ Blobìœ¼ë¡œ ë³€í™˜
    let blob = dataURLtoBlob(window.compressedImageData);
    console.log('ğŸ“¦ ì´ˆê¸° Blob ìƒì„± - í¬ê¸°:', formatFileSize(blob.size), 'íƒ€ì…:', blob.type);
    
    // Blobì˜ MIME íƒ€ì… í™•ì¸ ë° íŒŒì¼ëª… ì„¤ì •
    let fileName = `profile.${selectedFormat}`;
    
    // WebPì˜ ê²½ìš° ë°ì´í„° ë¬´ê²°ì„± í™•ì¸ (ì¬ìƒì„±í•˜ì§€ ì•ŠìŒ)
    if (selectedFormat === 'webp') {
        fileName = 'profile.webp';
        console.log('ğŸ“ WebP Blob ì›ë³¸ ì‚¬ìš© - type:', blob.type, 'fileName:', fileName, 'size:', blob.size);
        
        // WebP ë°ì´í„° ë¬´ê²°ì„± ê°„ë‹¨ ê²€ì¦
        if (blob.type !== 'image/webp') {
            console.warn('âš ï¸ WebP Blob íƒ€ì… ë¶ˆì¼ì¹˜:', blob.type);
        }
        
        if (blob.size < 100) {
            console.error('âŒ WebP Blob í¬ê¸° ë„ˆë¬´ ì‘ìŒ:', blob.size);
        }
    }
    
    const formData = new FormData();
    formData.append('croppedImage', blob, fileName);
    formData.append('altText', altText);
    formData.append('format', selectedFormat);
    formData.append('quality', quality.toString());
    
    console.log('ğŸ“¤ FormData ì „ì†¡ ì‹œì‘...');
    
    fetch('/member/myinfo/crop-image/save', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        console.log('ğŸ“¨ ì„œë²„ ì‘ë‹µ ìˆ˜ì‹ :', response.status, response.statusText);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (elements.buttons.saveImage) {
            setButtonLoading(elements.buttons.saveImage, false);
        }
        
        console.log('ğŸ“„ ì„œë²„ ì‘ë‹µ ë°ì´í„° (ì „ì²´):', data);
        console.log('ğŸ“„ success ê°’:', data.success, '(íƒ€ì…:', typeof data.success, ')');
        console.log('ğŸ“„ message ê°’:', data.message);
        
        if (data.success === true) {
            console.log('âœ… ì„±ê³µ ì¡°ê±´ ì¶©ì¡±ë¨');
            
            // ìµœì¢… ì™„ë£Œ ë¯¸ë¦¬ë³´ê¸° ì„¤ì •
            if (elements.finalPreview) {
                elements.finalPreview.src = window.compressedImageData;
            }
            
            // ì„±ê³µ ì‹œ ì™„ë£Œ ë‹¨ê³„ í‘œì‹œ
            goToCompleteStep();
            console.log('âœ… í”„ë¡œí•„ ì´ë¯¸ì§€ ì €ì¥ ì„±ê³µ');
            
            // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
            showSuccessMessage('í”„ë¡œí•„ ì´ë¯¸ì§€ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
            
        } else {
            console.error('âŒ ì‹¤íŒ¨ ì¡°ê±´ - success:', data.success, 'message:', data.message);
            console.error('âŒ ì„œë²„ì—ì„œ ì‹¤íŒ¨ ì‘ë‹µ ë˜ëŠ” success ê°’ì´ trueê°€ ì•„ë‹˜');
            
            // ë” ìƒì„¸í•œ ë””ë²„ê¹… ì •ë³´
            if (data.hasOwnProperty('success')) {
                console.error('âŒ success ì†ì„± ì¡´ì¬í•˜ì§€ë§Œ ê°’ì´', data.success);
            } else {
                console.error('âŒ success ì†ì„±ì´ ì‘ë‹µì— ì—†ìŒ');
            }
            
            alert(data.message || 'ì´ë¯¸ì§€ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    })
    .catch(error => {
        if (elements.buttons.saveImage) {
            setButtonLoading(elements.buttons.saveImage, false);
        }
        console.error('âŒ ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
        alert('ì´ë¯¸ì§€ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
    });
}

// ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
function showSuccessMessage(message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
    alertDiv.style.cssText = 'z-index: 10000; min-width: 350px;';
    alertDiv.innerHTML = `
        <i class="fas fa-check-circle me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    // 5ì´ˆ í›„ ìë™ ì œê±°
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

// Base64ë¥¼ Blobìœ¼ë¡œ ë³€í™˜
function dataURLtoBlob(dataurl) {
    const arr = dataurl.split(',');
    const mime = arr[0].match(/:(.*?);/)[1];
    const bstr = atob(arr[1]);
    let n = bstr.length;
    const u8arr = new Uint8Array(n);
    while (n--) {
        u8arr[n] = bstr.charCodeAt(n);
    }
    return new Blob([u8arr], { type: mime });
}

// íŒŒì¼ í¬ê¸° í¬ë§·íŒ…
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// ì„œë²„ì— í¬ë¡­ëœ ì´ë¯¸ì§€ ì €ì¥
function saveImageToServer(compressedImageData, altText) {
    const formData = new FormData();
    formData.append('croppedImage', compressedImageData);
    formData.append('altText', altText);
    
    console.log('ğŸ“¤ ì„œë²„ ì—…ë¡œë“œ ì‹œì‘ - Alt í…ìŠ¤íŠ¸:', altText);
    
    fetch('/member/myinfo/crop-image/save', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        setButtonLoading(elements.buttons.cropAndSave, false);
        
        if (data.success) {
            // ìµœì¢… ë¯¸ë¦¬ë³´ê¸° ì„¤ì •
            if (elements.finalPreview) {
                elements.finalPreview.src = compressedImageData;
            }
            
            // ì„±ê³µ ì‹œ ì™„ë£Œ ë‹¨ê³„ í‘œì‹œ
            goToCompleteStep();
            console.log('âœ… í”„ë¡œí•„ ì´ë¯¸ì§€ ì €ì¥ ì„±ê³µ');
            
        } else {
            alert(data.message || 'ì´ë¯¸ì§€ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    })
    .catch(error => {
        setButtonLoading(elements.buttons.cropAndSave, false);
        console.error('ì €ì¥ ì˜¤ë¥˜:', error);
        alert('ì´ë¯¸ì§€ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
}

// ë‹¨ê³„ ì´ë™ í•¨ìˆ˜ë“¤
function goToUploadStep() {
    hideAllSections();
    if (elements.uploadSection) elements.uploadSection.style.display = 'block';
    updateStepIndicator(1);
    
    // ì „ì²´ ì´ˆê¸°í™”
    if (elements.imageInput) elements.imageInput.value = '';
    if (cropper) {
        cropper.destroy();
        cropper = null;
    }
    originalImageData = null;
    originalImage = null;
    window.croppedCanvas = null;
    window.originalFile = null;
    window.compressedImageData = null;
}

function goToCropStep() {
    hideAllSections();
    if (elements.cropSection) elements.cropSection.style.display = 'block';
    updateStepIndicator(2);
}

function goToCompleteStep() {
    hideAllSections();
    if (elements.completeSection) elements.completeSection.style.display = 'block';
    updateStepIndicator(4);
}

// ëª¨ë“  ì„¹ì…˜ ìˆ¨ê¸°ê¸°
function hideAllSections() {
    if (elements.uploadSection) elements.uploadSection.style.display = 'none';
    if (elements.cropSection) elements.cropSection.style.display = 'none';
    if (elements.compressionSection) elements.compressionSection.style.display = 'none';
    if (elements.completeSection) elements.completeSection.style.display = 'none';
}

// ë‹¨ê³„ í‘œì‹œê¸° ì—…ë°ì´íŠ¸
function updateStepIndicator(currentStep) {
    // ëª¨ë“  ë‹¨ê³„ ì´ˆê¸°í™”
    Object.values(elements.steps).forEach(step => {
        if (step) {
            step.classList.remove('active', 'completed');
        }
    });
    
    // í˜„ì¬ ë‹¨ê³„ê¹Œì§€ í™œì„±í™”
    for (let i = 1; i <= currentStep; i++) {
        const step = elements.steps[`step${i}`];
        if (step) {
            if (i === currentStep) {
                step.classList.add('active');
            } else {
                step.classList.add('completed');
            }
        }
    }
}

// ë²„íŠ¼ ë¡œë”© ìƒíƒœ ì„¤ì •
function setButtonLoading(button, isLoading, loadingText = 'ì²˜ë¦¬ ì¤‘...') {
    if (!button) return;
    
    if (isLoading) {
        button.disabled = true;
        button.classList.add('loading');
        button.setAttribute('data-original-text', button.innerHTML);
        button.innerHTML = `<i class="fas fa-spinner fa-spin me-1"></i>${loadingText}`;
    } else {
        button.disabled = false;
        button.classList.remove('loading');
        const originalText = button.getAttribute('data-original-text');
        if (originalText) {
            button.innerHTML = originalText;
        }
    }
}
</script>

<!-- ìŠ¤íƒ€ì¼ ì¶”ê°€ -->
<style>
/* ë‹¨ê³„ í‘œì‹œê¸° ìŠ¤íƒ€ì¼ */
.steps-indicator {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-bottom: 30px;
}

.step-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
    z-index: 2;
}

.step-circle {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: #e9ecef;
    border: 3px solid #dee2e6;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #6c757d;
    font-size: 18px;
    transition: all 0.3s ease;
    margin-bottom: 8px;
}

.step-item.active .step-circle {
    background: #007bff;
    border-color: #007bff;
    color: white;
    transform: scale(1.1);
    box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
}

.step-item.completed .step-circle {
    background: #28a745;
    border-color: #28a745;
    color: white;
}

.step-label {
    font-size: 12px;
    color: #6c757d;
    font-weight: 500;
    text-align: center;
    margin-top: 5px;
}

.step-item.active .step-label {
    color: #007bff;
    font-weight: 600;
}

/* SEO ìµœì í™” ê¸°ëŠ¥ ìŠ¤íƒ€ì¼ */
.keyword-suggestions {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
}

.keyword-group {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 5px;
}

.keyword-btn {
    font-size: 0.875rem;
    padding: 5px 10px;
    border-radius: 15px;
    transition: all 0.2s ease;
    cursor: pointer;
}

.keyword-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}

.keyword-btn.btn-success {
    animation: keywordClick 0.5s ease;
}

@keyframes keywordClick {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

.seo-optimization-section {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 10px;
    padding: 20px;
    border: 1px solid #dee2e6;
}

.seo-tips {
    border-left: 4px solid #17a2b8;
    background: rgba(23, 162, 184, 0.1);
}

#profileNameInput {
    border-radius: 8px;
}

#previewProfileName {
    color: #17a2b8;
    background: rgba(23, 162, 184, 0.1);
    padding: 2px 6px;
    border-radius: 4px;
    font-family: 'Courier New', monospace;
}

.input-group .btn {
    border-radius: 0 8px 8px 0;
}

.form-label {
    font-weight: 600;
    color: #495057;
}

/* Cropper.js ê°€ì‹œì„± ê°œì„  */
.cropper-center::before,
.cropper-center::after {
    background-color: #007bff !important;
    opacity: 0.8 !important;
    box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.8) !important;
}

.cropper-line {
    background-color: #007bff !important;
    opacity: 0.6 !important;
}

.cropper-point {
    background-color: #007bff !important;
    opacity: 0.8 !important;
    width: 8px !important;
    height: 8px !important;
    border-radius: 50% !important;
    box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.8) !important;
}

.step-item.completed .step-label {
    color: #28a745;
    font-weight: 600;
}

.step-connector {
    width: 80px;
    height: 3px;
    background: #dee2e6;
    margin: 0 10px;
    margin-top: -25px;
    z-index: 1;
    transition: background 0.3s ease;
}

.step-item.completed + .step-connector {
    background: #28a745;
}

/* ì—…ë¡œë“œ ì˜ì—­ ìŠ¤íƒ€ì¼ */
.upload-area {
    border: 2px dashed #dee2e6;
    border-radius: 12px;
    padding: 40px 20px;
    text-align: center;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    transition: all 0.3s ease;
    cursor: pointer;
}

.upload-area:hover {
    border-color: #007bff;
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,123,255,0.15);
}

.upload-icon i {
    animation: float 3s ease-in-out infinite;
}

@keyframes float {
    0%, 100% { transform: translateY(0px); }
    50% { transform: translateY(-10px); }
}

.crop-container, .crop-preview-panel {
    background: #fff;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.crop-image-container {
    border-radius: 8px;
    overflow: hidden;
    background: #f8f9fa;
    min-height: 300px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.image-info-panel {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    border: 1px solid #e9ecef;
}

.zoom-indicator {
    background: rgba(0,0,0,0.8);
    color: white;
    padding: 8px 12px;
    border-radius: 20px;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 9999;
    animation: fadeInOut 0.3s ease;
}

@keyframes fadeInOut {
    from { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
    to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
}

.crop-actions {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 20px;
    border: 1px solid #e9ecef;
}

/* 3ë‹¨ê³„ ì••ì¶• ì„¹ì…˜ */
.compression-section {
    padding: 20px 0;
}

.final-preview-panel, .compression-settings {
    background: #fff;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.final-image-container {
    text-align: center;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    display: inline-block;
}

.compression-info {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    border: 1px solid #e9ecef;
    text-align: center;
}

.compression-savings {
    font-size: 18px;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.8; }
}

/* Alt í…ìŠ¤íŠ¸ ì„¹ì…˜ */
.alt-text-section {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 8px;
    padding: 15px;
}

.alt-text-section .form-label {
    color: #856404;
    font-weight: 600;
}

/* ìŠ¬ë¼ì´ë” ìŠ¤íƒ€ì¼ */
.form-range {
    appearance: none;
    background: transparent;
    cursor: pointer;
    height: 6px;
}

.form-range::-webkit-slider-track {
    background: #dee2e6;
    height: 6px;
    border-radius: 3px;
}

.form-range::-webkit-slider-thumb {
    appearance: none;
    height: 20px;
    width: 20px;
    border-radius: 50%;
    background: #007bff;
    cursor: pointer;
    border: 2px solid #fff;
    box-shadow: 0 2px 6px rgba(0,123,255,0.3);
    transition: all 0.2s ease;
}

.form-range::-webkit-slider-thumb:hover {
    background: #0056b3;
    transform: scale(1.1);
    box-shadow: 0 4px 12px rgba(0,123,255,0.5);
}

.final-actions {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 20px;
    border: 1px solid #e9ecef;
}

.complete-section {
    text-align: center;
    padding: 40px 20px;
}

.success-icon {
    animation: bounceIn 0.6s ease;
}

@keyframes bounceIn {
    0% { transform: scale(0.3); opacity: 0; }
    50% { transform: scale(1.05); }
    70% { transform: scale(0.9); }
    100% { transform: scale(1); opacity: 1; }
}

/* Cropper.js ê°€ì‹œì„± ê°œì„  (ì¤‘ì•™ ì‹­ìê°€ë¥¼ íŒŒë€ìƒ‰ìœ¼ë¡œ) */
.cropper-center::before,
.cropper-center::after {
    background-color: #007bff !important;
    opacity: 0.8 !important;
    box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.8) !important;
}

.cropper-line {
    background-color: #007bff !important;
    opacity: 0.6 !important;
}

.cropper-point {
    background-color: #007bff !important;
    opacity: 0.8 !important;
    width: 8px !important;
    height: 8px !important;
    border: 2px solid #ffffff !important;
    border-radius: 50% !important;
    box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3) !important;
}

.cropper-point:hover {
    background-color: #0056b3 !important;
    opacity: 1 !important;
    transform: scale(1.2) !important;
}

.cropper-face {
    background-color: rgba(0, 123, 255, 0.1) !important;
}

.cropper-crop-box {
    border: 2px solid #007bff !important;
    box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.5) !important;
}

/* íŒŒì¼ëª… ë³€í™˜ UI ìŠ¤íƒ€ì¼ */
.filename-section {
    background: linear-gradient(135deg, #e3f2fd 0%, #f8f9fa 100%);
    border: 1px solid #bbdefb;
    border-radius: 10px;
    padding: 20px;
}

.filename-section h6 {
    color: #1976d2;
    font-weight: 600;
}

.keyword-suggestions {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
    border: 1px solid #e9ecef;
}

.keyword-group {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 5px;
}

.keyword-btn {
    font-size: 0.875rem;
    padding: 5px 10px;
    border-radius: 15px;
    transition: all 0.2s ease;
    cursor: pointer;
}

.keyword-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}

.keyword-btn.btn-success {
    animation: keywordClick 0.5s ease;
}

@keyframes keywordClick {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

#previewProfileName {
    color: #1976d2;
    background: rgba(25, 118, 210, 0.1);
    padding: 2px 6px;
    border-radius: 4px;
    font-family: 'Courier New', monospace;
}

.filename-section .input-group .btn {
    border-radius: 0 8px 8px 0;
}

.filename-section .form-label {
    font-weight: 600;
    color: #495057;
}
</style>

</body>
</html>