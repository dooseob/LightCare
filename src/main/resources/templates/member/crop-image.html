<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head th:replace="~{layout/header :: header}">
    <title>프로필 이미지 크롭 - CareLink</title>
</head>
<body class="d-flex flex-column min-vh-100 pt-5">
<nav th:replace="~{layout/header :: navbar}"></nav>

<div th:replace="~{layout/header :: messages}"></div>

<main class="flex-grow-1">
    <div class="container mt-4">
        <!-- 브레드크럼 -->
        <nav aria-label="breadcrumb" class="mb-4">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">홈</a></li>
                <li class="breadcrumb-item"><a href="/member/myinfo">마이페이지</a></li>
                <li class="breadcrumb-item active" aria-current="page">프로필 이미지 크롭</li>
            </ol>
        </nav>
        
        <div class="row justify-content-center">
            <div class="col-12 col-lg-10">
                <div class="card shadow">
                    <div class="card-body p-4">
                        <div class="text-center mb-4">
                            <h3 class="card-title fw-bold text-primary">
                                <i class="fas fa-crop me-2"></i>
                                프로필 이미지 크롭
                            </h3>
                            <p class="text-muted">증명사진 비율(3:4)에 맞춰 프로필 사진을 조절하세요</p>
                        </div>

                        <!-- 단계별 진행 표시 -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="progress-steps d-flex justify-content-between">
                                    <div class="step active" id="step1">
                                        <div class="step-circle">1</div>
                                        <div class="step-label">이미지 업로드</div>
                                    </div>
                                    <div class="step" id="step2">
                                        <div class="step-circle">2</div>
                                        <div class="step-label">크롭 조절</div>
                                    </div>
                                    <div class="step" id="step3">
                                        <div class="step-circle">3</div>
                                        <div class="step-label">저장 완료</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 1단계: 이미지 업로드 -->
                        <div id="uploadSection">
                            <div class="upload-area text-center p-5 border border-2 border-dashed rounded">
                                <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                <h5 class="text-muted">프로필 이미지를 업로드하세요</h5>
                                <p class="text-muted mb-3">JPG, PNG 파일만 가능 (SEO 최적화를 위해 자동 압축됩니다)</p>
                                <input type="file" id="imageInput" accept="image/jpeg,image/png" style="display: none;" data-image-compressor='{"quality": 0.9, "maxWidth": 2048, "maxHeight": 2048}'>
                                <button type="button" class="btn btn-primary" id="fileSelectBtn">
                                    <i class="fas fa-folder-open me-2"></i>파일 선택
                                </button>
                            </div>
                        </div>

                        <!-- 2단계: 크롭 조절 -->
                        <div id="cropSection" style="display: none;">
                            <div class="row">
                                <div class="col-lg-8">
                                    <div class="crop-container">
                                        <div class="crop-area border rounded p-2" style="height: 500px; overflow: hidden; position: relative; background: #f8f9fa;">
                                            <img id="cropImage" style="max-width: 100%; max-height: 100%; display: none;">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-4">
                                    <!-- 조절 컨트롤 -->
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">
                                                <i class="fas fa-cog me-1"></i>이미지 조절
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <label class="form-label">확대/축소</label>
                                                <div class="d-grid gap-2">
                                                    <button type="button" class="btn btn-sm btn-outline-success" id="zoomIn">
                                                        <i class="fas fa-search-plus me-1"></i>확대
                                                    </button>
                                                    <button type="button" class="btn btn-sm btn-outline-success" id="zoomOut">
                                                        <i class="fas fa-search-minus me-1"></i>축소
                                                    </button>
                                                    <button type="button" class="btn btn-sm btn-outline-info" id="resetZoom">
                                                        <i class="fas fa-undo me-1"></i>원래크기
                                                    </button>
                                                </div>
                                            </div>
                                            
                                            <!-- 미리보기 -->
                                            <div class="mb-3">
                                                <label class="form-label">미리보기</label>
                                                <div class="preview-container text-center">
                                                    <canvas id="previewCanvas" width="90" height="120" 
                                                            style="border: 2px solid #dee2e6; border-radius: 8px; background: #f8f9fa;"></canvas>
                                                    <small class="text-muted d-block mt-1">90x120px (3:4 증명사진)</small>
                                                </div>
                                            </div>

                                            <div class="alert alert-info">
                                                <h6><i class="fas fa-info-circle me-1"></i>사용법</h6>
                                                <ul class="small mb-0">
                                                    <li>마우스 휠로 확대/축소 (한계점에서 페이지 스크롤)</li>
                                                    <li>이미지를 드래그하여 이동</li>
                                                    <li>크롭 영역을 드래그하여 조절</li>
                                                </ul>
                                            </div>
                                            
                                            <!-- 줌 레벨 표시 -->
                                            <div class="zoom-indicator mt-2" id="zoomIndicator" style="display: none;">
                                                <small class="text-muted">
                                                    <i class="fas fa-search me-1"></i>
                                                    <span id="zoomLevel">100%</span>
                                                    <span id="zoomStatus" class="ms-2"></span>
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="text-center mt-4">
                                <button type="button" class="btn btn-secondary me-2" id="backToUpload">
                                    <i class="fas fa-arrow-left me-1"></i>다시 업로드
                                </button>
                                <button type="button" class="btn btn-success" id="cropAndSave">
                                    <i class="fas fa-check me-1"></i>크롭 적용 및 저장
                                </button>
                            </div>
                        </div>

                        <!-- 3단계: 완료 -->
                        <div id="completeSection" style="display: none;">
                            <div class="text-center">
                                <i class="fas fa-check-circle fa-4x text-success mb-3"></i>
                                <h4 class="text-success">프로필 이미지가 저장되었습니다!</h4>
                                <p class="text-muted mb-4">새로운 프로필 사진이 적용되었습니다.</p>
                                
                                <div class="final-preview mb-4">
                                    <img id="finalPreview" class="img-thumbnail" style="width: 90px; height: 120px; object-fit: cover;">
                                </div>
                                
                                <div class="d-flex justify-content-center gap-2">
                                    <a href="/member/myinfo/edit" class="btn btn-primary">
                                        <i class="fas fa-user me-1"></i>마이페이지로 돌아가기
                                    </a>
                                    <button type="button" class="btn btn-outline-secondary" id="cropAnother">
                                        <i class="fas fa-plus me-1"></i>다른 이미지 크롭하기
                                    </button>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<footer th:replace="~{layout/footer :: footer}"></footer>

<div th:replace="~{layout/footer :: scripts}"></div>

<!-- Cropper.js 라이브러리로 교체 (더 안정적인 라이브러리) -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>

<!-- 프로필 이미지 크롭 전용 JavaScript -->
<script src="/js/crop-image.js"></script>
<!-- 이미지 압축 라이브러리 -->
<link rel="stylesheet" href="/css/image-compressor.css">
<script src="/js/image-compressor.js"></script>

<style>
.progress-steps {
    position: relative;
}

.progress-steps::before {
    content: '';
    position: absolute;
    top: 20px;
    left: 50px;
    right: 50px;
    height: 2px;
    background: #dee2e6;
    z-index: 1;
}

.step {
    text-align: center;
    position: relative;
    z-index: 2;
    flex: 1;
}

.step-circle {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #dee2e6;
    color: #6c757d;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 8px;
    font-weight: bold;
    transition: all 0.3s ease;
}

.step.active .step-circle,
.step.completed .step-circle {
    background: #0d6efd;
    color: white;
}

.step.completed .step-circle {
    background: #198754;
}

.step-label {
    font-size: 0.875rem;
    color: #6c757d;
    font-weight: 500;
}

.step.active .step-label,
.step.completed .step-label {
    color: #212529;
    font-weight: 600;
}

.upload-area {
    cursor: pointer;
    transition: all 0.3s ease;
}

.upload-area:hover {
    border-color: #0d6efd !important;
    background-color: #f8f9ff;
}

.crop-area {
    background-image: 
        linear-gradient(45deg, #f8f9fa 25%, transparent 25%), 
        linear-gradient(-45deg, #f8f9fa 25%, transparent 25%), 
        linear-gradient(45deg, transparent 75%, #f8f9fa 75%), 
        linear-gradient(-45deg, transparent 75%, #f8f9fa 75%);
    background-size: 20px 20px;
    background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
}

.preview-container {
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 8px;
}

#cropImage {
    cursor: move;
}

/* 로딩 애니메이션 */
.btn.loading {
    position: relative;
    color: transparent !important;
}

.btn.loading::after {
    content: '';
    position: absolute;
    width: 16px;
    height: 16px;
    top: 50%;
    left: 50%;
    margin-left: -8px;
    margin-top: -8px;
    border: 2px solid transparent;
    border-top-color: currentColor;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Croppr.js 비율 고정 강화 */
.croppr-container .croppr-region {
    /* 3:4 비율 강제 적용 */
    aspect-ratio: 3 / 4 !important;
    /* 세로가 더 긴 형태로 강제 설정 */
    min-width: 90px !important;
    min-height: 120px !important;
}

.croppr-container .croppr-handle {
    /* 기본 핸들 스타일 */
    background: #0d6efd !important;
    border: 2px solid white !important;
    width: 12px !important;
    height: 12px !important;
    cursor: nw-resize !important;
}

/* 모든 핸들을 대각선 리사이즈로 설정 */
.croppr-container .croppr-handle.ord-n,
.croppr-container .croppr-handle.ord-s {
    cursor: ns-resize !important;
}

.croppr-container .croppr-handle.ord-e,
.croppr-container .croppr-handle.ord-w {
    cursor: ew-resize !important;
}

.croppr-container .croppr-handle.ord-nw,
.croppr-container .croppr-handle.ord-ne,
.croppr-container .croppr-handle.ord-sw,
.croppr-container .croppr-handle.ord-se {
    cursor: nwse-resize !important;
}

/* 크롭 영역 시각적 개선 */
.croppr-container .croppr-region {
    border: 2px solid #0d6efd !important;
    background: rgba(13, 110, 253, 0.1) !important;
}

/* 크롭 영역 강제 비율 적용 */
.croppr-container {
    position: relative !important;
}

.croppr-container .croppr-region::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    aspect-ratio: 3 / 4;
    pointer-events: none;
    z-index: 1;
}
</style>

</body>
</html>