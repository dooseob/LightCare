<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head th:replace="~{layout/header :: header}">
    <title>리뷰 작성 - CareLink</title>
</head>
<body class="d-flex flex-column min-vh-100 pt-5">
    <!-- 네비게이션 바 -->
    <nav th:replace="~{layout/header :: navbar}"></nav>
    
    <!-- 메시지 표시 -->
    <div th:replace="~{layout/header :: messages}"></div>

    <!-- 메인 콘텐츠 -->
    <main class="flex-grow-1">
        <div class="container py-4">
            <!-- 브레드크럼 -->
            <nav aria-label="breadcrumb" class="mb-4">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/">홈</a></li>
                    <li class="breadcrumb-item"><a href="/facility/search">시설 찾기</a></li>
                    <li class="breadcrumb-item"><a href="/review">시설 리뷰</a></li>
                    <li class="breadcrumb-item active" aria-current="page">리뷰 작성</li>
                </ol>
            </nav>

            <div class="row justify-content-center">
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h4 class="mb-0">
                                <i class="fas fa-star me-2"></i>시설 리뷰 작성
                            </h4>
                        </div>
                        <div class="card-body">
                            <form th:action="@{/review/write}" method="post" th:object="${reviewDTO}" id="reviewForm" enctype="multipart/form-data">
                                <!-- 시설 ID (hidden) -->
                                <input type="hidden" th:field="*{facilityId}" id="facilityId">
                                
                                <!-- 시설 선택 -->
                                <div class="mb-4" th:if="${reviewDTO.facilityId == null}">
                                    <label class="form-label fw-bold">시설 선택 *</label>
                                    <select class="form-select" name="facilityId" id="facilitySelect" required>
                                        <option value="">시설을 선택해주세요</option>
                                        <option th:each="facility : ${facilityList}" 
                                                th:value="${facility.facilityId}" 
                                                th:text="${facility.facilityName + ' (' + facility.address + ')'}"
                                                th:selected="${facility.facilityId == reviewDTO.facilityId}"
                                                th:data-status="${facility.status}"
                                                th:disabled="${!facility.normalStatus}">
                                            시설명 (주소)
                                        </option>
                                    </select>
                                    <div class="form-text text-danger" th:if="${facilityList.empty}">
                                        현재 등록된 시설이 없습니다. 시설 등록 후 리뷰를 작성해주세요.
                                    </div>
                                    <div class="form-text" th:unless="${facilityList.empty}">
                                        리뷰를 작성할 시설을 선택해주세요. 삭제되거나 승인되지 않은 시설은 선택할 수 없습니다.
                                    </div>
                                </div>

                                <!-- 선택된 시설 정보 표시 -->
                                <div class="mb-4" th:if="${reviewDTO.facilityId != null and selectedFacility != null}">
                                    <label class="form-label fw-bold">선택된 시설</label>
                                    <div class="alert" th:classappend="${selectedFacility.normalStatus ? 'alert-info' : 'alert-warning'}">
                                        <i class="fas fa-building me-2"></i>
                                        <strong>시설명:</strong> <span th:text="${selectedFacility.facilityName}">시설명</span><br>
                                        <i class="fas fa-map-marker-alt me-2"></i>
                                        <strong>주소:</strong> <span th:text="${selectedFacility.address}">주소</span><br>
                                        <i class="fas fa-tag me-2"></i>
                                        <strong>유형:</strong> <span th:text="${selectedFacility.facilityType}">유형</span><br>
                                        <i class="fas fa-phone me-2"></i>
                                        <strong>연락처:</strong> <span th:text="${selectedFacility.phone}">연락처</span><br>
                                        <i class="fas fa-info-circle me-2"></i>
                                        <strong>상태:</strong> <span th:text="${selectedFacility.status}">상태</span>
                                        <div class="mt-2 text-danger" th:if="${!selectedFacility.normalStatus}">
                                            <i class="fas fa-exclamation-triangle me-1"></i>
                                            <span th:text="${selectedFacility.statusMessage}">상태 메시지</span>
                                        </div>
                                    </div>
                                    <div class="mt-2">
                                        <a href="/review/write" class="btn btn-outline-secondary btn-sm">
                                            <i class="fas fa-sync-alt me-1"></i>다른 시설 선택
                                        </a>
                                    </div>
                                </div>

                                <!-- 시설 선택 오류 메시지 -->
                                <div class="mb-4" th:if="${reviewDTO.facilityId != null and selectedFacility == null}">
                                    <div class="alert alert-danger">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        선택한 시설을 찾을 수 없습니다. 다른 시설을 선택해주세요.
                                    </div>
                                    <div class="mt-2">
                                        <a href="/review/write" class="btn btn-primary">
                                            <i class="fas fa-redo me-1"></i>시설 다시 선택하기
                                        </a>
                                    </div>
                                </div>

                                <!-- 제목 -->
                                <div class="mb-4">
                                    <label class="form-label fw-bold">제목 *</label>
                                    <input type="text" class="form-control" th:field="*{title}" id="title"
                                           placeholder="리뷰 제목을 입력해주세요 (예: 친절한 직원들과 깨끗한 시설)" 
                                           maxlength="200" required>
                                    <div class="form-text">최대 200자까지 입력 가능합니다.</div>
                                </div>

                                <!-- 전체 평점 -->
                                <div class="mb-4">
                                    <label class="form-label fw-bold">전체 평점 *</label>
                                    <div class="rating-input-group">
                                        <div class="d-flex align-items-center">
                                            <div class="rating-stars" id="overallRating">
                                                <span class="star" data-rating="1" title="매우 불만족">★</span>
                                                <span class="star" data-rating="2" title="불만족">★</span>
                                                <span class="star" data-rating="3" title="보통">★</span>
                                                <span class="star" data-rating="4" title="만족">★</span>
                                                <span class="star" data-rating="5" title="매우 만족">★</span>
                                            </div>
                                            <span id="ratingText" class="ms-2">평점을 선택해주세요</span>
                                        </div>
                                        <input type="hidden" name="rating" id="ratingValue" th:value="${reviewDTO != null ? reviewDTO.rating : ''}" required>
                                    </div>
                                    <div class="form-text">별표를 클릭하여 평점을 선택해주세요.</div>
                                </div>

                                <!-- 세부 평점 -->
                                <div class="mb-4">
                                    <label class="form-label fw-bold">세부 평점</label>
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <div class="rating-group">
                                                <label class="form-label">서비스 품질</label>
                                                <div class="d-flex align-items-center">
                                                    <div class="rating-stars detailed-rating" data-field="serviceRating">
                                                        <span class="star" data-rating="1" title="매우 불만족">★</span>
                                                        <span class="star" data-rating="2" title="불만족">★</span>
                                                        <span class="star" data-rating="3" title="보통">★</span>
                                                        <span class="star" data-rating="4" title="만족">★</span>
                                                        <span class="star" data-rating="5" title="매우 만족">★</span>
                                                    </div>
                                                </div>
                                                <input type="hidden" name="serviceRating" class="detailed-rating-input" th:value="${reviewDTO != null ? reviewDTO.serviceRating : ''}">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="rating-group">
                                                <label class="form-label">시설 환경</label>
                                                <div class="d-flex align-items-center">
                                                    <div class="rating-stars detailed-rating" data-field="facilityRating">
                                                        <span class="star" data-rating="1" title="매우 불만족">★</span>
                                                        <span class="star" data-rating="2" title="불만족">★</span>
                                                        <span class="star" data-rating="3" title="보통">★</span>
                                                        <span class="star" data-rating="4" title="만족">★</span>
                                                        <span class="star" data-rating="5" title="매우 만족">★</span>
                                                    </div>
                                                </div>
                                                <input type="hidden" name="facilityRating" class="detailed-rating-input" th:value="${reviewDTO != null ? reviewDTO.facilityRating : ''}">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="rating-group">
                                                <label class="form-label">직원 친절도</label>
                                                <div class="d-flex align-items-center">
                                                    <div class="rating-stars detailed-rating" data-field="staffRating">
                                                        <span class="star" data-rating="1" title="매우 불만족">★</span>
                                                        <span class="star" data-rating="2" title="불만족">★</span>
                                                        <span class="star" data-rating="3" title="보통">★</span>
                                                        <span class="star" data-rating="4" title="만족">★</span>
                                                        <span class="star" data-rating="5" title="매우 만족">★</span>
                                                    </div>
                                                </div>
                                                <input type="hidden" name="staffRating" class="detailed-rating-input" th:value="${reviewDTO != null ? reviewDTO.staffRating : ''}">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="rating-group">
                                                <label class="form-label">가격 만족도</label>
                                                <div class="d-flex align-items-center">
                                                    <div class="rating-stars detailed-rating" data-field="priceRating">
                                                        <span class="star" data-rating="1" title="매우 불만족">★</span>
                                                        <span class="star" data-rating="2" title="불만족">★</span>
                                                        <span class="star" data-rating="3" title="보통">★</span>
                                                        <span class="star" data-rating="4" title="만족">★</span>
                                                        <span class="star" data-rating="5" title="매우 만족">★</span>
                                                    </div>
                                                </div>
                                                <input type="hidden" name="priceRating" class="detailed-rating-input" th:value="${reviewDTO != null ? reviewDTO.priceRating : ''}">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-text mt-2">각 항목별로 세부 평점을 매겨주세요 (선택사항).</div>
                                </div>

                                <!-- 리뷰 내용 -->
                                <div class="mb-4">
                                    <label class="form-label fw-bold">리뷰 내용 *</label>
                                    <textarea class="form-control" rows="8" th:field="*{content}" id="content"
                                              placeholder="시설 이용 경험을 자세히 작성해주세요.&#10;&#10;예시:&#10;- 시설의 장점과 단점&#10;- 직원들의 서비스 품질&#10;- 시설 환경과 청결도&#10;- 다른 이용자들에게 도움이 될 정보" 
                                              maxlength="2000" required
                                              data-rich-editor='{"height": "350px", "maxLength": 2000}'></textarea>
                                    <div class="form-text">
                                        <span id="contentLength">0</span>/2000자 (최소 10자 이상 작성해주세요)
                                    </div>
                                </div>

                                <!-- 이미지 업로드 -->
                                <div class="mb-4">
                                    <label class="form-label fw-bold">리뷰 이미지</label>
                                    <div class="image-upload-container">
                                        <div class="image-upload-area" id="imageUploadArea">
                                            <div class="upload-placeholder">
                                                <i class="fas fa-camera fa-3x text-muted mb-3"></i>
                                                <p class="text-muted mb-2">시설 리뷰 이미지를 드래그하여 업로드하거나 클릭하여 파일을 선택하세요</p>
                                                <p class="text-muted small">최대 5개, 각 파일당 5MB 이하 (JPG, PNG, GIF, WebP 지원)</p>
                                            </div>
                                            <input type="file" id="imageFiles" name="imageFiles" multiple 
                                                   accept="image/*" style="display: none;">
                                        </div>
                                        
                                        <!-- 업로드된 이미지 미리보기 -->
                                        <div id="imagePreviewContainer" class="mt-3" style="display: none;">
                                            <div class="row" id="imagePreviewList"></div>
                                        </div>
                                    </div>
                                    <div class="form-text">
                                        시설의 모습을 담은 사진을 업로드하면 다른 이용자들에게 도움이 됩니다.
                                        <span class="float-end">
                                            <span id="imageCount">0</span>/5개
                                        </span>
                                    </div>
                                </div>

                                <!-- 추천 여부 -->
                                <div class="mb-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="recommended" name="recommended">
                                        <label class="form-check-label fw-bold" for="recommended">
                                            <i class="fas fa-thumbs-up text-success me-1"></i>
                                            이 시설을 다른 분들께 추천하시겠습니까?
                                        </label>
                                    </div>
                                </div>

                                <!-- 버튼 -->
                                <div class="d-flex justify-content-between">
                                    <button type="button" class="btn btn-secondary" id="cancelBtn">
                                        <i class="fas fa-arrow-left me-1"></i>취소
                                    </button>
                                    <button type="submit" class="btn btn-primary" id="submitBtn">
                                        <i class="fas fa-save me-1"></i>리뷰 등록
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- 리뷰 작성 가이드 -->
                    <div class="card mt-4">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">
                                <i class="fas fa-lightbulb text-warning me-2"></i>리뷰 작성 가이드
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="text-success">
                                        <i class="fas fa-check-circle me-1"></i>좋은 리뷰 작성법
                                    </h6>
                                    <ul class="list-unstyled">
                                        <li><i class="fas fa-check text-success me-2"></i>실제 이용 경험을 바탕으로 작성</li>
                                        <li><i class="fas fa-check text-success me-2"></i>시설의 장단점을 구체적으로 설명</li>
                                        <li><i class="fas fa-check text-success me-2"></i>다른 이용자들에게 도움이 되는 정보 포함</li>
                                        <li><i class="fas fa-check text-success me-2"></i>객관적이고 정확한 정보 제공</li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-danger">
                                        <i class="fas fa-times-circle me-1"></i>주의사항
                                    </h6>
                                    <ul class="list-unstyled">
                                        <li><i class="fas fa-times text-danger me-2"></i>욕설이나 비방 금지</li>
                                        <li><i class="fas fa-times text-danger me-2"></i>허위 정보 작성 금지</li>
                                        <li><i class="fas fa-times text-danger me-2"></i>개인정보 노출 금지</li>
                                        <li><i class="fas fa-times text-danger me-2"></i>광고성 내용 금지</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 푸터 -->
    <div th:replace="~{layout/footer :: footer}"></div>
    
    <!-- JavaScript -->
    <div th:replace="~{layout/footer :: scripts}"></div>
    
    <!-- 리뷰 작성 전용 JavaScript -->
    <script src="/js/review-write.js"></script>
    
    <script>
        let uploadedImages = [];
        
        document.addEventListener('DOMContentLoaded', function() {
            // 이미지 업로드 초기화
            initImageUpload();
        });
        
        // 이미지 업로드 기능 초기화
        function initImageUpload() {
            const uploadArea = document.getElementById('imageUploadArea');
            const fileInput = document.getElementById('imageFiles');
            const previewContainer = document.getElementById('imagePreviewContainer');
            const previewList = document.getElementById('imagePreviewList');
            const imageCount = document.getElementById('imageCount');
            
            // 드래그 앤 드롭 이벤트
            uploadArea.addEventListener('click', () => fileInput.click());
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('dragleave', handleDragLeave);
            uploadArea.addEventListener('drop', handleDrop);
            fileInput.addEventListener('change', handleFileSelect);
            
            function handleDragOver(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            }
            
            function handleDragLeave(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            }
            
            function handleDrop(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = Array.from(e.dataTransfer.files).filter(file => file.type.startsWith('image/'));
                processFiles(files);
            }
            
            function handleFileSelect(e) {
                const files = Array.from(e.target.files);
                processFiles(files);
            }
            
            function processFiles(files) {
                if (uploadedImages.length + files.length > 5) {
                    alert('최대 5개의 이미지만 업로드할 수 있습니다.');
                    return;
                }
                
                files.forEach((file, index) => {
                    if (file.size > 5 * 1024 * 1024) {
                        alert(`${file.name} 파일이 5MB를 초과합니다.`);
                        return;
                    }
                    
                    const imageData = {
                        file: file,
                        id: Date.now() + index,
                        altText: ''
                    };
                    
                    uploadedImages.push(imageData);
                    createImagePreview(imageData);
                });
                
                updateImageCount();
                updatePreviewVisibility();
            }
            
            function createImagePreview(imageData) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const col = document.createElement('div');
                    col.className = 'col-md-4 col-sm-6 col-6';
                    col.innerHTML = `
                        <div class="image-preview-item" data-id="${imageData.id}">
                            <img src="${e.target.result}" class="img-fluid" alt="리뷰 이미지">
                            <button type="button" class="remove-image" onclick="removeImage(${imageData.id})">
                                <i class="fas fa-times"></i>
                            </button>
                            <div class="image-info">
                                <div>${imageData.file.name}</div>
                                <div>${(imageData.file.size / 1024).toFixed(1)} KB</div>
                            </div>
                            <input type="text" class="form-control form-control-sm alt-text-input mt-2" 
                                   placeholder="이미지 설명 (선택사항)" 
                                   onchange="updateAltText(${imageData.id}, this.value)">
                        </div>
                    `;
                    previewList.appendChild(col);
                };
                reader.readAsDataURL(imageData.file);
            }
        }
        
        function removeImage(imageId) {
            uploadedImages = uploadedImages.filter(img => img.id !== imageId);
            const previewItem = document.querySelector(`[data-id="${imageId}"]`).closest('.col-md-4');
            previewItem.remove();
            updateImageCount();
            updatePreviewVisibility();
        }
        
        function updateAltText(imageId, altText) {
            const image = uploadedImages.find(img => img.id === imageId);
            if (image) {
                image.altText = altText;
            }
        }
        
        function updateImageCount() {
            document.getElementById('imageCount').textContent = uploadedImages.length;
        }
        
        function updatePreviewVisibility() {
            const previewContainer = document.getElementById('imagePreviewContainer');
            previewContainer.style.display = uploadedImages.length > 0 ? 'block' : 'none';
        }
    </script>

    <style>
        /* 전체 평점 스타일 */
        #overallRating {
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        #overallRating .star {
            color: #ddd;
            transition: color 0.2s;
            cursor: pointer;
            user-select: none;
            display: inline-block;
            margin-right: 4px;
        }
        
        #overallRating .star:hover,
        #overallRating .star.active {
            color: #ffc107;
        }
        
        /* 세부 평점 스타일 */
        .detailed-rating {
            font-size: 1.2rem;
            cursor: pointer;
        }
        
        .detailed-rating .star {
            color: #ddd;
            transition: color 0.2s;
            cursor: pointer;
            user-select: none;
            display: inline-block;
            margin-right: 2px;
        }
        
        .detailed-rating .star:hover,
        .detailed-rating .star.active {
            color: #ffc107;
        }
        
        /* 별점 그룹 전용 스타일로 common.css 오버라이드 */
        .rating-input-group .rating-stars .star {
            font-size: 1.5rem !important;
            cursor: pointer !important;
            display: inline-block !important;
        }
        
        .rating-group .rating-stars .star {
            font-size: 1.2rem !important;
            cursor: pointer !important;
            display: inline-block !important;
        }
        
        /* 호버 효과 수정 */
        .detailed-rating .star:hover ~ .star {
            color: #ddd !important;
        }
        
        .detailed-rating:hover .star {
            color: #ffc107;
        }
        
        .detailed-rating .star:hover ~ .star {
            color: #ddd !important;
        }
        
        #overallRating .star:hover ~ .star {
            color: #ddd !important;
        }
        
        #overallRating:hover .star {
            color: #ffc107;
        }
        
        #overallRating .star:hover ~ .star {
            color: #ddd !important;
        }
        
        /* 평점에 대한 디버깅용 스타일 (임시) */
        .detailed-rating {
            border: 1px solid transparent;
        }
        
        .detailed-rating:hover {
            border: 1px solid #007bff;
            border-radius: 4px;
            padding: 2px;
        }
        
        /* 이미지 업로드 스타일 */
        .image-upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            background-color: #f8f9fa;
        }
        
        .image-upload-area:hover {
            border-color: #0d6efd;
            background-color: #e7f3ff;
        }
        
        .image-upload-area.dragover {
            border-color: #0d6efd;
            background-color: #e7f3ff;
            transform: scale(1.02);
        }
        
        .image-preview-item {
            position: relative;
            margin-bottom: 15px;
        }
        
        .image-preview-item img {
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
        }
        
        .image-preview-item:hover img {
            transform: scale(1.05);
        }
        
        .image-preview-item .remove-image {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            opacity: 0.9;
            transition: opacity 0.2s ease;
        }
        
        .image-preview-item .remove-image:hover {
            opacity: 1;
        }
        
        .image-preview-item .image-info {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0,0,0,0.7));
            color: white;
            padding: 10px 8px 5px;
            border-radius: 0 0 8px 8px;
            font-size: 12px;
        }
        
        .alt-text-input {
            margin-top: 5px;
        }
    </style>
    
</body>
</html> 