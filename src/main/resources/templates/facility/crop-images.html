<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head th:replace="~{layout/header :: header}">
    <title>시설 이미지 관리 - CareLink</title>
</head>
<body class="d-flex flex-column min-vh-100 pt-5">
<nav th:replace="~{layout/header :: navbar}"></nav>

<div th:replace="~{layout/header :: messages}"></div>

<main class="flex-grow-1">
    <div class="container mt-4">
        <!-- 브레드크럼 -->
        <nav aria-label="breadcrumb" class="mb-4">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">홈</a></li>
                <li class="breadcrumb-item"><a href="/facility/manage">시설 관리</a></li>
                <li class="breadcrumb-item active" aria-current="page">시설 이미지 관리</li>
            </ol>
        </nav>
        
        <div class="row justify-content-center">
            <div class="col-12 col-lg-11">
                <div class="card shadow">
                    <div class="card-body p-4">
                        <div class="text-center mb-4">
                            <h3 class="card-title fw-bold text-primary">
                                <i class="fas fa-images me-2"></i>
                                시설 이미지 관리
                            </h3>
                            <p class="text-muted">시설 사진을 16:9 비율로 조정하여 등록하세요 (최대 5장)</p>
                        </div>

                        <!-- 단계 표시기 -->
                        <div class="steps-indicator mb-4">
                            <div class="step-item active" id="step1">
                                <div class="step-circle">
                                    <i class="fas fa-upload"></i>
                                </div>
                                <div class="step-label">이미지 선택</div>
                            </div>
                            <div class="step-connector"></div>
                            <div class="step-item" id="step2">
                                <div class="step-circle">
                                    <i class="fas fa-crop-alt"></i>
                                </div>
                                <div class="step-label">비율 조절</div>
                            </div>
                            <div class="step-connector"></div>
                            <div class="step-item" id="step3">
                                <div class="step-circle">
                                    <i class="fas fa-compress-alt"></i>
                                </div>
                                <div class="step-label">압축 & SEO</div>
                            </div>
                            <div class="step-connector"></div>
                            <div class="step-item" id="step4">
                                <div class="step-circle">
                                    <i class="fas fa-check"></i>
                                </div>
                                <div class="step-label">완료</div>
                            </div>
                        </div>

                        <!-- 1단계: 파일 업로드 -->
                        <div id="uploadSection" class="upload-section">
                            <div class="upload-area" id="uploadArea">
                                <div class="upload-content">
                                    <div class="upload-icon">
                                        <i class="fas fa-cloud-upload-alt fa-3x text-primary"></i>
                                    </div>
                                    <h5 class="upload-title">시설 이미지 업로드</h5>
                                    <p class="upload-description text-muted">
                                        이미지를 드래그하여 업로드하거나 클릭하여 선택하세요
                                    </p>
                                    <div class="upload-format-info">
                                        <small class="text-muted">
                                            <i class="fas fa-info-circle me-1"></i>
                                            JPG, PNG, WebP 파일 지원 (큰 파일도 자동 압축)
                                        </small>
                                        <br>
                                        <small class="text-info">
                                            <i class="fas fa-crop-alt me-1"></i>
                                            시설 사진 비율 (16:9) 자동 조정
                                        </small>
                                        <br>
                                        <small class="text-success">
                                            <i class="fas fa-images me-1"></i>
                                            최대 5장까지 등록 가능
                                        </small>
                                    </div>
                                    <button type="button" class="btn btn-primary btn-lg mt-3" id="fileSelectBtn">
                                        <i class="fas fa-folder-open me-2"></i>파일 선택
                                    </button>
                                </div>
                            </div>
                            <input type="file" id="imageInput" accept="image/*" multiple style="display: none;">
                        </div>

                        <!-- 이미지 리스트 -->
                        <div id="imageListSection" class="mb-4" style="display: none;">
                            <h5 class="mb-3">
                                <i class="fas fa-list me-2"></i>선택된 이미지
                                <span class="badge bg-primary ms-2" id="imageCount">0</span>
                            </h5>
                            <div id="imageList" class="row g-3"></div>
                        </div>

                        <!-- 2단계: 크롭 및 조정 -->
                        <div id="cropSection" class="crop-section" style="display: none;">
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="crop-container">
                                        <h6 class="mb-3">
                                            <i class="fas fa-crop-alt me-2"></i>
                                            이미지 비율 조정
                                            <span class="badge bg-info ms-2" id="currentImageNumber">1/1</span>
                                        </h6>
                                        <div class="crop-image-container">
                                            <img id="cropImage" style="max-width: 100%; display: none;">
                                        </div>
                                        <div class="crop-controls mt-3 text-center">
                                            <div class="btn-group me-3" role="group">
                                                <button type="button" class="btn btn-outline-primary btn-sm" id="zoomInBtn">
                                                    <i class="fas fa-search-plus"></i> 확대
                                                </button>
                                                <button type="button" class="btn btn-outline-primary btn-sm" id="zoomOutBtn">
                                                    <i class="fas fa-search-minus"></i> 축소
                                                </button>
                                            </div>
                                            <div class="btn-group me-3" role="group">
                                                <button type="button" class="btn btn-outline-secondary btn-sm" id="rotateLeftBtn">
                                                    <i class="fas fa-undo"></i> 좌회전
                                                </button>
                                                <button type="button" class="btn btn-outline-secondary btn-sm" id="rotateRightBtn">
                                                    <i class="fas fa-redo"></i> 우회전
                                                </button>
                                            </div>
                                            <button type="button" class="btn btn-outline-danger btn-sm" id="resetBtn">
                                                <i class="fas fa-sync-alt"></i> 리셋
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="crop-preview-panel">
                                        <h6 class="mb-3">
                                            <i class="fas fa-eye me-2"></i>미리보기
                                        </h6>
                                        <div class="facility-preview text-center">
                                            <div class="facility-card-preview mb-3">
                                                <div class="card" style="max-width: 200px; margin: 0 auto;">
                                                    <div class="card-img-container">
                                                        <canvas id="previewCanvas" width="192" height="108" 
                                                                style="width: 100%; height: auto; border-radius: 8px;"></canvas>
                                                    </div>
                                                    <div class="card-body p-2">
                                                        <h6 class="card-title text-truncate mb-1">시설명</h6>
                                                        <small class="text-muted">시설 카드 미리보기</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- 이미지 정보 -->
                                        <div class="image-info-panel mt-3">
                                            <h6 class="mb-2">
                                                <i class="fas fa-info-circle me-2"></i>이미지 정보
                                            </h6>
                                            <div class="small">
                                                <div class="d-flex justify-content-between">
                                                    <span>비율:</span>
                                                    <span class="text-primary fw-bold">16:9</span>
                                                </div>
                                                <div class="d-flex justify-content-between">
                                                    <span>크기:</span>
                                                    <span id="imageDimensions">-</span>
                                                </div>
                                                <div class="d-flex justify-content-between">
                                                    <span>파일명:</span>
                                                    <span id="imageFileName" class="text-truncate">-</span>
                                                </div>
                                            </div>
                                            
                                            <!-- 키보드 단축키 가이드 -->
                                            <div class="mt-3 p-2 bg-light rounded">
                                                <h6 class="small mb-2">
                                                    <i class="fas fa-keyboard me-1"></i>키보드 단축키
                                                </h6>
                                                <div class="small text-muted">
                                                    <div class="row g-1">
                                                        <div class="col-6"><kbd>+/-</kbd> 확대/축소</div>
                                                        <div class="col-6"><kbd>R/L</kbd> 회전</div>
                                                        <div class="col-6"><kbd>Enter</kbd> 완료</div>
                                                        <div class="col-6"><kbd>Esc</kbd> 리셋</div>
                                                        <div class="col-12"><kbd>← →</kbd> 이미지 전환</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="crop-actions mt-4 text-center">
                                <div class="d-flex justify-content-between align-items-center">
                                    <button type="button" class="btn btn-outline-secondary" id="backToUploadBtn">
                                        <i class="fas fa-arrow-left me-2"></i>다시 선택
                                    </button>
                                    <div class="crop-navigation">
                                        <button type="button" class="btn btn-outline-primary me-2" id="prevImageBtn" style="display: none;">
                                            <i class="fas fa-chevron-left me-1"></i>이전
                                        </button>
                                        <button type="button" class="btn btn-outline-primary" id="nextImageBtn" style="display: none;">
                                            다음<i class="fas fa-chevron-right ms-1"></i>
                                        </button>
                                    </div>
                                    <button type="button" class="btn btn-primary" id="cropCurrentBtn">
                                        <i class="fas fa-crop me-2"></i>이 이미지 완료
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- 3단계: 압축 및 SEO 최적화 -->
                        <div id="compressionSection" class="compression-section" style="display: none;">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="compression-settings">
                                        <h6 class="mb-3">
                                            <i class="fas fa-compress-alt me-2"></i>이미지 압축 설정
                                        </h6>
                                        
                                        <!-- 이미지 형식 선택 -->
                                        <div class="mb-3">
                                            <label class="form-label">이미지 형식</label>
                                            <div class="btn-group w-100" role="group">
                                                <input type="radio" class="btn-check" name="imageFormat" id="formatAVIF" value="avif" checked>
                                                <label class="btn btn-outline-success btn-sm" for="formatAVIF">
                                                    <i class="fas fa-bolt me-1"></i>AVIF
                                                    <small class="d-block text-muted">용량 최소 (권장)</small>
                                                </label>
                                                
                                                <input type="radio" class="btn-check" name="imageFormat" id="formatWEBP" value="webp">
                                                <label class="btn btn-outline-primary btn-sm" for="formatWEBP">
                                                    <i class="fas fa-rocket me-1"></i>WebP
                                                    <small class="d-block text-muted">빠른 로딩</small>
                                                </label>
                                                
                                                <input type="radio" class="btn-check" name="imageFormat" id="formatJPEG" value="jpeg">
                                                <label class="btn btn-outline-secondary btn-sm" for="formatJPEG">
                                                    <i class="fas fa-check me-1"></i>JPEG
                                                    <small class="d-block text-muted">범용 호환</small>
                                                </label>
                                            </div>
                                        </div>
                                        
                                        <!-- 압축 품질 -->
                                        <div class="mb-3">
                                            <label class="form-label">
                                                압축 품질: <span id="qualityPercent">80%</span>
                                            </label>
                                            <input type="range" class="form-range" id="qualitySlider" 
                                                   min="0.3" max="1.0" step="0.1" value="0.8">
                                            <div class="d-flex justify-content-between small text-muted">
                                                <span>높은 압축</span>
                                                <span>높은 품질</span>
                                            </div>
                                        </div>
                                        
                                        <!-- 자동 최적화 -->
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" id="autoOptimize" checked>
                                            <label class="form-check-label" for="autoOptimize">
                                                <i class="fas fa-magic me-1"></i>자동 최적화
                                                <small class="d-block text-muted">브라우저별 최적 형식 자동 선택</small>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="compression-preview">
                                        <h6 class="mb-3">
                                            <i class="fas fa-eye me-2"></i>압축 결과
                                        </h6>
                                        <div class="compression-info text-center mb-3">
                                            <div class="compression-savings text-success fw-bold mb-2">
                                                <span id="compressionSavings">계산 중...</span>
                                            </div>
                                            <small class="text-muted">
                                                현재 형식: <span id="currentFormat" class="fw-bold">AVIF</span>
                                            </small>
                                        </div>
                                        
                                        <div class="final-preview-container">
                                            <img id="finalPreviewImage" class="img-fluid rounded" 
                                                 style="max-width: 100%; height: auto; border: 2px solid #dee2e6;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Alt 텍스트 -->
                            <div class="alt-text-section mt-4">
                                <h6 class="mb-3">
                                    <i class="fas fa-tag me-2"></i>SEO 최적화
                                </h6>
                                <label for="altTextInput" class="form-label">
                                    <i class="fas fa-search me-1"></i>이미지 설명 (Alt 텍스트)
                                </label>
                                <textarea class="form-control" id="altTextInput" rows="2" 
                                          placeholder="시설 이미지에 대한 설명을 입력하세요 (SEO 최적화용)"></textarea>
                                <small class="text-muted">
                                    <i class="fas fa-lightbulb me-1"></i>
                                    검색 엔진 최적화를 위한 이미지 설명입니다
                                </small>
                            </div>
                            
                            <div class="compression-actions mt-4 text-center">
                                <div class="d-flex justify-content-between">
                                    <button type="button" class="btn btn-outline-secondary" id="backToCropBtn">
                                        <i class="fas fa-arrow-left me-2"></i>크롭으로 돌아가기
                                    </button>
                                    <button type="button" class="btn btn-success" id="saveAllImagesBtn">
                                        <i class="fas fa-save me-2"></i>모든 이미지 저장
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- 4단계: 완료 -->
                        <div id="completeSection" class="complete-section text-center" style="display: none;">
                            <div class="completion-icon mb-3">
                                <i class="fas fa-check-circle fa-5x text-success"></i>
                            </div>
                            <h4 class="text-success mb-3">시설 이미지 등록 완료!</h4>
                            <p class="text-muted mb-4">시설 이미지가 성공적으로 등록되었습니다.</p>
                            
                            <div class="final-images-grid mb-4" id="finalImagesGrid">
                                <!-- 완료된 이미지들이 여기에 표시됩니다 -->
                            </div>
                            
                            <div class="final-actions">
                                <a href="/facility/manage" class="btn btn-primary me-2">
                                    <i class="fas fa-building me-2"></i>시설 관리로 돌아가기
                                </a>
                                <button type="button" class="btn btn-outline-primary" id="addMoreImagesBtn">
                                    <i class="fas fa-plus me-2"></i>이미지 더 추가
                                </button>
                            </div>
                        </div>

                        <!-- 줌 표시기 -->
                        <div id="zoomIndicator" class="zoom-indicator" style="display: none;">
                            <i class="fas fa-search-plus me-2"></i>
                            <span id="zoomLevel">100%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<footer th:replace="~{layout/footer :: footer}"></footer>

<!-- Cropper.js CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">

<!-- 고급 이미지 크롭퍼 CSS -->
<link th:href="@{/css/advanced-image-cropper.css}" rel="stylesheet">

<script>
// 전역 변수
let originalImages = [];
let currentImageIndex = 0;
let croppedImages = [];
let cropper = null;
let facilityId = null;

// DOM 요소
const elements = {
    // 섹션들
    uploadSection: document.getElementById('uploadSection'),
    cropSection: document.getElementById('cropSection'),
    compressionSection: document.getElementById('compressionSection'),
    completeSection: document.getElementById('completeSection'),
    imageListSection: document.getElementById('imageListSection'),
    
    // 업로드 관련
    uploadArea: document.getElementById('uploadArea'),
    fileSelectBtn: document.getElementById('fileSelectBtn'),
    imageInput: document.getElementById('imageInput'),
    imageList: document.getElementById('imageList'),
    imageCount: document.getElementById('imageCount'),
    
    // 크롭 관련
    cropImage: document.getElementById('cropImage'),
    previewCanvas: document.getElementById('previewCanvas'),
    currentImageNumber: document.getElementById('currentImageNumber'),
    imageDimensions: document.getElementById('imageDimensions'),
    imageFileName: document.getElementById('imageFileName'),
    
    // 버튼들
    buttons: {
        backToUpload: document.getElementById('backToUploadBtn'),
        cropCurrent: document.getElementById('cropCurrentBtn'),
        prevImage: document.getElementById('prevImageBtn'),
        nextImage: document.getElementById('nextImageBtn'),
        backToCrop: document.getElementById('backToCropBtn'),
        saveAllImages: document.getElementById('saveAllImagesBtn'),
        addMoreImages: document.getElementById('addMoreImagesBtn'),
        zoomIn: document.getElementById('zoomInBtn'),
        zoomOut: document.getElementById('zoomOutBtn'),
        rotateLeft: document.getElementById('rotateLeftBtn'),
        rotateRight: document.getElementById('rotateRightBtn'),
        reset: document.getElementById('resetBtn')
    },
    
    // 압축 관련
    formatAVIF: document.getElementById('formatAVIF'),
    formatWEBP: document.getElementById('formatWEBP'),
    formatJPEG: document.getElementById('formatJPEG'),
    qualitySlider: document.getElementById('qualitySlider'),
    qualityPercent: document.getElementById('qualityPercent'),
    autoOptimize: document.getElementById('autoOptimize'),
    altTextInput: document.getElementById('altTextInput'),
    finalPreviewImage: document.getElementById('finalPreviewImage'),
    compressionSavings: document.getElementById('compressionSavings'),
    currentFormat: document.getElementById('currentFormat'),
    
    // 단계 표시
    steps: {
        step1: document.getElementById('step1'),
        step2: document.getElementById('step2'),
        step3: document.getElementById('step3'),
        step4: document.getElementById('step4')
    },
    
    // 기타
    zoomIndicator: document.getElementById('zoomIndicator'),
    zoomLevel: document.getElementById('zoomLevel'),
    finalImagesGrid: document.getElementById('finalImagesGrid')
};

// 초기화
document.addEventListener('DOMContentLoaded', function() {
    console.log('🎬 시설 이미지 크롭퍼 초기화 시작');
    
    // URL에서 시설 ID 추출
    const pathParts = window.location.pathname.split('/');
    facilityId = pathParts[pathParts.length - 1];
    console.log('🏢 시설 ID:', facilityId);
    
    initializeEventListeners();
    setupDragAndDrop();
    console.log('✅ 초기화 완료');
});

// 이벤트 리스너 초기화
function initializeEventListeners() {
    // 파일 선택
    if (elements.fileSelectBtn) {
        elements.fileSelectBtn.addEventListener('click', () => {
            elements.imageInput.click();
        });
    }
    
    if (elements.imageInput) {
        elements.imageInput.addEventListener('change', handleMultipleImageUpload);
    }
    
    // 키보드 단축키 설정
    setupKeyboardShortcuts();
    
    // 크롭 컨트롤
    if (elements.buttons.zoomIn) {
        elements.buttons.zoomIn.addEventListener('click', () => zoomCropper(0.1));
    }
    if (elements.buttons.zoomOut) {
        elements.buttons.zoomOut.addEventListener('click', () => zoomCropper(-0.1));
    }
    if (elements.buttons.rotateLeft) {
        elements.buttons.rotateLeft.addEventListener('click', () => rotateCropper(-90));
    }
    if (elements.buttons.rotateRight) {
        elements.buttons.rotateRight.addEventListener('click', () => rotateCropper(90));
    }
    if (elements.buttons.reset) {
        elements.buttons.reset.addEventListener('click', resetCropper);
    }
    
    // 네비게이션
    if (elements.buttons.backToUpload) {
        elements.buttons.backToUpload.addEventListener('click', goToUploadStep);
    }
    if (elements.buttons.cropCurrent) {
        elements.buttons.cropCurrent.addEventListener('click', cropCurrentImage);
    }
    if (elements.buttons.prevImage) {
        elements.buttons.prevImage.addEventListener('click', goToPreviousImage);
    }
    if (elements.buttons.nextImage) {
        elements.buttons.nextImage.addEventListener('click', goToNextImage);
    }
    if (elements.buttons.backToCrop) {
        elements.buttons.backToCrop.addEventListener('click', goToCropStep);
    }
    if (elements.buttons.saveAllImages) {
        elements.buttons.saveAllImages.addEventListener('click', saveAllImages);
    }
    if (elements.buttons.addMoreImages) {
        elements.buttons.addMoreImages.addEventListener('click', addMoreImages);
    }
    
    // 압축 설정
    if (elements.qualitySlider) {
        elements.qualitySlider.addEventListener('input', updateQualityDisplay);
        elements.qualitySlider.addEventListener('change', updateCompression);
    }
    
    // 이미지 형식 선택
    ['formatAVIF', 'formatWEBP', 'formatJPEG'].forEach(formatId => {
        const element = elements[formatId];
        if (element) {
            element.addEventListener('change', updateCompression);
        }
    });
    
    if (elements.autoOptimize) {
        elements.autoOptimize.addEventListener('change', updateCompression);
    }
}

// 키보드 단축키 설정
function setupKeyboardShortcuts() {
    document.addEventListener('keydown', function(event) {
        // 입력 필드에 포커스가 있을 때는 단축키 비활성화
        if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') {
            return;
        }
        
        // 크롭퍼가 활성화되어 있을 때만 동작
        if (!cropper || elements.cropSection.style.display === 'none') {
            return;
        }
        
        switch(event.key) {
            case '+':
            case '=': // Shift 없이 누를 때
                event.preventDefault();
                zoomCropper(0.1);
                console.log('⌨️ 키보드로 확대: +');
                break;
                
            case '-':
            case '_':
                event.preventDefault();
                zoomCropper(-0.1);
                console.log('⌨️ 키보드로 축소: -');
                break;
                
            case 'r':
            case 'R':
                event.preventDefault();
                rotateCropper(90);
                console.log('⌨️ 키보드로 우회전: R');
                break;
                
            case 'l':
            case 'L':
                event.preventDefault();
                rotateCropper(-90);
                console.log('⌨️ 키보드로 좌회전: L');
                break;
                
            case 'Enter':
                event.preventDefault();
                if (elements.buttons.cropCurrent && !elements.buttons.cropCurrent.disabled) {
                    cropCurrentImage();
                    console.log('⌨️ 키보드로 크롭 완료: Enter');
                }
                break;
                
            case 'Escape':
                event.preventDefault();
                resetCropper();
                console.log('⌨️ 키보드로 리셋: Esc');
                break;
                
            case 'ArrowLeft':
                event.preventDefault();
                if (elements.buttons.prevImage && elements.buttons.prevImage.style.display !== 'none') {
                    goToPreviousImage();
                    console.log('⌨️ 키보드로 이전 이미지: ←');
                }
                break;
                
            case 'ArrowRight':
                event.preventDefault();
                if (elements.buttons.nextImage && elements.buttons.nextImage.style.display !== 'none') {
                    goToNextImage();
                    console.log('⌨️ 키보드로 다음 이미지: →');
                }
                break;
        }
    });
    
    console.log('⌨️ 키보드 단축키 설정 완료');
    console.log('   +/- : 확대/축소');
    console.log('   R/L : 우회전/좌회전');
    console.log('   Enter : 크롭 완료');
    console.log('   Esc : 리셋');
    console.log('   ←/→ : 이전/다음 이미지');
}

// 드래그 앤 드롭 설정
function setupDragAndDrop() {
    const uploadArea = elements.uploadArea;
    if (!uploadArea) return;
    
    uploadArea.addEventListener('dragover', handleDragOver);
    uploadArea.addEventListener('drop', handleDrop);
    
    // 업로드 영역 클릭 시 파일 선택
    uploadArea.addEventListener('click', (event) => {
        if (!event.target.closest('#fileSelectBtn')) {
            elements.imageInput.click();
        }
    });
}

// 다중 이미지 업로드 처리
function handleMultipleImageUpload(event) {
    console.log('📁 다중 파일 업로드 이벤트 발생');
    const files = Array.from(event.target.files);
    
    if (files.length === 0) {
        console.log('선택된 파일이 없습니다');
        return;
    }
    
    console.log(`📸 선택된 파일 수: ${files.length}`);
    
    // 최대 5장 제한
    if (files.length > 5) {
        alert('최대 5장까지만 등록할 수 있습니다.');
        return;
    }
    
    // 기존 이미지 초기화
    originalImages = [];
    croppedImages = [];
    currentImageIndex = 0;
    
    // 모든 파일 처리
    let processedCount = 0;
    files.forEach((file, index) => {
        handleSingleImageFile(file, index, () => {
            processedCount++;
            if (processedCount === files.length) {
                console.log('✅ 모든 이미지 로드 완료');
                showImageList();
                goToCropStep();
                loadCurrentImageToCropper();
            }
        });
    });
}

// 단일 이미지 파일 처리
function handleSingleImageFile(file, index, callback) {
    console.log(`🖼️ 이미지 처리 시작: ${file.name} (${index + 1})`);
    
    // 파일 타입 검증
    if (!file.type.startsWith('image/')) {
        alert(`${file.name}은(는) 이미지 파일이 아닙니다.`);
        return;
    }
    
    // 지원되는 형식 검증
    const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
    if (!allowedTypes.includes(file.type)) {
        alert(`${file.name}은(는) 지원되지 않는 형식입니다. (JPG, PNG, WebP만 지원)`);
        return;
    }
    
    // 큰 파일 안내
    if (file.size > 5 * 1024 * 1024) {
        console.log(`⚠️ 큰 파일 감지: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)}MB)`);
        showLargeFileNotice(file.size, file.name);
    }
    
    // FileReader로 이미지 로드
    const reader = new FileReader();
    reader.onload = function(e) {
        const imageData = {
            id: index,
            name: file.name,
            size: file.size,
            type: file.type,
            dataUrl: e.target.result,
            originalFile: file
        };
        
        originalImages.push(imageData);
        console.log(`✅ 이미지 로드 완료: ${file.name}`);
        
        if (callback) callback();
    };
    
    reader.onerror = function() {
        console.error(`❌ 파일 읽기 실패: ${file.name}`);
        alert(`${file.name} 파일을 읽을 수 없습니다.`);
    };
    
    reader.readAsDataURL(file);
}

// 이미지 리스트 표시
function showImageList() {
    if (!elements.imageListSection || !elements.imageList) return;
    
    elements.imageCount.textContent = originalImages.length;
    elements.imageList.innerHTML = '';
    
    originalImages.forEach((image, index) => {
        const imageItem = document.createElement('div');
        imageItem.className = 'col-md-4 col-lg-3';
        imageItem.innerHTML = `
            <div class="card image-item" data-index="${index}">
                <div class="card-img-top position-relative">
                    <img src="${image.dataUrl}" class="img-fluid" style="height: 120px; object-fit: cover;">
                    <div class="position-absolute top-0 end-0 p-1">
                        <span class="badge bg-primary">${index + 1}</span>
                    </div>
                </div>
                <div class="card-body p-2">
                    <h6 class="card-title text-truncate small mb-1">${image.name}</h6>
                    <small class="text-muted">${formatFileSize(image.size)}</small>
                </div>
            </div>
        `;
        
        elements.imageList.appendChild(imageItem);
    });
    
    elements.imageListSection.style.display = 'block';
}

// 현재 이미지를 크롭퍼에 로드
function loadCurrentImageToCropper() {
    if (originalImages.length === 0) return;
    
    const currentImage = originalImages[currentImageIndex];
    if (!currentImage) return;
    
    console.log(`🖼️ 크롭퍼에 이미지 로드: ${currentImage.name} (${currentImageIndex + 1}/${originalImages.length})`);
    
    // 현재 이미지 번호 업데이트
    elements.currentImageNumber.textContent = `${currentImageIndex + 1}/${originalImages.length}`;
    elements.imageDimensions.textContent = '계산 중...';
    elements.imageFileName.textContent = currentImage.name;
    
    // 네비게이션 버튼 표시/숨김
    elements.buttons.prevImage.style.display = currentImageIndex > 0 ? 'inline-block' : 'none';
    elements.buttons.nextImage.style.display = currentImageIndex < originalImages.length - 1 ? 'inline-block' : 'none';
    
    // 크롭퍼 초기화
    if (cropper) {
        cropper.destroy();
        cropper = null;
    }
    
    elements.cropImage.src = currentImage.dataUrl;
    elements.cropImage.style.display = 'block';
    
    elements.cropImage.onload = function() {
        console.log('이미지 로드 완료, 크롭퍼 초기화 시작');
        setTimeout(() => {
            initializeCropper();
            updateImageDimensions();
        }, 100);
    };
}

// 크롭퍼 초기화 (16:9 비율)
function initializeCropper() {
    if (!elements.cropImage) return;
    
    console.log('🔧 크롭퍼 초기화 - 16:9 비율');
    
    cropper = new Cropper(elements.cropImage, {
        aspectRatio: 16 / 9, // 시설 사진은 16:9 비율
        viewMode: 1, // 크롭 박스를 캔버스 내부로 제한
        dragMode: 'move', // 드래그 모드 (이미지 이동 우선)
        autoCropArea: 0.8, // 자동 크롭 영역 크기 (80%)
        responsive: true, // 반응형 크기 조정
        restore: false, // 크기 조정 시 크롭 박스 복원 안함
        guides: true, // 가이드 라인 표시 (격자)
        center: true, // 중앙 표시자 표시
        highlight: false, // 크롭 박스 외부 하이라이트 제거
        cropBoxMovable: true, // 크롭 박스 이동 가능
        cropBoxResizable: true, // 크롭 박스 크기 조정 가능 (대각선 조절)
        toggleDragModeOnDblclick: true, // 더블클릭으로 드래그 모드 변경
        rotatable: true, // 회전 가능
        scalable: true, // 확대/축소 가능
        zoomable: true, // 줌 가능
        minCropBoxWidth: 200, // 최소 크롭 박스 너비
        minCropBoxHeight: 112, // 최소 크롭 박스 높이 (16:9 비율 유지)
        ready() {
            console.log('✅ 크롭퍼 준비 완료');
            updatePreview();
            setupSmartScroll(); // 스마트 스크롤 설정
        },
        crop: updatePreview
    });
}

// 스마트 스크롤 설정 (개선된 버전)
function setupSmartScroll() {
    if (!cropper) {
        console.log('❌ 크롭퍼가 없어서 스마트 스크롤 설정 불가');
        return;
    }
    
    const cropperContainer = document.querySelector('.cropper-container');
    if (!cropperContainer) {
        console.log('❌ 크롭퍼 컨테이너를 찾을 수 없음');
        return;
    }
    
    console.log('🖱️ 스마트 스크롤 시스템 초기화 시작');
    
    // 기존 이벤트 리스너 제거 (중복 방지)
    cropperContainer.removeEventListener('wheel', handleSmartScroll);
    
    // 새 이벤트 리스너 추가
    cropperContainer.addEventListener('wheel', handleSmartScroll, { passive: false });
    
    console.log('✅ 스마트 스크롤 시스템 초기화 완료');
}

// 스마트 스크롤 핸들러 (별도 함수로 분리)
function handleSmartScroll(event) {
    if (!cropper) return;
    
    try {
        const imageData = cropper.getImageData();
        const canvasData = cropper.getCanvasData();
        
        // 현재 줌 레벨 계산 (더 정확한 방법)
        const currentZoom = canvasData.width / canvasData.naturalWidth;
        
        const isZoomingIn = event.deltaY < 0;
        const isZoomingOut = event.deltaY > 0;
        
        console.log('🔍 스마트 스크롤 - 현재 줌:', currentZoom.toFixed(3), '방향:', isZoomingIn ? '확대' : '축소');
        
        // 더 정밀한 임계값 설정
        const MAX_ZOOM_THRESHOLD = 2.9;  // 최대 줌 임계값
        const MIN_ZOOM_THRESHOLD = 0.15; // 최소 줌 임계값
        
        // 최대 확대 상태에서 더 확대 시도 시 → 페이지 스크롤
        if (isZoomingIn && currentZoom >= MAX_ZOOM_THRESHOLD) {
            console.log('📈 최대 확대 도달 → 페이지 스크롤 전환');
            updateZoomIndicator(currentZoom, '최대 확대 - 페이지 스크롤');
            
            // 페이지 스크롤 실행
            window.scrollBy({
                top: event.deltaY * 0.8,
                behavior: 'auto'
            });
            return; // preventDefault 하지 않고 종료
        }
        
        // 최소 축소 상태에서 더 축소 시도 시 → 페이지 스크롤
        if (isZoomingOut && currentZoom <= MIN_ZOOM_THRESHOLD) {
            console.log('📉 최소 축소 도달 → 페이지 스크롤 전환');
            updateZoomIndicator(currentZoom, '최소 축소 - 페이지 스크롤');
            
            // 페이지 스크롤 실행
            window.scrollBy({
                top: event.deltaY * 0.8,
                behavior: 'auto'
            });
            return; // preventDefault 하지 않고 종료
        }
        
        // 줌 범위 내에서는 이미지 줌 처리
        event.preventDefault();
        event.stopPropagation();
        
        const zoomDelta = isZoomingIn ? 0.1 : -0.1;
        cropper.zoom(zoomDelta);
        
        // 새로운 줌 레벨 계산
        const newImageData = cropper.getImageData();
        const newCanvasData = cropper.getCanvasData();
        const newZoom = newCanvasData.width / newCanvasData.naturalWidth;
        
        updateZoomIndicator(newZoom, isZoomingIn ? '확대' : '축소');
        
    } catch (error) {
        console.error('❌ 스마트 스크롤 처리 중 오류:', error);
        // 오류 발생 시 기본 스크롤 허용
        window.scrollBy({
            top: event.deltaY * 0.5,
            behavior: 'auto'
        });
    }
}

// 줌 표시기 업데이트 (개선된 버전)
function updateZoomIndicator(zoomLevel, action) {
    if (!elements.zoomIndicator || !elements.zoomLevel) return;
    
    const zoomPercent = Math.round(zoomLevel * 100);
    elements.zoomLevel.textContent = zoomPercent + '%';
    
    // 액션에 따른 아이콘 변경
    const zoomIcon = elements.zoomIndicator.querySelector('i');
    if (zoomIcon) {
        if (action === '확대') {
            zoomIcon.className = 'fas fa-search-plus me-2';
        } else if (action === '축소') {
            zoomIcon.className = 'fas fa-search-minus me-2';
        } else {
            zoomIcon.className = 'fas fa-search me-2';
        }
    }
    
    elements.zoomIndicator.style.display = 'block';
    
    // 3초 후 자동 숨김
    clearTimeout(window.zoomIndicatorTimeout);
    window.zoomIndicatorTimeout = setTimeout(() => {
        if (elements.zoomIndicator) {
            elements.zoomIndicator.style.display = 'none';
        }
    }, 3000);
}

// 미리보기 업데이트
function updatePreview() {
    if (!cropper || !elements.previewCanvas) return;
    
    console.log('🖼️ 미리보기 업데이트 시작');
    
    // 크롭된 이미지를 캔버스에 그리기 (16:9 비율)
    const canvas = cropper.getCroppedCanvas({
        width: 192,
        height: 108,
        imageSmoothingEnabled: true,
        imageSmoothingQuality: 'high'
    });
    
    if (canvas) {
        const ctx = elements.previewCanvas.getContext('2d');
        ctx.clearRect(0, 0, elements.previewCanvas.width, elements.previewCanvas.height);
        ctx.drawImage(canvas, 0, 0, elements.previewCanvas.width, elements.previewCanvas.height);
        console.log('✅ 미리보기 업데이트 완료');
    }
}

// 이미지 크기 정보 업데이트
function updateImageDimensions() {
    if (!cropper) return;
    
    const imageData = cropper.getImageData();
    elements.imageDimensions.textContent = `${Math.round(imageData.naturalWidth)} × ${Math.round(imageData.naturalHeight)}`;
}

// 크롭퍼 줌
function zoomCropper(ratio) {
    if (!cropper) return;
    
    cropper.zoom(ratio);
    showZoomIndicator();
}

// 크롭퍼 회전
function rotateCropper(degree) {
    if (!cropper) return;
    
    cropper.rotate(degree);
    updatePreview();
}

// 크롭퍼 리셋
function resetCropper() {
    if (!cropper) return;
    
    cropper.reset();
    updatePreview();
}

// 줌 표시기 (기존 함수와 통합)
function showZoomIndicator() {
    if (!elements.zoomIndicator || !cropper) return;
    
    const imageData = cropper.getImageData();
    const zoomRatio = imageData.width / imageData.naturalWidth;
    
    updateZoomIndicator(zoomRatio, '줌');
}

// 현재 이미지 크롭 완료
function cropCurrentImage() {
    if (!cropper) {
        alert('이미지를 먼저 로드해주세요.');
        return;
    }
    
    console.log(`✂️ 이미지 크롭 시작: ${currentImageIndex + 1}/${originalImages.length}`);
    
    setButtonLoading(elements.buttons.cropCurrent, true, '처리 중...');
    
    try {
        // 최종 크롭된 이미지 생성 (16:9 비율, 고품질)
        const canvas = cropper.getCroppedCanvas({
            width: 800,   // 시설 이미지 가로 크기
            height: 450,  // 시설 이미지 세로 크기 (16:9 비율)
            imageSmoothingEnabled: true,
            imageSmoothingQuality: 'high'
        });
        
        if (canvas) {
            // 크롭된 이미지 저장
            const croppedData = {
                index: currentImageIndex,
                originalImage: originalImages[currentImageIndex],
                canvas: canvas,
                dataUrl: canvas.toDataURL('image/jpeg', 0.9)
            };
            
            croppedImages[currentImageIndex] = croppedData;
            console.log(`✅ 이미지 크롭 완료: ${currentImageIndex + 1}`);
            
            // 다음 이미지로 이동 또는 압축 단계로
            if (currentImageIndex < originalImages.length - 1) {
                goToNextImage();
            } else {
                // 모든 이미지 크롭 완료
                console.log('🎉 모든 이미지 크롭 완료, 압축 단계로 이동');
                goToCompressionStep();
            }
        } else {
            throw new Error('캔버스 생성 실패');
        }
        
    } catch (error) {
        console.error('크롭 처리 오류:', error);
        alert('이미지 처리 중 오류가 발생했습니다.');
    } finally {
        setButtonLoading(elements.buttons.cropCurrent, false);
    }
}

// 이전 이미지로 이동
function goToPreviousImage() {
    if (currentImageIndex > 0) {
        currentImageIndex--;
        loadCurrentImageToCropper();
    }
}

// 다음 이미지로 이동
function goToNextImage() {
    if (currentImageIndex < originalImages.length - 1) {
        currentImageIndex++;
        loadCurrentImageToCropper();
    }
}

// 3단계: 압축 및 SEO 단계로 이동
function goToCompressionStep() {
    hideAllSections();
    if (elements.compressionSection) elements.compressionSection.style.display = 'block';
    updateStepIndicator(3);
    
    // 첫 번째 크롭된 이미지로 압축 미리보기 시작
    currentImageIndex = 0;
    updateCompressionPreview();
    generateAltText();
}

// 압축 미리보기 업데이트
function updateCompressionPreview() {
    if (croppedImages.length === 0) return;
    
    const currentCroppedImage = croppedImages[currentImageIndex];
    if (!currentCroppedImage) return;
    
    updateCompression();
}

// 압축 품질 표시 업데이트
function updateQualityDisplay() {
    const quality = Math.round(elements.qualitySlider.value * 100);
    elements.qualityPercent.textContent = quality + '%';
}

// 이미지 압축 업데이트
function updateCompression() {
    if (croppedImages.length === 0) return;
    
    const currentCroppedImage = croppedImages[currentImageIndex];
    if (!currentCroppedImage || !currentCroppedImage.canvas) return;
    
    const quality = parseFloat(elements.qualitySlider.value || 0.8);
    const selectedFormat = getSelectedImageFormat();
    
    console.log('🔄 이미지 압축 업데이트 - 형식:', selectedFormat.toUpperCase(), '품질:', Math.round(quality * 100) + '%');
    
    try {
        let compressedImageData;
        let actualFormat = selectedFormat;
        
        // 브라우저 지원 여부 확인 및 압축
        if (selectedFormat === 'avif') {
            if (isFormatSupported('image/avif')) {
                compressedImageData = currentCroppedImage.canvas.toDataURL('image/avif', quality);
                console.log('✅ AVIF 형식으로 압축 성공');
            } else {
                console.log('⚠️ AVIF 미지원 - WebP 시도');
                if (isFormatSupported('image/webp')) {
                    compressedImageData = currentCroppedImage.canvas.toDataURL('image/webp', quality);
                    actualFormat = 'webp';
                    showFormatFallbackMessage('AVIF', 'WebP');
                } else {
                    compressedImageData = currentCroppedImage.canvas.toDataURL('image/jpeg', quality);
                    actualFormat = 'jpeg';
                    showFormatFallbackMessage('AVIF', 'JPEG');
                }
            }
        } else if (selectedFormat === 'webp') {
            if (isFormatSupported('image/webp')) {
                compressedImageData = currentCroppedImage.canvas.toDataURL('image/webp', quality);
                console.log('✅ WebP 형식으로 압축 성공');
            } else {
                compressedImageData = currentCroppedImage.canvas.toDataURL('image/jpeg', quality);
                actualFormat = 'jpeg';
                showFormatFallbackMessage('WebP', 'JPEG');
            }
        } else {
            // JPEG는 모든 브라우저에서 지원
            compressedImageData = currentCroppedImage.canvas.toDataURL('image/jpeg', quality);
            console.log('✅ JPEG 형식으로 압축 성공');
        }
        
        // 현재 형식 표시 업데이트
        if (elements.currentFormat) {
            elements.currentFormat.textContent = actualFormat.toUpperCase();
        }
        
        // 최종 미리보기 업데이트
        if (elements.finalPreviewImage) {
            elements.finalPreviewImage.src = compressedImageData;
        }
        
        // 압축 정보 업데이트
        updateCompressionInfo(compressedImageData, actualFormat);
        
        // 압축된 데이터 저장
        currentCroppedImage.compressedData = compressedImageData;
        currentCroppedImage.finalFormat = actualFormat;
        
    } catch (error) {
        console.error('압축 처리 오류:', error);
        // 오류 시 JPEG로 폴백
        const fallbackData = currentCroppedImage.canvas.toDataURL('image/jpeg', 0.8);
        elements.finalPreviewImage.src = fallbackData;
        updateCompressionInfo(fallbackData, 'jpeg');
        currentCroppedImage.compressedData = fallbackData;
        currentCroppedImage.finalFormat = 'jpeg';
    }
}

// 선택된 이미지 형식 가져오기
function getSelectedImageFormat() {
    if (elements.formatAVIF && elements.formatAVIF.checked) return 'avif';
    if (elements.formatWEBP && elements.formatWEBP.checked) return 'webp';
    if (elements.formatJPEG && elements.formatJPEG.checked) return 'jpeg';
    return 'avif'; // 기본값
}

// 브라우저 형식 지원 여부 확인
function isFormatSupported(mimeType) {
    const canvas = document.createElement('canvas');
    canvas.width = 2;
    canvas.height = 2;
    const ctx = canvas.getContext('2d');
    
    ctx.fillStyle = 'rgb(255, 0, 0)';
    ctx.fillRect(0, 0, 1, 1);
    ctx.fillStyle = 'rgb(0, 255, 0)';
    ctx.fillRect(1, 0, 1, 1);
    ctx.fillStyle = 'rgb(0, 0, 255)';
    ctx.fillRect(0, 1, 1, 1);
    ctx.fillStyle = 'rgb(255, 255, 255)';
    ctx.fillRect(1, 1, 1, 1);
    
    try {
        const dataURL = canvas.toDataURL(mimeType, 0.9);
        const isSupported = dataURL.startsWith(`data:${mimeType}`);
        console.log(`🔍 형식 지원 확인: ${mimeType} - ${isSupported ? '지원됨' : '미지원'}`);
        return isSupported;
    } catch (e) {
        console.warn(`⚠️ 형식 지원 확인 오류: ${mimeType}`, e);
        return false;
    }
}

// 압축 정보 업데이트
function updateCompressionInfo(compressedImageData, format) {
    const originalSize = estimateDataUrlSize(croppedImages[currentImageIndex].dataUrl);
    const compressedSize = estimateDataUrlSize(compressedImageData);
    const savings = Math.round(((originalSize - compressedSize) / originalSize) * 100);
    
    let formatBenefit = '';
    if (format === 'avif') {
        formatBenefit = ' (최고 압축률)';
    } else if (format === 'webp') {
        formatBenefit = ' (효율적 압축)';
    } else if (format === 'jpeg') {
        formatBenefit = ' (범용 호환)';
    }
    
    elements.compressionSavings.innerHTML = 
        `<div>${savings}% 절약 (${formatFileSize(originalSize)} → ${formatFileSize(compressedSize)})</div>
         <small class="text-muted">${format.toUpperCase()} 형식${formatBenefit}</small>`;
}

// DataURL 크기 추정
function estimateDataUrlSize(dataUrl) {
    return Math.round((dataUrl.length * 3) / 4);
}

// Alt 텍스트 자동 생성
function generateAltText() {
    if (!elements.altTextInput) return;
    
    let altText = `시설 이미지 ${currentImageIndex + 1}`;
    
    if (originalImages[currentImageIndex]) {
        const fileName = originalImages[currentImageIndex].name.replace(/\.[^/.]+$/, '');
        if (fileName.length > 0 && fileName !== 'image') {
            altText += ` - ${fileName}`;
        }
    }
    
    elements.altTextInput.value = altText;
    console.log('🏷️ Alt 텍스트 자동 생성:', altText);
}

// 모든 이미지 저장
function saveAllImages() {
    console.log('💾 모든 이미지 저장 시작');
    
    if (croppedImages.length === 0) {
        alert('저장할 이미지가 없습니다.');
        return;
    }
    
    setButtonLoading(elements.buttons.saveAllImages, true, '저장 중...');
    
    // 모든 크롭된 이미지에 대해 압축 적용
    const quality = parseFloat(elements.qualitySlider.value || 0.8);
    const selectedFormat = getSelectedImageFormat();
    const altText = elements.altTextInput.value.trim() || '시설 이미지';
    
    const uploadPromises = croppedImages.map((croppedImage, index) => {
        return uploadSingleImage(croppedImage, index, selectedFormat, quality, altText);
    });
    
    Promise.all(uploadPromises)
        .then(results => {
            console.log('✅ 모든 이미지 업로드 완료');
            goToCompleteStep();
            showFinalImages(results);
        })
        .catch(error => {
            console.error('❌ 이미지 업로드 실패:', error);
            alert('이미지 저장 중 오류가 발생했습니다.');
        })
        .finally(() => {
            setButtonLoading(elements.buttons.saveAllImages, false);
        });
}

// 단일 이미지 업로드
function uploadSingleImage(croppedImage, index, format, quality, altText) {
    return new Promise((resolve, reject) => {
        try {
            // 압축된 이미지 데이터 생성
            let compressedData;
            let actualFormat = format;
            
            if (format === 'avif' && isFormatSupported('image/avif')) {
                compressedData = croppedImage.canvas.toDataURL('image/avif', quality);
            } else if ((format === 'avif' || format === 'webp') && isFormatSupported('image/webp')) {
                compressedData = croppedImage.canvas.toDataURL('image/webp', quality);
                actualFormat = 'webp';
            } else {
                compressedData = croppedImage.canvas.toDataURL('image/jpeg', quality);
                actualFormat = 'jpeg';
            }
            
            // Blob으로 변환
            const blob = dataURLtoBlob(compressedData);
            
            // FormData 생성
            const formData = new FormData();
            formData.append('facilityImage', blob, `facility_${index + 1}.${actualFormat}`);
            formData.append('altText', `${altText} ${index + 1}`);
            formData.append('format', actualFormat);
            formData.append('imageIndex', index.toString());
            
            console.log(`📤 이미지 ${index + 1} 업로드 시작`);
            
            fetch(`/facility/crop-images/save/${facilityId}`, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    console.log(`✅ 이미지 ${index + 1} 업로드 성공`);
                    resolve(data);
                } else {
                    throw new Error(data.message || '업로드 실패');
                }
            })
            .catch(reject);
            
        } catch (error) {
            reject(error);
        }
    });
}

// 4단계: 완료 단계로 이동
function goToCompleteStep() {
    hideAllSections();
    if (elements.completeSection) elements.completeSection.style.display = 'block';
    updateStepIndicator(4);
}

// 최종 이미지들 표시
function showFinalImages(results) {
    if (!elements.finalImagesGrid) return;
    
    elements.finalImagesGrid.innerHTML = '';
    
    results.forEach((result, index) => {
        const croppedImage = croppedImages[index];
        if (croppedImage && croppedImage.compressedData) {
            const imageDiv = document.createElement('div');
            imageDiv.className = 'col-md-3 col-sm-4 col-6 mb-3';
            imageDiv.innerHTML = `
                <div class="card">
                    <img src="${croppedImage.compressedData}" class="card-img-top" 
                         style="height: 120px; object-fit: cover;">
                    <div class="card-body p-2">
                        <small class="text-success">
                            <i class="fas fa-check me-1"></i>저장 완료
                        </small>
                    </div>
                </div>
            `;
            elements.finalImagesGrid.appendChild(imageDiv);
        }
    });
}

// 이미지 더 추가
function addMoreImages() {
    // 초기화 후 업로드 단계로
    originalImages = [];
    croppedImages = [];
    currentImageIndex = 0;
    
    if (cropper) {
        cropper.destroy();
        cropper = null;
    }
    
    elements.imageInput.value = '';
    goToUploadStep();
}

// 단계 이동 함수들
function goToUploadStep() {
    hideAllSections();
    if (elements.uploadSection) elements.uploadSection.style.display = 'block';
    if (elements.imageListSection) elements.imageListSection.style.display = 'none';
    updateStepIndicator(1);
    
    // 초기화
    if (elements.imageInput) elements.imageInput.value = '';
    if (cropper) {
        cropper.destroy();
        cropper = null;
    }
}

function goToCropStep() {
    hideAllSections();
    if (elements.cropSection) elements.cropSection.style.display = 'block';
    if (elements.imageListSection) elements.imageListSection.style.display = 'block';
    updateStepIndicator(2);
}

// 모든 섹션 숨기기
function hideAllSections() {
    if (elements.uploadSection) elements.uploadSection.style.display = 'none';
    if (elements.cropSection) elements.cropSection.style.display = 'none';
    if (elements.compressionSection) elements.compressionSection.style.display = 'none';
    if (elements.completeSection) elements.completeSection.style.display = 'none';
}

// 단계 표시기 업데이트
function updateStepIndicator(currentStep) {
    Object.values(elements.steps).forEach(step => {
        if (step) {
            step.classList.remove('active', 'completed');
        }
    });
    
    for (let i = 1; i <= currentStep; i++) {
        const step = elements.steps[`step${i}`];
        if (step) {
            if (i === currentStep) {
                step.classList.add('active');
            } else {
                step.classList.add('completed');
            }
        }
    }
}

// 드래그 오버 처리
function handleDragOver(event) {
    event.preventDefault();
    event.currentTarget.style.borderColor = '#0d6efd';
    event.currentTarget.style.backgroundColor = '#f8f9ff';
}

// 드롭 처리
function handleDrop(event) {
    event.preventDefault();
    const files = Array.from(event.dataTransfer.files);
    
    if (files.length > 0) {
        // input에 파일 설정
        const dt = new DataTransfer();
        files.forEach(file => dt.items.add(file));
        elements.imageInput.files = dt.files;
        
        // 업로드 처리
        handleMultipleImageUpload({ target: { files } });
    }
    
    // 스타일 리셋
    event.currentTarget.style.borderColor = '';
    event.currentTarget.style.backgroundColor = '';
}

// 큰 파일 안내 메시지
function showLargeFileNotice(fileSize, fileName) {
    const sizeMB = (fileSize / 1024 / 1024).toFixed(2);
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-info alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
    alertDiv.style.cssText = 'z-index: 10000; min-width: 350px;';
    alertDiv.innerHTML = `
        <i class="fas fa-info-circle me-2"></i>
        큰 파일(${fileName}, ${sizeMB}MB)을 업로드하셨습니다. 자동으로 압축하여 최적화합니다.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 8000);
}

// 형식 폴백 메시지
function showFormatFallbackMessage(original, fallback) {
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-warning alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
    alertDiv.style.cssText = 'z-index: 10000; min-width: 300px;';
    alertDiv.innerHTML = `
        <i class="fas fa-exclamation-triangle me-2"></i>
        ${original} 형식이 지원되지 않아 ${fallback}로 변환됩니다.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

// Base64를 Blob으로 변환
function dataURLtoBlob(dataurl) {
    const arr = dataurl.split(',');
    const mime = arr[0].match(/:(.*?);/)[1];
    const bstr = atob(arr[1]);
    let n = bstr.length;
    const u8arr = new Uint8Array(n);
    while (n--) {
        u8arr[n] = bstr.charCodeAt(n);
    }
    return new Blob([u8arr], { type: mime });
}

// 파일 크기 포맷팅
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// 버튼 로딩 상태 설정
function setButtonLoading(button, isLoading, loadingText = '처리 중...') {
    if (!button) return;
    
    if (isLoading) {
        button.disabled = true;
        button.classList.add('loading');
        button.setAttribute('data-original-text', button.innerHTML);
        button.innerHTML = `<i class="fas fa-spinner fa-spin me-1"></i>${loadingText}`;
    } else {
        button.disabled = false;
        button.classList.remove('loading');
        const originalText = button.getAttribute('data-original-text');
        if (originalText) {
            button.innerHTML = originalText;
        }
    }
}
</script>

<style>
/* 시설 이미지 크롭퍼 전용 스타일 */
.facility-preview .card {
    transition: transform 0.3s ease;
    border: none;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.facility-preview .card:hover {
    transform: translateY(-2px);
}

.image-item {
    cursor: pointer;
    transition: transform 0.2s ease;
}

.image-item:hover {
    transform: scale(1.02);
}

.image-item.active {
    border-color: #007bff;
    box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
}

.crop-navigation .btn {
    min-width: 80px;
}

.final-images-grid {
    max-height: 300px;
    overflow-y: auto;
}

.completion-icon {
    animation: bounceIn 0.8s ease;
}

@keyframes bounceIn {
    0% {
        opacity: 0;
        transform: scale(0.3);
    }
    50% {
        opacity: 1;
        transform: scale(1.05);
    }
    70% {
        transform: scale(0.9);
    }
    100% {
        opacity: 1;
        transform: scale(1);
    }
}
</style>

</body>
</html>