<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head th:replace="~{layout/header :: header}">
    <title>ì‹œì„¤ ì´ë¯¸ì§€ ê´€ë¦¬ - CareLink</title>
</head>
<body class="d-flex flex-column min-vh-100 pt-5">
<nav th:replace="~{layout/header :: navbar}"></nav>

<div th:replace="~{layout/header :: messages}"></div>

<main class="flex-grow-1">
    <div class="container mt-4">
        <!-- ë¸Œë ˆë“œí¬ëŸ¼ -->
        <nav aria-label="breadcrumb" class="mb-4">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">í™ˆ</a></li>
                <li class="breadcrumb-item"><a href="/facility/manage">ì‹œì„¤ ê´€ë¦¬</a></li>
                <li class="breadcrumb-item active" aria-current="page">ì‹œì„¤ ì´ë¯¸ì§€ ê´€ë¦¬</li>
            </ol>
        </nav>
        
        <div class="row justify-content-center">
            <div class="col-12 col-lg-11">
                <div class="card shadow">
                    <div class="card-body p-4">
                        <div class="text-center mb-4">
                            <h3 class="card-title fw-bold text-primary">
                                <i class="fas fa-images me-2"></i>
                                ì‹œì„¤ ì´ë¯¸ì§€ ê´€ë¦¬
                            </h3>
                            <p class="text-muted">ì‹œì„¤ ì‚¬ì§„ì„ 16:9 ë¹„ìœ¨ë¡œ ì¡°ì •í•˜ì—¬ ë“±ë¡í•˜ì„¸ìš” (ìµœëŒ€ 5ì¥)</p>
                        </div>

                        <!-- ë‹¨ê³„ í‘œì‹œê¸° -->
                        <div class="steps-indicator mb-4">
                            <div class="step-item active" id="step1">
                                <div class="step-circle">
                                    <i class="fas fa-upload"></i>
                                </div>
                                <div class="step-label">ì´ë¯¸ì§€ ì„ íƒ</div>
                            </div>
                            <div class="step-connector"></div>
                            <div class="step-item" id="step2">
                                <div class="step-circle">
                                    <i class="fas fa-crop-alt"></i>
                                </div>
                                <div class="step-label">ë¹„ìœ¨ ì¡°ì ˆ</div>
                            </div>
                            <div class="step-connector"></div>
                            <div class="step-item" id="step3">
                                <div class="step-circle">
                                    <i class="fas fa-compress-alt"></i>
                                </div>
                                <div class="step-label">ì••ì¶• & SEO</div>
                            </div>
                            <div class="step-connector"></div>
                            <div class="step-item" id="step4">
                                <div class="step-circle">
                                    <i class="fas fa-check"></i>
                                </div>
                                <div class="step-label">ì™„ë£Œ</div>
                            </div>
                        </div>

                        <!-- 1ë‹¨ê³„: íŒŒì¼ ì—…ë¡œë“œ -->
                        <div id="uploadSection" class="upload-section">
                            <div class="upload-area" id="uploadArea">
                                <div class="upload-content">
                                    <div class="upload-icon">
                                        <i class="fas fa-cloud-upload-alt fa-3x text-primary"></i>
                                    </div>
                                    <h5 class="upload-title">ì‹œì„¤ ì´ë¯¸ì§€ ì—…ë¡œë“œ</h5>
                                    <p class="upload-description text-muted">
                                        ì´ë¯¸ì§€ë¥¼ ë“œë˜ê·¸í•˜ì—¬ ì—…ë¡œë“œí•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì„ íƒí•˜ì„¸ìš”
                                    </p>
                                    <div class="upload-format-info">
                                        <small class="text-muted">
                                            <i class="fas fa-info-circle me-1"></i>
                                            JPG, PNG, WebP íŒŒì¼ ì§€ì› (í° íŒŒì¼ë„ ìë™ ì••ì¶•)
                                        </small>
                                        <br>
                                        <small class="text-info">
                                            <i class="fas fa-crop-alt me-1"></i>
                                            ì‹œì„¤ ì‚¬ì§„ ë¹„ìœ¨ (16:9) ìë™ ì¡°ì •
                                        </small>
                                        <br>
                                        <small class="text-success">
                                            <i class="fas fa-images me-1"></i>
                                            ìµœëŒ€ 5ì¥ê¹Œì§€ ë“±ë¡ ê°€ëŠ¥
                                        </small>
                                    </div>
                                    <button type="button" class="btn btn-primary btn-lg mt-3" id="fileSelectBtn">
                                        <i class="fas fa-folder-open me-2"></i>íŒŒì¼ ì„ íƒ
                                    </button>
                                </div>
                            </div>
                            <input type="file" id="imageInput" accept="image/*" multiple style="display: none;">
                        </div>

                        <!-- ì´ë¯¸ì§€ ë¦¬ìŠ¤íŠ¸ -->
                        <div id="imageListSection" class="mb-4" style="display: none;">
                            <h5 class="mb-3">
                                <i class="fas fa-list me-2"></i>ì„ íƒëœ ì´ë¯¸ì§€
                                <span class="badge bg-primary ms-2" id="imageCount">0</span>
                            </h5>
                            <div id="imageList" class="row g-3"></div>
                        </div>

                        <!-- 2ë‹¨ê³„: í¬ë¡­ ë° ì¡°ì • -->
                        <div id="cropSection" class="crop-section" style="display: none;">
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="crop-container">
                                        <h6 class="mb-3">
                                            <i class="fas fa-crop-alt me-2"></i>
                                            ì´ë¯¸ì§€ ë¹„ìœ¨ ì¡°ì •
                                            <span class="badge bg-info ms-2" id="currentImageNumber">1/1</span>
                                        </h6>
                                        <div class="crop-image-container">
                                            <img id="cropImage" style="max-width: 100%; display: none;">
                                        </div>
                                        <div class="crop-controls mt-3 text-center">
                                            <div class="btn-group me-3" role="group">
                                                <button type="button" class="btn btn-outline-primary btn-sm" id="zoomInBtn">
                                                    <i class="fas fa-search-plus"></i> í™•ëŒ€
                                                </button>
                                                <button type="button" class="btn btn-outline-primary btn-sm" id="zoomOutBtn">
                                                    <i class="fas fa-search-minus"></i> ì¶•ì†Œ
                                                </button>
                                            </div>
                                            <div class="btn-group me-3" role="group">
                                                <button type="button" class="btn btn-outline-secondary btn-sm" id="rotateLeftBtn">
                                                    <i class="fas fa-undo"></i> ì¢ŒíšŒì „
                                                </button>
                                                <button type="button" class="btn btn-outline-secondary btn-sm" id="rotateRightBtn">
                                                    <i class="fas fa-redo"></i> ìš°íšŒì „
                                                </button>
                                            </div>
                                            <button type="button" class="btn btn-outline-danger btn-sm" id="resetBtn">
                                                <i class="fas fa-sync-alt"></i> ë¦¬ì…‹
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="crop-preview-panel">
                                        <h6 class="mb-3">
                                            <i class="fas fa-eye me-2"></i>ë¯¸ë¦¬ë³´ê¸°
                                        </h6>
                                        <div class="facility-preview text-center">
                                            <div class="facility-card-preview mb-3">
                                                <div class="card" style="max-width: 200px; margin: 0 auto;">
                                                    <div class="card-img-container">
                                                        <canvas id="previewCanvas" width="192" height="108" 
                                                                style="width: 100%; height: auto; border-radius: 8px;"></canvas>
                                                    </div>
                                                    <div class="card-body p-2">
                                                        <h6 class="card-title text-truncate mb-1">ì‹œì„¤ëª…</h6>
                                                        <small class="text-muted">ì‹œì„¤ ì¹´ë“œ ë¯¸ë¦¬ë³´ê¸°</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- ì´ë¯¸ì§€ ì •ë³´ -->
                                        <div class="image-info-panel mt-3">
                                            <h6 class="mb-2">
                                                <i class="fas fa-info-circle me-2"></i>ì´ë¯¸ì§€ ì •ë³´
                                            </h6>
                                            <div class="small">
                                                <div class="d-flex justify-content-between">
                                                    <span>ë¹„ìœ¨:</span>
                                                    <span class="text-primary fw-bold">16:9</span>
                                                </div>
                                                <div class="d-flex justify-content-between">
                                                    <span>í¬ê¸°:</span>
                                                    <span id="imageDimensions">-</span>
                                                </div>
                                                <div class="d-flex justify-content-between">
                                                    <span>íŒŒì¼ëª…:</span>
                                                    <span id="imageFileName" class="text-truncate">-</span>
                                                </div>
                                            </div>
                                            
                                            <!-- í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤ ê°€ì´ë“œ -->
                                            <div class="mt-3 p-2 bg-light rounded">
                                                <h6 class="small mb-2">
                                                    <i class="fas fa-keyboard me-1"></i>í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤
                                                </h6>
                                                <div class="small text-muted">
                                                    <div class="row g-1">
                                                        <div class="col-6"><kbd>+/-</kbd> í™•ëŒ€/ì¶•ì†Œ</div>
                                                        <div class="col-6"><kbd>R/L</kbd> íšŒì „</div>
                                                        <div class="col-6"><kbd>Enter</kbd> ì™„ë£Œ</div>
                                                        <div class="col-6"><kbd>Esc</kbd> ë¦¬ì…‹</div>
                                                        <div class="col-12"><kbd>â† â†’</kbd> ì´ë¯¸ì§€ ì „í™˜</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="crop-actions mt-4 text-center">
                                <div class="d-flex justify-content-between align-items-center">
                                    <button type="button" class="btn btn-outline-secondary" id="backToUploadBtn">
                                        <i class="fas fa-arrow-left me-2"></i>ë‹¤ì‹œ ì„ íƒ
                                    </button>
                                    <div class="crop-navigation">
                                        <button type="button" class="btn btn-outline-primary me-2" id="prevImageBtn" style="display: none;">
                                            <i class="fas fa-chevron-left me-1"></i>ì´ì „
                                        </button>
                                        <button type="button" class="btn btn-outline-primary" id="nextImageBtn" style="display: none;">
                                            ë‹¤ìŒ<i class="fas fa-chevron-right ms-1"></i>
                                        </button>
                                    </div>
                                    <button type="button" class="btn btn-primary" id="cropCurrentBtn">
                                        <i class="fas fa-crop me-2"></i>ì´ ì´ë¯¸ì§€ ì™„ë£Œ
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- 3ë‹¨ê³„: ì••ì¶• ë° SEO ìµœì í™” -->
                        <div id="compressionSection" class="compression-section" style="display: none;">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="compression-settings">
                                        <h6 class="mb-3">
                                            <i class="fas fa-compress-alt me-2"></i>ì´ë¯¸ì§€ ì••ì¶• ì„¤ì •
                                        </h6>
                                        
                                        <!-- ì´ë¯¸ì§€ í˜•ì‹ ì„ íƒ -->
                                        <div class="mb-3">
                                            <label class="form-label">ì´ë¯¸ì§€ í˜•ì‹</label>
                                            <div class="btn-group w-100" role="group">
                                                <input type="radio" class="btn-check" name="imageFormat" id="formatAVIF" value="avif" checked>
                                                <label class="btn btn-outline-success btn-sm" for="formatAVIF">
                                                    <i class="fas fa-bolt me-1"></i>AVIF
                                                    <small class="d-block text-muted">ìš©ëŸ‰ ìµœì†Œ (ê¶Œì¥)</small>
                                                </label>
                                                
                                                <input type="radio" class="btn-check" name="imageFormat" id="formatWEBP" value="webp">
                                                <label class="btn btn-outline-primary btn-sm" for="formatWEBP">
                                                    <i class="fas fa-rocket me-1"></i>WebP
                                                    <small class="d-block text-muted">ë¹ ë¥¸ ë¡œë”©</small>
                                                </label>
                                                
                                                <input type="radio" class="btn-check" name="imageFormat" id="formatJPEG" value="jpeg">
                                                <label class="btn btn-outline-secondary btn-sm" for="formatJPEG">
                                                    <i class="fas fa-check me-1"></i>JPEG
                                                    <small class="d-block text-muted">ë²”ìš© í˜¸í™˜</small>
                                                </label>
                                            </div>
                                        </div>
                                        
                                        <!-- ì••ì¶• í’ˆì§ˆ -->
                                        <div class="mb-3">
                                            <label class="form-label">
                                                ì••ì¶• í’ˆì§ˆ: <span id="qualityPercent">80%</span>
                                            </label>
                                            <input type="range" class="form-range" id="qualitySlider" 
                                                   min="0.3" max="1.0" step="0.1" value="0.8">
                                            <div class="d-flex justify-content-between small text-muted">
                                                <span>ë†’ì€ ì••ì¶•</span>
                                                <span>ë†’ì€ í’ˆì§ˆ</span>
                                            </div>
                                        </div>
                                        
                                        <!-- ìë™ ìµœì í™” -->
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" id="autoOptimize" checked>
                                            <label class="form-check-label" for="autoOptimize">
                                                <i class="fas fa-magic me-1"></i>ìë™ ìµœì í™”
                                                <small class="d-block text-muted">ë¸Œë¼ìš°ì €ë³„ ìµœì  í˜•ì‹ ìë™ ì„ íƒ</small>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="compression-preview">
                                        <h6 class="mb-3">
                                            <i class="fas fa-eye me-2"></i>ì••ì¶• ê²°ê³¼
                                        </h6>
                                        <div class="compression-info text-center mb-3">
                                            <div class="compression-savings text-success fw-bold mb-2">
                                                <span id="compressionSavings">ê³„ì‚° ì¤‘...</span>
                                            </div>
                                            <small class="text-muted">
                                                í˜„ì¬ í˜•ì‹: <span id="currentFormat" class="fw-bold">AVIF</span>
                                            </small>
                                        </div>
                                        
                                        <div class="final-preview-container">
                                            <img id="finalPreviewImage" class="img-fluid rounded" 
                                                 style="max-width: 100%; height: auto; border: 2px solid #dee2e6;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Alt í…ìŠ¤íŠ¸ -->
                            <div class="alt-text-section mt-4">
                                <h6 class="mb-3">
                                    <i class="fas fa-tag me-2"></i>SEO ìµœì í™”
                                </h6>
                                <label for="altTextInput" class="form-label">
                                    <i class="fas fa-search me-1"></i>ì´ë¯¸ì§€ ì„¤ëª… (Alt í…ìŠ¤íŠ¸)
                                </label>
                                <textarea class="form-control" id="altTextInput" rows="2" 
                                          placeholder="ì‹œì„¤ ì´ë¯¸ì§€ì— ëŒ€í•œ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš” (SEO ìµœì í™”ìš©)"></textarea>
                                <small class="text-muted">
                                    <i class="fas fa-lightbulb me-1"></i>
                                    ê²€ìƒ‰ ì—”ì§„ ìµœì í™”ë¥¼ ìœ„í•œ ì´ë¯¸ì§€ ì„¤ëª…ì…ë‹ˆë‹¤
                                </small>
                            </div>
                            
                            <div class="compression-actions mt-4 text-center">
                                <div class="d-flex justify-content-between">
                                    <button type="button" class="btn btn-outline-secondary" id="backToCropBtn">
                                        <i class="fas fa-arrow-left me-2"></i>í¬ë¡­ìœ¼ë¡œ ëŒì•„ê°€ê¸°
                                    </button>
                                    <button type="button" class="btn btn-success" id="saveAllImagesBtn">
                                        <i class="fas fa-save me-2"></i>ëª¨ë“  ì´ë¯¸ì§€ ì €ì¥
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- 4ë‹¨ê³„: ì™„ë£Œ -->
                        <div id="completeSection" class="complete-section text-center" style="display: none;">
                            <div class="completion-icon mb-3">
                                <i class="fas fa-check-circle fa-5x text-success"></i>
                            </div>
                            <h4 class="text-success mb-3">ì‹œì„¤ ì´ë¯¸ì§€ ë“±ë¡ ì™„ë£Œ!</h4>
                            <p class="text-muted mb-4">ì‹œì„¤ ì´ë¯¸ì§€ê°€ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                            
                            <div class="final-images-grid mb-4" id="finalImagesGrid">
                                <!-- ì™„ë£Œëœ ì´ë¯¸ì§€ë“¤ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                            </div>
                            
                            <div class="final-actions">
                                <a href="/facility/manage" class="btn btn-primary me-2">
                                    <i class="fas fa-building me-2"></i>ì‹œì„¤ ê´€ë¦¬ë¡œ ëŒì•„ê°€ê¸°
                                </a>
                                <button type="button" class="btn btn-outline-primary" id="addMoreImagesBtn">
                                    <i class="fas fa-plus me-2"></i>ì´ë¯¸ì§€ ë” ì¶”ê°€
                                </button>
                            </div>
                        </div>

                        <!-- ì¤Œ í‘œì‹œê¸° -->
                        <div id="zoomIndicator" class="zoom-indicator" style="display: none;">
                            <i class="fas fa-search-plus me-2"></i>
                            <span id="zoomLevel">100%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<footer th:replace="~{layout/footer :: footer}"></footer>

<!-- Cropper.js CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">

<!-- ê³ ê¸‰ ì´ë¯¸ì§€ í¬ë¡­í¼ CSS -->
<link th:href="@{/css/advanced-image-cropper.css}" rel="stylesheet">

<script>
// ì „ì—­ ë³€ìˆ˜
let originalImages = [];
let currentImageIndex = 0;
let croppedImages = [];
let cropper = null;
let facilityId = null;

// DOM ìš”ì†Œ
const elements = {
    // ì„¹ì…˜ë“¤
    uploadSection: document.getElementById('uploadSection'),
    cropSection: document.getElementById('cropSection'),
    compressionSection: document.getElementById('compressionSection'),
    completeSection: document.getElementById('completeSection'),
    imageListSection: document.getElementById('imageListSection'),
    
    // ì—…ë¡œë“œ ê´€ë ¨
    uploadArea: document.getElementById('uploadArea'),
    fileSelectBtn: document.getElementById('fileSelectBtn'),
    imageInput: document.getElementById('imageInput'),
    imageList: document.getElementById('imageList'),
    imageCount: document.getElementById('imageCount'),
    
    // í¬ë¡­ ê´€ë ¨
    cropImage: document.getElementById('cropImage'),
    previewCanvas: document.getElementById('previewCanvas'),
    currentImageNumber: document.getElementById('currentImageNumber'),
    imageDimensions: document.getElementById('imageDimensions'),
    imageFileName: document.getElementById('imageFileName'),
    
    // ë²„íŠ¼ë“¤
    buttons: {
        backToUpload: document.getElementById('backToUploadBtn'),
        cropCurrent: document.getElementById('cropCurrentBtn'),
        prevImage: document.getElementById('prevImageBtn'),
        nextImage: document.getElementById('nextImageBtn'),
        backToCrop: document.getElementById('backToCropBtn'),
        saveAllImages: document.getElementById('saveAllImagesBtn'),
        addMoreImages: document.getElementById('addMoreImagesBtn'),
        zoomIn: document.getElementById('zoomInBtn'),
        zoomOut: document.getElementById('zoomOutBtn'),
        rotateLeft: document.getElementById('rotateLeftBtn'),
        rotateRight: document.getElementById('rotateRightBtn'),
        reset: document.getElementById('resetBtn')
    },
    
    // ì••ì¶• ê´€ë ¨
    formatAVIF: document.getElementById('formatAVIF'),
    formatWEBP: document.getElementById('formatWEBP'),
    formatJPEG: document.getElementById('formatJPEG'),
    qualitySlider: document.getElementById('qualitySlider'),
    qualityPercent: document.getElementById('qualityPercent'),
    autoOptimize: document.getElementById('autoOptimize'),
    altTextInput: document.getElementById('altTextInput'),
    finalPreviewImage: document.getElementById('finalPreviewImage'),
    compressionSavings: document.getElementById('compressionSavings'),
    currentFormat: document.getElementById('currentFormat'),
    
    // ë‹¨ê³„ í‘œì‹œ
    steps: {
        step1: document.getElementById('step1'),
        step2: document.getElementById('step2'),
        step3: document.getElementById('step3'),
        step4: document.getElementById('step4')
    },
    
    // ê¸°íƒ€
    zoomIndicator: document.getElementById('zoomIndicator'),
    zoomLevel: document.getElementById('zoomLevel'),
    finalImagesGrid: document.getElementById('finalImagesGrid')
};

// ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸ¬ ì‹œì„¤ ì´ë¯¸ì§€ í¬ë¡­í¼ ì´ˆê¸°í™” ì‹œì‘');
    
    // URLì—ì„œ ì‹œì„¤ ID ì¶”ì¶œ
    const pathParts = window.location.pathname.split('/');
    facilityId = pathParts[pathParts.length - 1];
    console.log('ğŸ¢ ì‹œì„¤ ID:', facilityId);
    
    initializeEventListeners();
    setupDragAndDrop();
    console.log('âœ… ì´ˆê¸°í™” ì™„ë£Œ');
});

// ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì´ˆê¸°í™”
function initializeEventListeners() {
    // íŒŒì¼ ì„ íƒ
    if (elements.fileSelectBtn) {
        elements.fileSelectBtn.addEventListener('click', () => {
            elements.imageInput.click();
        });
    }
    
    if (elements.imageInput) {
        elements.imageInput.addEventListener('change', handleMultipleImageUpload);
    }
    
    // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤ ì„¤ì •
    setupKeyboardShortcuts();
    
    // í¬ë¡­ ì»¨íŠ¸ë¡¤
    if (elements.buttons.zoomIn) {
        elements.buttons.zoomIn.addEventListener('click', () => zoomCropper(0.1));
    }
    if (elements.buttons.zoomOut) {
        elements.buttons.zoomOut.addEventListener('click', () => zoomCropper(-0.1));
    }
    if (elements.buttons.rotateLeft) {
        elements.buttons.rotateLeft.addEventListener('click', () => rotateCropper(-90));
    }
    if (elements.buttons.rotateRight) {
        elements.buttons.rotateRight.addEventListener('click', () => rotateCropper(90));
    }
    if (elements.buttons.reset) {
        elements.buttons.reset.addEventListener('click', resetCropper);
    }
    
    // ë„¤ë¹„ê²Œì´ì…˜
    if (elements.buttons.backToUpload) {
        elements.buttons.backToUpload.addEventListener('click', goToUploadStep);
    }
    if (elements.buttons.cropCurrent) {
        elements.buttons.cropCurrent.addEventListener('click', cropCurrentImage);
    }
    if (elements.buttons.prevImage) {
        elements.buttons.prevImage.addEventListener('click', goToPreviousImage);
    }
    if (elements.buttons.nextImage) {
        elements.buttons.nextImage.addEventListener('click', goToNextImage);
    }
    if (elements.buttons.backToCrop) {
        elements.buttons.backToCrop.addEventListener('click', goToCropStep);
    }
    if (elements.buttons.saveAllImages) {
        elements.buttons.saveAllImages.addEventListener('click', saveAllImages);
    }
    if (elements.buttons.addMoreImages) {
        elements.buttons.addMoreImages.addEventListener('click', addMoreImages);
    }
    
    // ì••ì¶• ì„¤ì •
    if (elements.qualitySlider) {
        elements.qualitySlider.addEventListener('input', updateQualityDisplay);
        elements.qualitySlider.addEventListener('change', updateCompression);
    }
    
    // ì´ë¯¸ì§€ í˜•ì‹ ì„ íƒ
    ['formatAVIF', 'formatWEBP', 'formatJPEG'].forEach(formatId => {
        const element = elements[formatId];
        if (element) {
            element.addEventListener('change', updateCompression);
        }
    });
    
    if (elements.autoOptimize) {
        elements.autoOptimize.addEventListener('change', updateCompression);
    }
}

// í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤ ì„¤ì •
function setupKeyboardShortcuts() {
    document.addEventListener('keydown', function(event) {
        // ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤ê°€ ìˆì„ ë•ŒëŠ” ë‹¨ì¶•í‚¤ ë¹„í™œì„±í™”
        if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') {
            return;
        }
        
        // í¬ë¡­í¼ê°€ í™œì„±í™”ë˜ì–´ ìˆì„ ë•Œë§Œ ë™ì‘
        if (!cropper || elements.cropSection.style.display === 'none') {
            return;
        }
        
        switch(event.key) {
            case '+':
            case '=': // Shift ì—†ì´ ëˆ„ë¥¼ ë•Œ
                event.preventDefault();
                zoomCropper(0.1);
                console.log('âŒ¨ï¸ í‚¤ë³´ë“œë¡œ í™•ëŒ€: +');
                break;
                
            case '-':
            case '_':
                event.preventDefault();
                zoomCropper(-0.1);
                console.log('âŒ¨ï¸ í‚¤ë³´ë“œë¡œ ì¶•ì†Œ: -');
                break;
                
            case 'r':
            case 'R':
                event.preventDefault();
                rotateCropper(90);
                console.log('âŒ¨ï¸ í‚¤ë³´ë“œë¡œ ìš°íšŒì „: R');
                break;
                
            case 'l':
            case 'L':
                event.preventDefault();
                rotateCropper(-90);
                console.log('âŒ¨ï¸ í‚¤ë³´ë“œë¡œ ì¢ŒíšŒì „: L');
                break;
                
            case 'Enter':
                event.preventDefault();
                if (elements.buttons.cropCurrent && !elements.buttons.cropCurrent.disabled) {
                    cropCurrentImage();
                    console.log('âŒ¨ï¸ í‚¤ë³´ë“œë¡œ í¬ë¡­ ì™„ë£Œ: Enter');
                }
                break;
                
            case 'Escape':
                event.preventDefault();
                resetCropper();
                console.log('âŒ¨ï¸ í‚¤ë³´ë“œë¡œ ë¦¬ì…‹: Esc');
                break;
                
            case 'ArrowLeft':
                event.preventDefault();
                if (elements.buttons.prevImage && elements.buttons.prevImage.style.display !== 'none') {
                    goToPreviousImage();
                    console.log('âŒ¨ï¸ í‚¤ë³´ë“œë¡œ ì´ì „ ì´ë¯¸ì§€: â†');
                }
                break;
                
            case 'ArrowRight':
                event.preventDefault();
                if (elements.buttons.nextImage && elements.buttons.nextImage.style.display !== 'none') {
                    goToNextImage();
                    console.log('âŒ¨ï¸ í‚¤ë³´ë“œë¡œ ë‹¤ìŒ ì´ë¯¸ì§€: â†’');
                }
                break;
        }
    });
    
    console.log('âŒ¨ï¸ í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤ ì„¤ì • ì™„ë£Œ');
    console.log('   +/- : í™•ëŒ€/ì¶•ì†Œ');
    console.log('   R/L : ìš°íšŒì „/ì¢ŒíšŒì „');
    console.log('   Enter : í¬ë¡­ ì™„ë£Œ');
    console.log('   Esc : ë¦¬ì…‹');
    console.log('   â†/â†’ : ì´ì „/ë‹¤ìŒ ì´ë¯¸ì§€');
}

// ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì„¤ì •
function setupDragAndDrop() {
    const uploadArea = elements.uploadArea;
    if (!uploadArea) return;
    
    uploadArea.addEventListener('dragover', handleDragOver);
    uploadArea.addEventListener('drop', handleDrop);
    
    // ì—…ë¡œë“œ ì˜ì—­ í´ë¦­ ì‹œ íŒŒì¼ ì„ íƒ
    uploadArea.addEventListener('click', (event) => {
        if (!event.target.closest('#fileSelectBtn')) {
            elements.imageInput.click();
        }
    });
}

// ë‹¤ì¤‘ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì²˜ë¦¬
function handleMultipleImageUpload(event) {
    console.log('ğŸ“ ë‹¤ì¤‘ íŒŒì¼ ì—…ë¡œë“œ ì´ë²¤íŠ¸ ë°œìƒ');
    const files = Array.from(event.target.files);
    
    if (files.length === 0) {
        console.log('ì„ íƒëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤');
        return;
    }
    
    console.log(`ğŸ“¸ ì„ íƒëœ íŒŒì¼ ìˆ˜: ${files.length}`);
    
    // ìµœëŒ€ 5ì¥ ì œí•œ
    if (files.length > 5) {
        alert('ìµœëŒ€ 5ì¥ê¹Œì§€ë§Œ ë“±ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        return;
    }
    
    // ê¸°ì¡´ ì´ë¯¸ì§€ ì´ˆê¸°í™”
    originalImages = [];
    croppedImages = [];
    currentImageIndex = 0;
    
    // ëª¨ë“  íŒŒì¼ ì²˜ë¦¬
    let processedCount = 0;
    files.forEach((file, index) => {
        handleSingleImageFile(file, index, () => {
            processedCount++;
            if (processedCount === files.length) {
                console.log('âœ… ëª¨ë“  ì´ë¯¸ì§€ ë¡œë“œ ì™„ë£Œ');
                showImageList();
                goToCropStep();
                loadCurrentImageToCropper();
            }
        });
    });
}

// ë‹¨ì¼ ì´ë¯¸ì§€ íŒŒì¼ ì²˜ë¦¬
function handleSingleImageFile(file, index, callback) {
    console.log(`ğŸ–¼ï¸ ì´ë¯¸ì§€ ì²˜ë¦¬ ì‹œì‘: ${file.name} (${index + 1})`);
    
    // íŒŒì¼ íƒ€ì… ê²€ì¦
    if (!file.type.startsWith('image/')) {
        alert(`${file.name}ì€(ëŠ”) ì´ë¯¸ì§€ íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤.`);
        return;
    }
    
    // ì§€ì›ë˜ëŠ” í˜•ì‹ ê²€ì¦
    const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
    if (!allowedTypes.includes(file.type)) {
        alert(`${file.name}ì€(ëŠ”) ì§€ì›ë˜ì§€ ì•ŠëŠ” í˜•ì‹ì…ë‹ˆë‹¤. (JPG, PNG, WebPë§Œ ì§€ì›)`);
        return;
    }
    
    // í° íŒŒì¼ ì•ˆë‚´
    if (file.size > 5 * 1024 * 1024) {
        console.log(`âš ï¸ í° íŒŒì¼ ê°ì§€: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)}MB)`);
        showLargeFileNotice(file.size, file.name);
    }
    
    // FileReaderë¡œ ì´ë¯¸ì§€ ë¡œë“œ
    const reader = new FileReader();
    reader.onload = function(e) {
        const imageData = {
            id: index,
            name: file.name,
            size: file.size,
            type: file.type,
            dataUrl: e.target.result,
            originalFile: file
        };
        
        originalImages.push(imageData);
        console.log(`âœ… ì´ë¯¸ì§€ ë¡œë“œ ì™„ë£Œ: ${file.name}`);
        
        if (callback) callback();
    };
    
    reader.onerror = function() {
        console.error(`âŒ íŒŒì¼ ì½ê¸° ì‹¤íŒ¨: ${file.name}`);
        alert(`${file.name} íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
    };
    
    reader.readAsDataURL(file);
}

// ì´ë¯¸ì§€ ë¦¬ìŠ¤íŠ¸ í‘œì‹œ
function showImageList() {
    if (!elements.imageListSection || !elements.imageList) return;
    
    elements.imageCount.textContent = originalImages.length;
    elements.imageList.innerHTML = '';
    
    originalImages.forEach((image, index) => {
        const imageItem = document.createElement('div');
        imageItem.className = 'col-md-4 col-lg-3';
        imageItem.innerHTML = `
            <div class="card image-item" data-index="${index}">
                <div class="card-img-top position-relative">
                    <img src="${image.dataUrl}" class="img-fluid" style="height: 120px; object-fit: cover;">
                    <div class="position-absolute top-0 end-0 p-1">
                        <span class="badge bg-primary">${index + 1}</span>
                    </div>
                </div>
                <div class="card-body p-2">
                    <h6 class="card-title text-truncate small mb-1">${image.name}</h6>
                    <small class="text-muted">${formatFileSize(image.size)}</small>
                </div>
            </div>
        `;
        
        elements.imageList.appendChild(imageItem);
    });
    
    elements.imageListSection.style.display = 'block';
}

// í˜„ì¬ ì´ë¯¸ì§€ë¥¼ í¬ë¡­í¼ì— ë¡œë“œ
function loadCurrentImageToCropper() {
    if (originalImages.length === 0) return;
    
    const currentImage = originalImages[currentImageIndex];
    if (!currentImage) return;
    
    console.log(`ğŸ–¼ï¸ í¬ë¡­í¼ì— ì´ë¯¸ì§€ ë¡œë“œ: ${currentImage.name} (${currentImageIndex + 1}/${originalImages.length})`);
    
    // í˜„ì¬ ì´ë¯¸ì§€ ë²ˆí˜¸ ì—…ë°ì´íŠ¸
    elements.currentImageNumber.textContent = `${currentImageIndex + 1}/${originalImages.length}`;
    elements.imageDimensions.textContent = 'ê³„ì‚° ì¤‘...';
    elements.imageFileName.textContent = currentImage.name;
    
    // ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€
    elements.buttons.prevImage.style.display = currentImageIndex > 0 ? 'inline-block' : 'none';
    elements.buttons.nextImage.style.display = currentImageIndex < originalImages.length - 1 ? 'inline-block' : 'none';
    
    // í¬ë¡­í¼ ì´ˆê¸°í™”
    if (cropper) {
        cropper.destroy();
        cropper = null;
    }
    
    elements.cropImage.src = currentImage.dataUrl;
    elements.cropImage.style.display = 'block';
    
    elements.cropImage.onload = function() {
        console.log('ì´ë¯¸ì§€ ë¡œë“œ ì™„ë£Œ, í¬ë¡­í¼ ì´ˆê¸°í™” ì‹œì‘');
        setTimeout(() => {
            initializeCropper();
            updateImageDimensions();
        }, 100);
    };
}

// í¬ë¡­í¼ ì´ˆê¸°í™” (16:9 ë¹„ìœ¨)
function initializeCropper() {
    if (!elements.cropImage) return;
    
    console.log('ğŸ”§ í¬ë¡­í¼ ì´ˆê¸°í™” - 16:9 ë¹„ìœ¨');
    
    cropper = new Cropper(elements.cropImage, {
        aspectRatio: 16 / 9, // ì‹œì„¤ ì‚¬ì§„ì€ 16:9 ë¹„ìœ¨
        viewMode: 1, // í¬ë¡­ ë°•ìŠ¤ë¥¼ ìº”ë²„ìŠ¤ ë‚´ë¶€ë¡œ ì œí•œ
        dragMode: 'move', // ë“œë˜ê·¸ ëª¨ë“œ (ì´ë¯¸ì§€ ì´ë™ ìš°ì„ )
        autoCropArea: 0.8, // ìë™ í¬ë¡­ ì˜ì—­ í¬ê¸° (80%)
        responsive: true, // ë°˜ì‘í˜• í¬ê¸° ì¡°ì •
        restore: false, // í¬ê¸° ì¡°ì • ì‹œ í¬ë¡­ ë°•ìŠ¤ ë³µì› ì•ˆí•¨
        guides: true, // ê°€ì´ë“œ ë¼ì¸ í‘œì‹œ (ê²©ì)
        center: true, // ì¤‘ì•™ í‘œì‹œì í‘œì‹œ
        highlight: false, // í¬ë¡­ ë°•ìŠ¤ ì™¸ë¶€ í•˜ì´ë¼ì´íŠ¸ ì œê±°
        cropBoxMovable: true, // í¬ë¡­ ë°•ìŠ¤ ì´ë™ ê°€ëŠ¥
        cropBoxResizable: true, // í¬ë¡­ ë°•ìŠ¤ í¬ê¸° ì¡°ì • ê°€ëŠ¥ (ëŒ€ê°ì„  ì¡°ì ˆ)
        toggleDragModeOnDblclick: true, // ë”ë¸”í´ë¦­ìœ¼ë¡œ ë“œë˜ê·¸ ëª¨ë“œ ë³€ê²½
        rotatable: true, // íšŒì „ ê°€ëŠ¥
        scalable: true, // í™•ëŒ€/ì¶•ì†Œ ê°€ëŠ¥
        zoomable: true, // ì¤Œ ê°€ëŠ¥
        minCropBoxWidth: 200, // ìµœì†Œ í¬ë¡­ ë°•ìŠ¤ ë„ˆë¹„
        minCropBoxHeight: 112, // ìµœì†Œ í¬ë¡­ ë°•ìŠ¤ ë†’ì´ (16:9 ë¹„ìœ¨ ìœ ì§€)
        ready() {
            console.log('âœ… í¬ë¡­í¼ ì¤€ë¹„ ì™„ë£Œ');
            updatePreview();
            setupSmartScroll(); // ìŠ¤ë§ˆíŠ¸ ìŠ¤í¬ë¡¤ ì„¤ì •
        },
        crop: updatePreview
    });
}

// ìŠ¤ë§ˆíŠ¸ ìŠ¤í¬ë¡¤ ì„¤ì • (ê°œì„ ëœ ë²„ì „)
function setupSmartScroll() {
    if (!cropper) {
        console.log('âŒ í¬ë¡­í¼ê°€ ì—†ì–´ì„œ ìŠ¤ë§ˆíŠ¸ ìŠ¤í¬ë¡¤ ì„¤ì • ë¶ˆê°€');
        return;
    }
    
    const cropperContainer = document.querySelector('.cropper-container');
    if (!cropperContainer) {
        console.log('âŒ í¬ë¡­í¼ ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
        return;
    }
    
    console.log('ğŸ–±ï¸ ìŠ¤ë§ˆíŠ¸ ìŠ¤í¬ë¡¤ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì‹œì‘');
    
    // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±° (ì¤‘ë³µ ë°©ì§€)
    cropperContainer.removeEventListener('wheel', handleSmartScroll);
    
    // ìƒˆ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
    cropperContainer.addEventListener('wheel', handleSmartScroll, { passive: false });
    
    console.log('âœ… ìŠ¤ë§ˆíŠ¸ ìŠ¤í¬ë¡¤ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì™„ë£Œ');
}

// ìŠ¤ë§ˆíŠ¸ ìŠ¤í¬ë¡¤ í•¸ë“¤ëŸ¬ (ë³„ë„ í•¨ìˆ˜ë¡œ ë¶„ë¦¬)
function handleSmartScroll(event) {
    if (!cropper) return;
    
    try {
        const imageData = cropper.getImageData();
        const canvasData = cropper.getCanvasData();
        
        // í˜„ì¬ ì¤Œ ë ˆë²¨ ê³„ì‚° (ë” ì •í™•í•œ ë°©ë²•)
        const currentZoom = canvasData.width / canvasData.naturalWidth;
        
        const isZoomingIn = event.deltaY < 0;
        const isZoomingOut = event.deltaY > 0;
        
        console.log('ğŸ” ìŠ¤ë§ˆíŠ¸ ìŠ¤í¬ë¡¤ - í˜„ì¬ ì¤Œ:', currentZoom.toFixed(3), 'ë°©í–¥:', isZoomingIn ? 'í™•ëŒ€' : 'ì¶•ì†Œ');
        
        // ë” ì •ë°€í•œ ì„ê³„ê°’ ì„¤ì •
        const MAX_ZOOM_THRESHOLD = 2.9;  // ìµœëŒ€ ì¤Œ ì„ê³„ê°’
        const MIN_ZOOM_THRESHOLD = 0.15; // ìµœì†Œ ì¤Œ ì„ê³„ê°’
        
        // ìµœëŒ€ í™•ëŒ€ ìƒíƒœì—ì„œ ë” í™•ëŒ€ ì‹œë„ ì‹œ â†’ í˜ì´ì§€ ìŠ¤í¬ë¡¤
        if (isZoomingIn && currentZoom >= MAX_ZOOM_THRESHOLD) {
            console.log('ğŸ“ˆ ìµœëŒ€ í™•ëŒ€ ë„ë‹¬ â†’ í˜ì´ì§€ ìŠ¤í¬ë¡¤ ì „í™˜');
            updateZoomIndicator(currentZoom, 'ìµœëŒ€ í™•ëŒ€ - í˜ì´ì§€ ìŠ¤í¬ë¡¤');
            
            // í˜ì´ì§€ ìŠ¤í¬ë¡¤ ì‹¤í–‰
            window.scrollBy({
                top: event.deltaY * 0.8,
                behavior: 'auto'
            });
            return; // preventDefault í•˜ì§€ ì•Šê³  ì¢…ë£Œ
        }
        
        // ìµœì†Œ ì¶•ì†Œ ìƒíƒœì—ì„œ ë” ì¶•ì†Œ ì‹œë„ ì‹œ â†’ í˜ì´ì§€ ìŠ¤í¬ë¡¤
        if (isZoomingOut && currentZoom <= MIN_ZOOM_THRESHOLD) {
            console.log('ğŸ“‰ ìµœì†Œ ì¶•ì†Œ ë„ë‹¬ â†’ í˜ì´ì§€ ìŠ¤í¬ë¡¤ ì „í™˜');
            updateZoomIndicator(currentZoom, 'ìµœì†Œ ì¶•ì†Œ - í˜ì´ì§€ ìŠ¤í¬ë¡¤');
            
            // í˜ì´ì§€ ìŠ¤í¬ë¡¤ ì‹¤í–‰
            window.scrollBy({
                top: event.deltaY * 0.8,
                behavior: 'auto'
            });
            return; // preventDefault í•˜ì§€ ì•Šê³  ì¢…ë£Œ
        }
        
        // ì¤Œ ë²”ìœ„ ë‚´ì—ì„œëŠ” ì´ë¯¸ì§€ ì¤Œ ì²˜ë¦¬
        event.preventDefault();
        event.stopPropagation();
        
        const zoomDelta = isZoomingIn ? 0.1 : -0.1;
        cropper.zoom(zoomDelta);
        
        // ìƒˆë¡œìš´ ì¤Œ ë ˆë²¨ ê³„ì‚°
        const newImageData = cropper.getImageData();
        const newCanvasData = cropper.getCanvasData();
        const newZoom = newCanvasData.width / newCanvasData.naturalWidth;
        
        updateZoomIndicator(newZoom, isZoomingIn ? 'í™•ëŒ€' : 'ì¶•ì†Œ');
        
    } catch (error) {
        console.error('âŒ ìŠ¤ë§ˆíŠ¸ ìŠ¤í¬ë¡¤ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:', error);
        // ì˜¤ë¥˜ ë°œìƒ ì‹œ ê¸°ë³¸ ìŠ¤í¬ë¡¤ í—ˆìš©
        window.scrollBy({
            top: event.deltaY * 0.5,
            behavior: 'auto'
        });
    }
}

// ì¤Œ í‘œì‹œê¸° ì—…ë°ì´íŠ¸ (ê°œì„ ëœ ë²„ì „)
function updateZoomIndicator(zoomLevel, action) {
    if (!elements.zoomIndicator || !elements.zoomLevel) return;
    
    const zoomPercent = Math.round(zoomLevel * 100);
    elements.zoomLevel.textContent = zoomPercent + '%';
    
    // ì•¡ì…˜ì— ë”°ë¥¸ ì•„ì´ì½˜ ë³€ê²½
    const zoomIcon = elements.zoomIndicator.querySelector('i');
    if (zoomIcon) {
        if (action === 'í™•ëŒ€') {
            zoomIcon.className = 'fas fa-search-plus me-2';
        } else if (action === 'ì¶•ì†Œ') {
            zoomIcon.className = 'fas fa-search-minus me-2';
        } else {
            zoomIcon.className = 'fas fa-search me-2';
        }
    }
    
    elements.zoomIndicator.style.display = 'block';
    
    // 3ì´ˆ í›„ ìë™ ìˆ¨ê¹€
    clearTimeout(window.zoomIndicatorTimeout);
    window.zoomIndicatorTimeout = setTimeout(() => {
        if (elements.zoomIndicator) {
            elements.zoomIndicator.style.display = 'none';
        }
    }, 3000);
}

// ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
function updatePreview() {
    if (!cropper || !elements.previewCanvas) return;
    
    console.log('ğŸ–¼ï¸ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸ ì‹œì‘');
    
    // í¬ë¡­ëœ ì´ë¯¸ì§€ë¥¼ ìº”ë²„ìŠ¤ì— ê·¸ë¦¬ê¸° (16:9 ë¹„ìœ¨)
    const canvas = cropper.getCroppedCanvas({
        width: 192,
        height: 108,
        imageSmoothingEnabled: true,
        imageSmoothingQuality: 'high'
    });
    
    if (canvas) {
        const ctx = elements.previewCanvas.getContext('2d');
        ctx.clearRect(0, 0, elements.previewCanvas.width, elements.previewCanvas.height);
        ctx.drawImage(canvas, 0, 0, elements.previewCanvas.width, elements.previewCanvas.height);
        console.log('âœ… ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸ ì™„ë£Œ');
    }
}

// ì´ë¯¸ì§€ í¬ê¸° ì •ë³´ ì—…ë°ì´íŠ¸
function updateImageDimensions() {
    if (!cropper) return;
    
    const imageData = cropper.getImageData();
    elements.imageDimensions.textContent = `${Math.round(imageData.naturalWidth)} Ã— ${Math.round(imageData.naturalHeight)}`;
}

// í¬ë¡­í¼ ì¤Œ
function zoomCropper(ratio) {
    if (!cropper) return;
    
    cropper.zoom(ratio);
    showZoomIndicator();
}

// í¬ë¡­í¼ íšŒì „
function rotateCropper(degree) {
    if (!cropper) return;
    
    cropper.rotate(degree);
    updatePreview();
}

// í¬ë¡­í¼ ë¦¬ì…‹
function resetCropper() {
    if (!cropper) return;
    
    cropper.reset();
    updatePreview();
}

// ì¤Œ í‘œì‹œê¸° (ê¸°ì¡´ í•¨ìˆ˜ì™€ í†µí•©)
function showZoomIndicator() {
    if (!elements.zoomIndicator || !cropper) return;
    
    const imageData = cropper.getImageData();
    const zoomRatio = imageData.width / imageData.naturalWidth;
    
    updateZoomIndicator(zoomRatio, 'ì¤Œ');
}

// í˜„ì¬ ì´ë¯¸ì§€ í¬ë¡­ ì™„ë£Œ
function cropCurrentImage() {
    if (!cropper) {
        alert('ì´ë¯¸ì§€ë¥¼ ë¨¼ì € ë¡œë“œí•´ì£¼ì„¸ìš”.');
        return;
    }
    
    console.log(`âœ‚ï¸ ì´ë¯¸ì§€ í¬ë¡­ ì‹œì‘: ${currentImageIndex + 1}/${originalImages.length}`);
    
    setButtonLoading(elements.buttons.cropCurrent, true, 'ì²˜ë¦¬ ì¤‘...');
    
    try {
        // ìµœì¢… í¬ë¡­ëœ ì´ë¯¸ì§€ ìƒì„± (16:9 ë¹„ìœ¨, ê³ í’ˆì§ˆ)
        const canvas = cropper.getCroppedCanvas({
            width: 800,   // ì‹œì„¤ ì´ë¯¸ì§€ ê°€ë¡œ í¬ê¸°
            height: 450,  // ì‹œì„¤ ì´ë¯¸ì§€ ì„¸ë¡œ í¬ê¸° (16:9 ë¹„ìœ¨)
            imageSmoothingEnabled: true,
            imageSmoothingQuality: 'high'
        });
        
        if (canvas) {
            // í¬ë¡­ëœ ì´ë¯¸ì§€ ì €ì¥
            const croppedData = {
                index: currentImageIndex,
                originalImage: originalImages[currentImageIndex],
                canvas: canvas,
                dataUrl: canvas.toDataURL('image/jpeg', 0.9)
            };
            
            croppedImages[currentImageIndex] = croppedData;
            console.log(`âœ… ì´ë¯¸ì§€ í¬ë¡­ ì™„ë£Œ: ${currentImageIndex + 1}`);
            
            // ë‹¤ìŒ ì´ë¯¸ì§€ë¡œ ì´ë™ ë˜ëŠ” ì••ì¶• ë‹¨ê³„ë¡œ
            if (currentImageIndex < originalImages.length - 1) {
                goToNextImage();
            } else {
                // ëª¨ë“  ì´ë¯¸ì§€ í¬ë¡­ ì™„ë£Œ
                console.log('ğŸ‰ ëª¨ë“  ì´ë¯¸ì§€ í¬ë¡­ ì™„ë£Œ, ì••ì¶• ë‹¨ê³„ë¡œ ì´ë™');
                goToCompressionStep();
            }
        } else {
            throw new Error('ìº”ë²„ìŠ¤ ìƒì„± ì‹¤íŒ¨');
        }
        
    } catch (error) {
        console.error('í¬ë¡­ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
        alert('ì´ë¯¸ì§€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    } finally {
        setButtonLoading(elements.buttons.cropCurrent, false);
    }
}

// ì´ì „ ì´ë¯¸ì§€ë¡œ ì´ë™
function goToPreviousImage() {
    if (currentImageIndex > 0) {
        currentImageIndex--;
        loadCurrentImageToCropper();
    }
}

// ë‹¤ìŒ ì´ë¯¸ì§€ë¡œ ì´ë™
function goToNextImage() {
    if (currentImageIndex < originalImages.length - 1) {
        currentImageIndex++;
        loadCurrentImageToCropper();
    }
}

// 3ë‹¨ê³„: ì••ì¶• ë° SEO ë‹¨ê³„ë¡œ ì´ë™
function goToCompressionStep() {
    hideAllSections();
    if (elements.compressionSection) elements.compressionSection.style.display = 'block';
    updateStepIndicator(3);
    
    // ì²« ë²ˆì§¸ í¬ë¡­ëœ ì´ë¯¸ì§€ë¡œ ì••ì¶• ë¯¸ë¦¬ë³´ê¸° ì‹œì‘
    currentImageIndex = 0;
    updateCompressionPreview();
    generateAltText();
}

// ì••ì¶• ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
function updateCompressionPreview() {
    if (croppedImages.length === 0) return;
    
    const currentCroppedImage = croppedImages[currentImageIndex];
    if (!currentCroppedImage) return;
    
    updateCompression();
}

// ì••ì¶• í’ˆì§ˆ í‘œì‹œ ì—…ë°ì´íŠ¸
function updateQualityDisplay() {
    const quality = Math.round(elements.qualitySlider.value * 100);
    elements.qualityPercent.textContent = quality + '%';
}

// ì´ë¯¸ì§€ ì••ì¶• ì—…ë°ì´íŠ¸
function updateCompression() {
    if (croppedImages.length === 0) return;
    
    const currentCroppedImage = croppedImages[currentImageIndex];
    if (!currentCroppedImage || !currentCroppedImage.canvas) return;
    
    const quality = parseFloat(elements.qualitySlider.value || 0.8);
    const selectedFormat = getSelectedImageFormat();
    
    console.log('ğŸ”„ ì´ë¯¸ì§€ ì••ì¶• ì—…ë°ì´íŠ¸ - í˜•ì‹:', selectedFormat.toUpperCase(), 'í’ˆì§ˆ:', Math.round(quality * 100) + '%');
    
    try {
        let compressedImageData;
        let actualFormat = selectedFormat;
        
        // ë¸Œë¼ìš°ì € ì§€ì› ì—¬ë¶€ í™•ì¸ ë° ì••ì¶•
        if (selectedFormat === 'avif') {
            if (isFormatSupported('image/avif')) {
                compressedImageData = currentCroppedImage.canvas.toDataURL('image/avif', quality);
                console.log('âœ… AVIF í˜•ì‹ìœ¼ë¡œ ì••ì¶• ì„±ê³µ');
            } else {
                console.log('âš ï¸ AVIF ë¯¸ì§€ì› - WebP ì‹œë„');
                if (isFormatSupported('image/webp')) {
                    compressedImageData = currentCroppedImage.canvas.toDataURL('image/webp', quality);
                    actualFormat = 'webp';
                    showFormatFallbackMessage('AVIF', 'WebP');
                } else {
                    compressedImageData = currentCroppedImage.canvas.toDataURL('image/jpeg', quality);
                    actualFormat = 'jpeg';
                    showFormatFallbackMessage('AVIF', 'JPEG');
                }
            }
        } else if (selectedFormat === 'webp') {
            if (isFormatSupported('image/webp')) {
                compressedImageData = currentCroppedImage.canvas.toDataURL('image/webp', quality);
                console.log('âœ… WebP í˜•ì‹ìœ¼ë¡œ ì••ì¶• ì„±ê³µ');
            } else {
                compressedImageData = currentCroppedImage.canvas.toDataURL('image/jpeg', quality);
                actualFormat = 'jpeg';
                showFormatFallbackMessage('WebP', 'JPEG');
            }
        } else {
            // JPEGëŠ” ëª¨ë“  ë¸Œë¼ìš°ì €ì—ì„œ ì§€ì›
            compressedImageData = currentCroppedImage.canvas.toDataURL('image/jpeg', quality);
            console.log('âœ… JPEG í˜•ì‹ìœ¼ë¡œ ì••ì¶• ì„±ê³µ');
        }
        
        // í˜„ì¬ í˜•ì‹ í‘œì‹œ ì—…ë°ì´íŠ¸
        if (elements.currentFormat) {
            elements.currentFormat.textContent = actualFormat.toUpperCase();
        }
        
        // ìµœì¢… ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
        if (elements.finalPreviewImage) {
            elements.finalPreviewImage.src = compressedImageData;
        }
        
        // ì••ì¶• ì •ë³´ ì—…ë°ì´íŠ¸
        updateCompressionInfo(compressedImageData, actualFormat);
        
        // ì••ì¶•ëœ ë°ì´í„° ì €ì¥
        currentCroppedImage.compressedData = compressedImageData;
        currentCroppedImage.finalFormat = actualFormat;
        
    } catch (error) {
        console.error('ì••ì¶• ì²˜ë¦¬ ì˜¤ë¥˜:', error);
        // ì˜¤ë¥˜ ì‹œ JPEGë¡œ í´ë°±
        const fallbackData = currentCroppedImage.canvas.toDataURL('image/jpeg', 0.8);
        elements.finalPreviewImage.src = fallbackData;
        updateCompressionInfo(fallbackData, 'jpeg');
        currentCroppedImage.compressedData = fallbackData;
        currentCroppedImage.finalFormat = 'jpeg';
    }
}

// ì„ íƒëœ ì´ë¯¸ì§€ í˜•ì‹ ê°€ì ¸ì˜¤ê¸°
function getSelectedImageFormat() {
    if (elements.formatAVIF && elements.formatAVIF.checked) return 'avif';
    if (elements.formatWEBP && elements.formatWEBP.checked) return 'webp';
    if (elements.formatJPEG && elements.formatJPEG.checked) return 'jpeg';
    return 'avif'; // ê¸°ë³¸ê°’
}

// ë¸Œë¼ìš°ì € í˜•ì‹ ì§€ì› ì—¬ë¶€ í™•ì¸
function isFormatSupported(mimeType) {
    const canvas = document.createElement('canvas');
    canvas.width = 2;
    canvas.height = 2;
    const ctx = canvas.getContext('2d');
    
    ctx.fillStyle = 'rgb(255, 0, 0)';
    ctx.fillRect(0, 0, 1, 1);
    ctx.fillStyle = 'rgb(0, 255, 0)';
    ctx.fillRect(1, 0, 1, 1);
    ctx.fillStyle = 'rgb(0, 0, 255)';
    ctx.fillRect(0, 1, 1, 1);
    ctx.fillStyle = 'rgb(255, 255, 255)';
    ctx.fillRect(1, 1, 1, 1);
    
    try {
        const dataURL = canvas.toDataURL(mimeType, 0.9);
        const isSupported = dataURL.startsWith(`data:${mimeType}`);
        console.log(`ğŸ” í˜•ì‹ ì§€ì› í™•ì¸: ${mimeType} - ${isSupported ? 'ì§€ì›ë¨' : 'ë¯¸ì§€ì›'}`);
        return isSupported;
    } catch (e) {
        console.warn(`âš ï¸ í˜•ì‹ ì§€ì› í™•ì¸ ì˜¤ë¥˜: ${mimeType}`, e);
        return false;
    }
}

// ì••ì¶• ì •ë³´ ì—…ë°ì´íŠ¸
function updateCompressionInfo(compressedImageData, format) {
    const originalSize = estimateDataUrlSize(croppedImages[currentImageIndex].dataUrl);
    const compressedSize = estimateDataUrlSize(compressedImageData);
    const savings = Math.round(((originalSize - compressedSize) / originalSize) * 100);
    
    let formatBenefit = '';
    if (format === 'avif') {
        formatBenefit = ' (ìµœê³  ì••ì¶•ë¥ )';
    } else if (format === 'webp') {
        formatBenefit = ' (íš¨ìœ¨ì  ì••ì¶•)';
    } else if (format === 'jpeg') {
        formatBenefit = ' (ë²”ìš© í˜¸í™˜)';
    }
    
    elements.compressionSavings.innerHTML = 
        `<div>${savings}% ì ˆì•½ (${formatFileSize(originalSize)} â†’ ${formatFileSize(compressedSize)})</div>
         <small class="text-muted">${format.toUpperCase()} í˜•ì‹${formatBenefit}</small>`;
}

// DataURL í¬ê¸° ì¶”ì •
function estimateDataUrlSize(dataUrl) {
    return Math.round((dataUrl.length * 3) / 4);
}

// Alt í…ìŠ¤íŠ¸ ìë™ ìƒì„±
function generateAltText() {
    if (!elements.altTextInput) return;
    
    let altText = `ì‹œì„¤ ì´ë¯¸ì§€ ${currentImageIndex + 1}`;
    
    if (originalImages[currentImageIndex]) {
        const fileName = originalImages[currentImageIndex].name.replace(/\.[^/.]+$/, '');
        if (fileName.length > 0 && fileName !== 'image') {
            altText += ` - ${fileName}`;
        }
    }
    
    elements.altTextInput.value = altText;
    console.log('ğŸ·ï¸ Alt í…ìŠ¤íŠ¸ ìë™ ìƒì„±:', altText);
}

// ëª¨ë“  ì´ë¯¸ì§€ ì €ì¥
function saveAllImages() {
    console.log('ğŸ’¾ ëª¨ë“  ì´ë¯¸ì§€ ì €ì¥ ì‹œì‘');
    
    if (croppedImages.length === 0) {
        alert('ì €ì¥í•  ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    setButtonLoading(elements.buttons.saveAllImages, true, 'ì €ì¥ ì¤‘...');
    
    // ëª¨ë“  í¬ë¡­ëœ ì´ë¯¸ì§€ì— ëŒ€í•´ ì••ì¶• ì ìš©
    const quality = parseFloat(elements.qualitySlider.value || 0.8);
    const selectedFormat = getSelectedImageFormat();
    const altText = elements.altTextInput.value.trim() || 'ì‹œì„¤ ì´ë¯¸ì§€';
    
    const uploadPromises = croppedImages.map((croppedImage, index) => {
        return uploadSingleImage(croppedImage, index, selectedFormat, quality, altText);
    });
    
    Promise.all(uploadPromises)
        .then(results => {
            console.log('âœ… ëª¨ë“  ì´ë¯¸ì§€ ì—…ë¡œë“œ ì™„ë£Œ');
            goToCompleteStep();
            showFinalImages(results);
        })
        .catch(error => {
            console.error('âŒ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
            alert('ì´ë¯¸ì§€ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        })
        .finally(() => {
            setButtonLoading(elements.buttons.saveAllImages, false);
        });
}

// ë‹¨ì¼ ì´ë¯¸ì§€ ì—…ë¡œë“œ
function uploadSingleImage(croppedImage, index, format, quality, altText) {
    return new Promise((resolve, reject) => {
        try {
            // ì••ì¶•ëœ ì´ë¯¸ì§€ ë°ì´í„° ìƒì„±
            let compressedData;
            let actualFormat = format;
            
            if (format === 'avif' && isFormatSupported('image/avif')) {
                compressedData = croppedImage.canvas.toDataURL('image/avif', quality);
            } else if ((format === 'avif' || format === 'webp') && isFormatSupported('image/webp')) {
                compressedData = croppedImage.canvas.toDataURL('image/webp', quality);
                actualFormat = 'webp';
            } else {
                compressedData = croppedImage.canvas.toDataURL('image/jpeg', quality);
                actualFormat = 'jpeg';
            }
            
            // Blobìœ¼ë¡œ ë³€í™˜
            const blob = dataURLtoBlob(compressedData);
            
            // FormData ìƒì„±
            const formData = new FormData();
            formData.append('facilityImage', blob, `facility_${index + 1}.${actualFormat}`);
            formData.append('altText', `${altText} ${index + 1}`);
            formData.append('format', actualFormat);
            formData.append('imageIndex', index.toString());
            
            console.log(`ğŸ“¤ ì´ë¯¸ì§€ ${index + 1} ì—…ë¡œë“œ ì‹œì‘`);
            
            fetch(`/facility/crop-images/save/${facilityId}`, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    console.log(`âœ… ì´ë¯¸ì§€ ${index + 1} ì—…ë¡œë“œ ì„±ê³µ`);
                    resolve(data);
                } else {
                    throw new Error(data.message || 'ì—…ë¡œë“œ ì‹¤íŒ¨');
                }
            })
            .catch(reject);
            
        } catch (error) {
            reject(error);
        }
    });
}

// 4ë‹¨ê³„: ì™„ë£Œ ë‹¨ê³„ë¡œ ì´ë™
function goToCompleteStep() {
    hideAllSections();
    if (elements.completeSection) elements.completeSection.style.display = 'block';
    updateStepIndicator(4);
}

// ìµœì¢… ì´ë¯¸ì§€ë“¤ í‘œì‹œ
function showFinalImages(results) {
    if (!elements.finalImagesGrid) return;
    
    elements.finalImagesGrid.innerHTML = '';
    
    results.forEach((result, index) => {
        const croppedImage = croppedImages[index];
        if (croppedImage && croppedImage.compressedData) {
            const imageDiv = document.createElement('div');
            imageDiv.className = 'col-md-3 col-sm-4 col-6 mb-3';
            imageDiv.innerHTML = `
                <div class="card">
                    <img src="${croppedImage.compressedData}" class="card-img-top" 
                         style="height: 120px; object-fit: cover;">
                    <div class="card-body p-2">
                        <small class="text-success">
                            <i class="fas fa-check me-1"></i>ì €ì¥ ì™„ë£Œ
                        </small>
                    </div>
                </div>
            `;
            elements.finalImagesGrid.appendChild(imageDiv);
        }
    });
}

// ì´ë¯¸ì§€ ë” ì¶”ê°€
function addMoreImages() {
    // ì´ˆê¸°í™” í›„ ì—…ë¡œë“œ ë‹¨ê³„ë¡œ
    originalImages = [];
    croppedImages = [];
    currentImageIndex = 0;
    
    if (cropper) {
        cropper.destroy();
        cropper = null;
    }
    
    elements.imageInput.value = '';
    goToUploadStep();
}

// ë‹¨ê³„ ì´ë™ í•¨ìˆ˜ë“¤
function goToUploadStep() {
    hideAllSections();
    if (elements.uploadSection) elements.uploadSection.style.display = 'block';
    if (elements.imageListSection) elements.imageListSection.style.display = 'none';
    updateStepIndicator(1);
    
    // ì´ˆê¸°í™”
    if (elements.imageInput) elements.imageInput.value = '';
    if (cropper) {
        cropper.destroy();
        cropper = null;
    }
}

function goToCropStep() {
    hideAllSections();
    if (elements.cropSection) elements.cropSection.style.display = 'block';
    if (elements.imageListSection) elements.imageListSection.style.display = 'block';
    updateStepIndicator(2);
}

// ëª¨ë“  ì„¹ì…˜ ìˆ¨ê¸°ê¸°
function hideAllSections() {
    if (elements.uploadSection) elements.uploadSection.style.display = 'none';
    if (elements.cropSection) elements.cropSection.style.display = 'none';
    if (elements.compressionSection) elements.compressionSection.style.display = 'none';
    if (elements.completeSection) elements.completeSection.style.display = 'none';
}

// ë‹¨ê³„ í‘œì‹œê¸° ì—…ë°ì´íŠ¸
function updateStepIndicator(currentStep) {
    Object.values(elements.steps).forEach(step => {
        if (step) {
            step.classList.remove('active', 'completed');
        }
    });
    
    for (let i = 1; i <= currentStep; i++) {
        const step = elements.steps[`step${i}`];
        if (step) {
            if (i === currentStep) {
                step.classList.add('active');
            } else {
                step.classList.add('completed');
            }
        }
    }
}

// ë“œë˜ê·¸ ì˜¤ë²„ ì²˜ë¦¬
function handleDragOver(event) {
    event.preventDefault();
    event.currentTarget.style.borderColor = '#0d6efd';
    event.currentTarget.style.backgroundColor = '#f8f9ff';
}

// ë“œë¡­ ì²˜ë¦¬
function handleDrop(event) {
    event.preventDefault();
    const files = Array.from(event.dataTransfer.files);
    
    if (files.length > 0) {
        // inputì— íŒŒì¼ ì„¤ì •
        const dt = new DataTransfer();
        files.forEach(file => dt.items.add(file));
        elements.imageInput.files = dt.files;
        
        // ì—…ë¡œë“œ ì²˜ë¦¬
        handleMultipleImageUpload({ target: { files } });
    }
    
    // ìŠ¤íƒ€ì¼ ë¦¬ì…‹
    event.currentTarget.style.borderColor = '';
    event.currentTarget.style.backgroundColor = '';
}

// í° íŒŒì¼ ì•ˆë‚´ ë©”ì‹œì§€
function showLargeFileNotice(fileSize, fileName) {
    const sizeMB = (fileSize / 1024 / 1024).toFixed(2);
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-info alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
    alertDiv.style.cssText = 'z-index: 10000; min-width: 350px;';
    alertDiv.innerHTML = `
        <i class="fas fa-info-circle me-2"></i>
        í° íŒŒì¼(${fileName}, ${sizeMB}MB)ì„ ì—…ë¡œë“œí•˜ì…¨ìŠµë‹ˆë‹¤. ìë™ìœ¼ë¡œ ì••ì¶•í•˜ì—¬ ìµœì í™”í•©ë‹ˆë‹¤.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 8000);
}

// í˜•ì‹ í´ë°± ë©”ì‹œì§€
function showFormatFallbackMessage(original, fallback) {
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-warning alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
    alertDiv.style.cssText = 'z-index: 10000; min-width: 300px;';
    alertDiv.innerHTML = `
        <i class="fas fa-exclamation-triangle me-2"></i>
        ${original} í˜•ì‹ì´ ì§€ì›ë˜ì§€ ì•Šì•„ ${fallback}ë¡œ ë³€í™˜ë©ë‹ˆë‹¤.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

// Base64ë¥¼ Blobìœ¼ë¡œ ë³€í™˜
function dataURLtoBlob(dataurl) {
    const arr = dataurl.split(',');
    const mime = arr[0].match(/:(.*?);/)[1];
    const bstr = atob(arr[1]);
    let n = bstr.length;
    const u8arr = new Uint8Array(n);
    while (n--) {
        u8arr[n] = bstr.charCodeAt(n);
    }
    return new Blob([u8arr], { type: mime });
}

// íŒŒì¼ í¬ê¸° í¬ë§·íŒ…
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// ë²„íŠ¼ ë¡œë”© ìƒíƒœ ì„¤ì •
function setButtonLoading(button, isLoading, loadingText = 'ì²˜ë¦¬ ì¤‘...') {
    if (!button) return;
    
    if (isLoading) {
        button.disabled = true;
        button.classList.add('loading');
        button.setAttribute('data-original-text', button.innerHTML);
        button.innerHTML = `<i class="fas fa-spinner fa-spin me-1"></i>${loadingText}`;
    } else {
        button.disabled = false;
        button.classList.remove('loading');
        const originalText = button.getAttribute('data-original-text');
        if (originalText) {
            button.innerHTML = originalText;
        }
    }
}
</script>

<style>
/* ì‹œì„¤ ì´ë¯¸ì§€ í¬ë¡­í¼ ì „ìš© ìŠ¤íƒ€ì¼ */
.facility-preview .card {
    transition: transform 0.3s ease;
    border: none;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.facility-preview .card:hover {
    transform: translateY(-2px);
}

.image-item {
    cursor: pointer;
    transition: transform 0.2s ease;
}

.image-item:hover {
    transform: scale(1.02);
}

.image-item.active {
    border-color: #007bff;
    box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
}

.crop-navigation .btn {
    min-width: 80px;
}

.final-images-grid {
    max-height: 300px;
    overflow-y: auto;
}

.completion-icon {
    animation: bounceIn 0.8s ease;
}

@keyframes bounceIn {
    0% {
        opacity: 0;
        transform: scale(0.3);
    }
    50% {
        opacity: 1;
        transform: scale(1.05);
    }
    70% {
        transform: scale(0.9);
    }
    100% {
        opacity: 1;
        transform: scale(1);
    }
}
</style>

</body>
</html>