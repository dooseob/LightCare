<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head th:replace="~{layout/header :: header}">
    <title>시설 검색 - CareLink</title>
</head>
<body class="d-flex flex-column min-vh-100 pt-5">
<nav th:replace="~{layout/header :: navbar}"></nav>

<div th:replace="~{layout/header :: messages}"></div>

<main class="flex-grow-1">
    <div class="container-fluid mt-4">
        <div class="row mb-4">
            <div class="col-12">
                <h2><i class="fas fa-map-marker-alt text-info me-2"></i> 시설 검색</h2>
                <p class="text-muted">지도를 통해 주변 요양 시설을 찾아보세요.</p>
            </div>
        </div>

        <div class="row">
            <div class="col-md-4">
                <div class="card mb-3">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="fas fa-search me-2"></i> 시설 검색</h5>
                    </div>
                    <div class="card-body">
                        <form id="searchForm" method="get" th:action="@{/facility/search}">
                            <div class="mb-3">
                                <label for="facilityName" class="form-label">시설명</label>
                                <input type="text" class="form-control" id="facilityName" name="facilityName"
                                       th:value="${facilityName}" placeholder="시설명을 입력하세요">
                            </div>

                            <div class="mb-3">
                                <label for="region" class="form-label">지역</label>
                                <select class="form-select" id="region" name="region">
                                    <option value="">전체</option>
                                    <option value="서울" th:selected="${region == '서울'}">서울</option>
                                    <option value="부산" th:selected="${region == '부산'}">부산</option>
                                    <option value="대구" th:selected="${region == '대구'}">대구</option>
                                    <option value="인천" th:selected="${region == '인천'}">인천</option>
                                    <option value="광주" th:selected="${region == '광주'}">광주</option>
                                    <option value="대전" th:selected="${region == '대전'}">대전</option>
                                    <option value="울산" th:selected="${region == '울산'}">울산</option>
                                    <option value="경기" th:selected="${region == '경기'}">경기</option>
                                    <option value="강원" th:selected="${region == '강원'}">강원</option>
                                    <option value="충북" th:selected="${region == '충북'}">충북</option>
                                    <option value="충남" th:selected="${region == '충남'}">충남</option>
                                    <option value="전북" th:selected="${region == '전북'}">전북</option>
                                    <option value="전남" th:selected="${region == '전남'}">전남</option>
                                    <option value="경북" th:selected="${region == '경북'}">경북</option>
                                    <option value="경남" th:selected="${region == '경남'}">경남</option>
                                    <option value="제주" th:selected="${region == '제주'}">제주</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label for="facilityType" class="form-label">시설 유형</label>
                                <select class="form-select" id="facilityType" name="facilityType">
                                    <option value="">전체</option>
                                    <option value="nursing_home" th:selected="${facilityType == 'nursing_home'}">요양원</option>
                                    <option value="day_care" th:selected="${facilityType == 'day_care'}">주간보호센터</option>
                                    <option value="home_care" th:selected="${facilityType == 'home_care'}">재가센터</option>
                                    <option value="hospital" th:selected="${facilityType == 'hospital'}">요양병원</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label for="gradeRating" class="form-label">최소 등급</label>
                                <select class="form-select" id="gradeRating" name="gradeRating">
                                    <option value="">전체</option>
                                    <option value="5" th:selected="${gradeRating == '5'}">5등급 이상</option>
                                    <option value="4" th:selected="${gradeRating == '4'}">4등급 이상</option>
                                    <option value="3" th:selected="${gradeRating == '3'}">3등급 이상</option>
                                    <option value="2" th:selected="${gradeRating == '2'}">2등급 이상</option>
                                    <option value="1" th:selected="${gradeRating == '1'}">1등급만</option>
                                </select>
                            </div>

                            <button type="submit" class="btn btn-info w-100">
                                <i class="fas fa-search me-1"></i> 검색
                            </button>
                        </form>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header bg-light">
                        <h6 class="mb-0"><i class="fas fa-list me-1"></i> 검색 결과
                            <span id="resultCount" class="badge bg-primary"
                                  th:text="'(' + ${facilityList != null ? #lists.size(facilityList) : 0} + '개)'">(0개)</span>
                        </h6>
                    </div>
                    <div class="card-body p-0">
                        <div id="facilityList" class="list-group list-group-flush">
                            <div th:if="${not #lists.isEmpty(facilityList)}">
                                <a th:each="facility : ${facilityList}"
                                   th:href="@{/facility/detail/{id}(id=${facility.facilityId})}"
                                   class="list-group-item list-group-item-action facility-item"
                                   th:data-lat="${facility.latitude}"
                                   th:data-lng="${facility.longitude}"
                                   th:data-name="${facility.name}"
                                   th:data-address="${facility.address}"
                                   th:data-phone="${facility.phone}"
                                   th:data-rating="${facility.averageRating}">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h6 class="mb-1" th:text="${facility.name}">시설명</h6>
                                        <small class="text-muted">
                                            <span class="badge bg-success" th:text="${facility.gradeRating + '등급'}">1등급</span>
                                        </small>
                                    </div>
                                    <p class="mb-1" th:text="${facility.address}">주소</p>
                                    <small class="text-muted">
                                        전화: <span th:text="${facility.phone}">전화번호</span> |
                                        평점: <span th:text="${facility.averageRating}">4.5</span>/5.0
                                    </small>
                                </a>
                            </div>

                            <div th:if="${#lists.isEmpty(facilityList)}" class="list-group-item text-center text-muted py-4">
                                <i class="fas fa-search fa-2x mb-2"></i><br>
                                검색 조건을 입력하고 검색 버튼을 클릭해주세요.
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-8">
                <div class="card h-100">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="fas fa-map me-2"></i> 지도</h5>
                    </div>
                    <div class="card-body p-0">
                        <div id="map" style="width:100%; height:600px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<footer th:replace="~{layout/footer :: footer}"></footer>

<div th:replace="~{layout/footer :: scripts}"></div>

<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=71726bd73abc79c69d665d26c0300058&libraries=services&autoload=false"></script>
<script th:src="@{/js/kakaomap.js}"></script>

<script>
    // 이 변수는 kakaomap.js에서 할당될 전역 map 객체를 참조할 것입니다.
    // 명시적으로 let map; 선언은 kakaomap.js에서 이미 되므로 여기서는 제거합니다.

    // 페이지 로드 시 실행 (DOMContentLoaded는 HTML 문서 로드 완료 시점)
    document.addEventListener('DOMContentLoaded', function() {
        // Kakao Maps API가 완전히 로드된 후에 실행될 콜백 함수
        kakao.maps.load(function() {
            // 지도 초기화 (kakaomap.js의 함수 호출)
            // kakaomap.js의 initKakaoMap 함수는 전역 변수 'map'에 지도 객체를 할당할 것입니다.
            initKakaoMap('map');

            // Thymeleaf에서 JSON 문자열 형태로 받아온 초기 시설 목록을 파싱
            // 이 데이터는 서버에서 렌더링될 때 `facilityListJson` 모델 속성으로 주입됩니다.
            const initialFacilitiesJson = /*[[ ${facilityListJson} ]]*/ '[]'; // Thymeleaf 인라인 주석
            let initialFacilities = [];
            try {
                initialFacilities = JSON.parse(initialFacilitiesJson);
                console.log("초기 로드된 시설 목록:", initialFacilities);
            } catch (e) {
                console.error("초기 시설 목록 JSON 파싱 오류:", e);
            }

            // 지도 초기화 및 초기 시설 마커 표시
            if (map) { // map 객체가 유효하게 초기화되었는지 확인
                clearMarkers(); // kakaomap.js에 정의된 함수 호출

                if (initialFacilities.length > 0) {
                    const bounds = new kakao.maps.LatLngBounds(); // 모든 마커를 포함할 경계 생성
                    initialFacilities.forEach(facility => {
                        // FacilityDTO 필드명과 HTML data-속성명이 일치하는지 확인 (대소문자 주의)
                        // 예: facility.latitude, facility.longitude, facility.name, facility.address, facility.phone, facility.averageRating
                        addMarker(
                            parseFloat(facility.latitude),
                            parseFloat(facility.longitude),
                            facility.name,
                            `주소: ${facility.address}<br>전화: ${facility.phone}<br>평점: ${facility.averageRating}/5.0`
                        );
                        bounds.extend(new kakao.maps.LatLng(parseFloat(facility.latitude), parseFloat(facility.longitude)));
                    });
                    // 모든 마커를 포함하는 지도로 이동
                    map.setBounds(bounds);
                } else {
                    // 검색 결과가 없는 경우, 기본 중심 좌표로 지도 이동
                    map.setCenter(new kakao.maps.LatLng(37.566826, 126.9786567)); // 서울 시청 중심
                    map.setLevel(3); // 적절한 초기 줌 레벨
                }
            } else {
                console.error("Kakao Map object is not available after initialization.");
            }

            // 폼 제출 이벤트 리스너: 이제 기본 폼 제출 동작을 허용합니다.
            // searchWithFilters 함수는 제거되었으므로 더 이상 필요 없습니다.
            // 이 방식은 폼 제출 시 페이지가 새로고침되며 서버에서 다시 렌더링됩니다.
            // AJAX로 폼 제출을 원한다면 이 부분을 다시 구현해야 합니다.
            // document.getElementById('searchForm').addEventListener('submit', function(e) {
            //     // e.preventDefault(); // 이제 제거하거나 주석 처리하여 기본 폼 제출을 허용
            //     // 이전에 searchWithFilters를 호출하던 로직은 제거합니다.
            // });

            // 시설 목록 항목 클릭 이벤트
            document.querySelectorAll('.facility-item').forEach(item => {
                item.addEventListener('click', function(e) {

                    // data-* 속성에서 값 가져오기
                    const lat = parseFloat(this.dataset.lat);
                    const lng = parseFloat(this.dataset.lng);
                    const name = this.dataset.name;
                    const address = this.dataset.address;
                    const phone = this.dataset.phone;
                    const rating = this.dataset.rating;

                    if (map) { // map 객체가 존재할 때만 실행
                        // 지도 중심 이동 및 확대/축소 레벨 설정
                        map.setCenter(new kakao.maps.LatLng(lat, lng));
                        map.setLevel(3); // 원하는 확대 레벨로 설정

                        clearMarkers(); // 모든 마커 제거
                        // 클릭된 시설에 대한 마커만 다시 추가
                        addMarker(lat, lng, name,
                            `주소: ${address}<br>전화: ${phone}<br>평점: ${rating}/5.0`);
                    } else {
                        console.error("Kakao Map object is not initialized when clicking facility item.");
                    }
                });
            });

            // 초기 검색 실행:
            // 이제 search.html은 서버에서 이미 검색된 initialFacilities를 사용하므로
            // 페이지 로드 시 searchFacilitiesInBounds()를 호출할 필요가 없습니다.
            // 대신, 지도를 이동했을 때 자동으로 해당 영역 내 시설을 검색하고 싶다면
            // kakaomap.js의 `map.addListener('idle', ...)` 부분의 주석을 해제하면 됩니다.
            // searchFacilitiesInBounds(); // 현재는 필요 없음.
        }); // kakao.maps.load 끝
    }); // DOMContentLoaded 끝
</script>
</body>
</html>